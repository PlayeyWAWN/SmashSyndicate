<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Smash Syndicate - Badminton Engagement Network Tournament Manager PWA">
  
  <!-- PWA Configuration -->
  <meta name="theme-color" content="#2196F3">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Smash Syndicate">
  
  <title>Smash Syndicate - Badminton Engagement Network</title>
  
  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="#" id="manifest-link">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --bg-primary: linear-gradient(135deg, #0175C2 0%, #0056A3 100%);
      --bg-secondary: white;
      --text-primary: white;
      --text-secondary: rgba(255,255,255,0.8);
      --card-bg: white;
      --border-color: #ddd;
      --shadow-color: rgba(0,0,0,0.1);
    }
    
    [data-theme="dark"] {
      --bg-primary: #000000;
      --bg-secondary: #0a0a0a;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --card-bg: rgba(255, 255, 255, 0.08);
      --border-color: rgba(255, 255, 255, 0.15);
      --shadow-color: rgba(0, 0, 0, 0.5);
    }
    
    [data-theme="dark"] body {
      background: 
        linear-gradient(135deg, #000000 0%, #0a0a0a 20%, #1a1a1a 40%, #0a0a0a 60%, #000000 80%, #0a0a0a 100%),
        radial-gradient(circle at 20% 80%, rgba(20, 20, 20, 0.6) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(30, 30, 30, 0.4) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(15, 15, 15, 0.3) 0%, transparent 50%);
      background-attachment: fixed;
    }
    
    [data-theme="dark"] body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        repeating-linear-gradient(
          45deg,
          transparent,
          transparent 3px,
          rgba(255, 255, 255, 0.008) 3px,
          rgba(255, 255, 255, 0.008) 6px
        ),
        repeating-linear-gradient(
          -45deg,
          transparent,
          transparent 4px,
          rgba(255, 255, 255, 0.005) 4px,
          rgba(255, 255, 255, 0.005) 8px
        ),
        repeating-linear-gradient(
          90deg,
          transparent,
          transparent 2px,
          rgba(255, 255, 255, 0.003) 2px,
          rgba(255, 255, 255, 0.003) 4px
        );
      pointer-events: none;
      z-index: -1;
    }
    
    [data-theme="dark"] body::after {
      color: rgba(255, 255, 255, 0.05);
    }
    
    [data-theme="dark"] .nav-item {
      color: #ffffff;
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.15);
      box-shadow: 
        0 8px 32px 0 rgba(0, 0, 0, 0.7),
        0 4px 16px 0 rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    [data-theme="dark"] .nav-item:hover {
      background: rgba(255, 255, 255, 0.12);
      box-shadow: 
        0 12px 40px 0 rgba(0, 0, 0, 0.8),
        0 6px 20px 0 rgba(0, 0, 0, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }
    
    [data-theme="dark"] .nav-item.active {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.25);
      box-shadow: 
        0 8px 32px 0 rgba(0, 0, 0, 0.9),
        0 4px 16px 0 rgba(0, 0, 0, 0.7),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    [data-theme="dark"] .bottom-actions {
      background: var(--card-bg);
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #43e97b 100%);
      min-height: 100vh;
      color: var(--text-primary);
      overflow-x: hidden;
      transition: background 0.3s ease, color 0.3s ease;
      position: relative;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }
    
    body::after {
      content: 'BADMINTON SHUTTLECOCK COURT MATCH PLAYER TEAM WIN LOSE GAME SET POINT SERVE RALLY SMASH DROP CLEAR DRIVE NET PLAY TOURNAMENT CHAMPION FINAL SEMI QUARTER ROUND BRACKET SEED RANKING SKILL BEGINNER INTERMEDIATE ADVANCED ELITE APEX JOURNEYMAN VETERAN CADET INITIATE';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      font-size: 14px;
      font-weight: 300;
      color: rgba(255, 255, 255, 0.1);
      line-height: 1.5;
      word-spacing: 50px;
      letter-spacing: 2px;
      transform: rotate(-5deg);
      pointer-events: none;
      z-index: -1;
      overflow: hidden;
      white-space: nowrap;
    }
    
    .app-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .app-bar {
      background: var(--bg-primary);
      padding: 16px;
      box-shadow: 0 2px 8px var(--shadow-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .app-title {
      font-size: 20px;
      font-weight: bold;
      color: white;
    }
    
    .install-btn {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .install-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .content {
      flex: 1;
      padding: 0;
    }
    
    .tab-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 120px);
    }
    
    .tab-content {
      flex: 1;
      display: none;
      padding: 20px;
      overflow-y: auto;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .top-nav {
      background: var(--card-bg);
      display: flex;
      box-shadow: 0 2px 8px var(--shadow-color);
      height: 70px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      padding: 8px 4px;
      gap: 4px;
    }
    
    .bottom-actions {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(16px) saturate(180%);
      border-top: 1px solid rgba(255, 255, 255, 0.18);
      display: flex;
      box-shadow: 
        0 -8px 32px 0 rgba(31, 38, 135, 0.37),
        0 -4px 16px 0 rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      height: 70px;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      padding: 12px 20px;
      gap: 12px;
      justify-content: center;
      align-items: center;
    }
    
    .content {
      padding-top: 90px; /* Add space for fixed top nav */
      padding-bottom: 80px; /* Add space for fixed bottom actions */
    }
    
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #1a1a1a;
      font-size: 12px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      background: linear-gradient(135deg, rgba(79, 172, 254, 0.25), rgba(0, 242, 254, 0.25), rgba(67, 233, 123, 0.25));
      backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid rgba(79, 172, 254, 0.3);
      border-radius: 16px;
      margin: 0 3px;
      padding: 10px 6px;
      position: relative;
      overflow: hidden;
      box-shadow: 
        0 8px 32px 0 rgba(79, 172, 254, 0.3),
        0 4px 16px 0 rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    .nav-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
      );
      transition: left 0.5s;
      z-index: 1;
    }
    
    .nav-item:hover::before {
      left: 100%;
    }
    
    .nav-item:hover {
      background: linear-gradient(135deg, rgba(79, 172, 254, 0.35), rgba(0, 242, 254, 0.35), rgba(67, 233, 123, 0.35));
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        0 12px 40px 0 rgba(79, 172, 254, 0.4),
        0 6px 20px 0 rgba(0, 0, 0, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
    }
    
    .nav-item.active {
      background: linear-gradient(135deg, rgba(79, 172, 254, 0.4), rgba(0, 242, 254, 0.4), rgba(67, 233, 123, 0.4));
      color: #1a1a1a;
      border-color: rgba(79, 172, 254, 0.5);
      box-shadow: 
        0 8px 32px 0 rgba(79, 172, 254, 0.5),
        0 4px 16px 0 rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }
    
    .nav-item.active:hover {
      background: linear-gradient(135deg, rgba(79, 172, 254, 0.5), rgba(0, 242, 254, 0.5), rgba(67, 233, 123, 0.5));
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        0 12px 40px 0 rgba(79, 172, 254, 0.6),
        0 6px 20px 0 rgba(0, 0, 0, 0.18),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }
    
    .nav-icon {
      font-size: 20px;
      margin-bottom: 4px;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 
        0 8px 32px 0 rgba(31, 38, 135, 0.37),
        0 4px 16px 0 rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      color: #1a1a1a;
      font-weight: 500;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
      );
      transition: left 0.5s;
      z-index: 1;
    }
    
    .card:hover::before {
      left: 100%;
    }
    
    .card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 
        0 20px 40px 0 rgba(31, 38, 135, 0.4),
        0 8px 24px 0 rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.25);
    }
    
    .btn {
      background: #0175C2;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: background 0.2s;
    }
    
    .btn:hover {
      background: #0056A3;
    }
    
    .skill-option:hover {
      background: #f5f5f5;
      border-color: #2196F3 !important;
    }
    
    .gender-btn.selected {
      background: #2196F3 !important;
      color: white !important;
    }
    
    .edit-gender-btn.selected {
      background: #2196F3 !important;
      color: white !important;
    }
    
    .skill-btn.selected {
      opacity: 0.8;
      transform: scale(0.95);
    }
    
    .edit-skill-btn.selected {
      opacity: 0.8;
      transform: scale(0.95);
    }
    
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }
    
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    
    .btn-small {
      padding: 8px 16px;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 12px;
      color: #1a1a1a;
      font-weight: 500;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 4px 16px 0 rgba(31, 38, 135, 0.1),
        0 2px 8px 0 rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    .btn-small::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
      );
      transition: left 0.5s;
      z-index: 1;
    }
    
    .btn-small:hover::before {
      left: 100%;
    }
    
    .btn-small:hover {
      background: rgba(255, 255, 255, 0.35);
      transform: translateY(-2px) scale(1.02);
      box-shadow: 
        0 8px 24px 0 rgba(31, 38, 135, 0.2),
        0 4px 12px 0 rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
    }
    
    .btn-success {
      background: #4CAF50;
    }
    
    .btn-success:hover {
      background: #45a049;
    }
    
    .btn-warning {
      background: #FF9800;
    }
    
    .btn-warning:hover {
      background: #f57c00;
    }
    
    .input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 16px;
    }
    
    .input:focus {
      outline: none;
      border-color: #0175C2;
    }
    
    .select {
      width: 100%;
      padding: 14px;
      border: 2px solid rgba(255, 255, 255, 0.18);
      border-radius: 12px;
      font-size: 16px;
      margin-bottom: 16px;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      color: #1a1a1a;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 
        0 4px 16px 0 rgba(31, 38, 135, 0.1),
        0 2px 8px 0 rgba(0, 0, 0, 0.05);
    }
    
    .select:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.4);
      box-shadow: 
        0 8px 24px 0 rgba(31, 38, 135, 0.2),
        0 4px 12px 0 rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }
    
    .select:focus {
      outline: none;
      border-color: #0175C2;
    }
    
    .list-item {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .list-item:last-child {
      border-bottom: none;
    }
    
    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 24px;
      background: #0175C2;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-weight: bold;
      font-size: 18px;
    }
    
    .avatar.female {
      background: #E91E63;
    }
    
    .avatar.other {
      background: #9C27B0;
    }
    
    .list-content {
      flex: 1;
    }
    
    .list-title {
      font-weight: 700;
      margin-bottom: 6px;
      font-size: 18px;
      color: #1a1a1a;
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    }
    
    .list-subtitle {
      color: #2a2a2a;
      font-size: 14px;
      margin-bottom: 4px;
      font-weight: 500;
      text-shadow: 0 1px 1px rgba(255, 255, 255, 0.6);
    }
    
    .skill-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .skill-initiate, .skill-cadet {
      background: #E8F5E8;
      color: #2E7D32;
    }
    
    .skill-journeyman, .skill-veteran {
      background: #FFF3E0;
      color: #F57C00;
    }
    
    .skill-elite, .skill-apex {
      background: #F3E5F5;
      color: #7B1FA2;
    }
    
    .stats {
      font-size: 13px;
      color: #3a3a3a;
      font-weight: 500;
      text-shadow: 0 1px 1px rgba(255, 255, 255, 0.5);
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
    
    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .section-title {
      font-size: 24px;
      font-weight: bold;
      color: white;
    }
    
    .dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .dialog-overlay.show {
      display: flex;
    }
    
    .dialog {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 24px;
      padding: 32px;
      width: 90%;
      max-width: 400px;
      color: #1a1a1a;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 
        0 8px 32px 0 rgba(31, 38, 135, 0.37),
        0 4px 16px 0 rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    .dialog::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      pointer-events: none;
      z-index: -1;
    }
    
    .dialog-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #0175C2;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }
    
    .dialog-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .dialog-actions .btn {
      flex: 1;
    }
    
    .player-actions {
      display: flex;
      gap: 8px;
    }
    
    .excluded {
      opacity: 0.6;
    }
    
    .excluded .list-title {
      text-decoration: line-through;
    }
    
    .mode-card {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 20px;
      padding: 24px;
      margin: 10px 0;
      cursor: pointer;
      box-shadow: 
        0 8px 32px 0 rgba(31, 38, 135, 0.37),
        0 4px 16px 0 rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      color: #1a1a1a;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .mode-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
      );
      transition: left 0.5s;
      z-index: 1;
    }
    
    .mode-card:hover::before {
      left: 100%;
    }
    
    .mode-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 
        0 20px 40px 0 rgba(31, 38, 135, 0.4),
        0 8px 24px 0 rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.25);
    }
    
    .action-icon-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 12px 16px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 80px;
    }
    
    .action-icon-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
    }
    
    .mode-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(1, 117, 194, 0.1);
      color: #0175C2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 12px;
    }
    
    .pwa-status {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    /* Court visualization */
    .court-container {
      position: relative;
      width: 100%;
      aspect-ratio: 1.67;
      margin: 16px 0;
      border-radius: 8px;
      overflow: hidden;
      background: #228B22;
      border: 2px solid #ddd;
    }
    
    .badminton-court-svg {
      width: 100%;
      height: 100%;
    }
    
    .active-match-card {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 20px;
      margin: 0 auto 20px auto;
      width: 100%;
      max-width: 100%;
      box-shadow: 
        0 8px 32px 0 rgba(31, 38, 135, 0.37),
        0 4px 16px 0 rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    
    .active-match-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
      );
      transition: left 0.5s;
      z-index: 1;
    }
    
    .active-match-card:hover::before {
      left: 100%;
    }
    
    .active-match-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 
        0 20px 40px 0 rgba(31, 38, 135, 0.4),
        0 8px 24px 0 rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.25);
    }
    
    .court-container {
      width: 100%;
      max-width: 100%;
      height: auto;
      aspect-ratio: 2 / 1.2;
      position: relative;
      background: #4CAF50;
      border-radius: 12px;
      margin: 16px auto;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    @media (min-width: 768px) {
      .court-container {
        max-width: 600px;
        aspect-ratio: 2 / 1.4;
      }
      
      .player-position {
        position: absolute;
      }
      
      .player-position[style*="top: 40px"] {
        top: 70px !important;
      }
      
      .player-position[style*="bottom: 40px"] {
        bottom: 70px !important;
      }
      
      .player-position[style*="left: 40px"] {
        left: 70px !important;
      }
      
      .player-position[style*="right: 40px"] {
        right: 70px !important;
      }
    }
    
    .court-svg {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
    
    .player-position {
      position: absolute;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
    }
    
    .player-position:hover {
      transform: scale(1.05);
    }
    
    .player-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 8px;
      padding: 6px 8px;
      text-align: center;
      min-width: 70px;
      min-height: 50px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    @media (min-width: 768px) {
      .player-card {
        min-width: 100px;
        min-height: 70px;
        padding: 10px 12px;
      }
    }
    
    .player-card:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .player-name {
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin-bottom: 2px;
      word-break: break-word;
      line-height: 1.1;
      max-width: 100%;
    }
    
    .player-skill {
      font-size: 10px;
      color: #666;
      font-weight: 500;
      line-height: 1.1;
    }
    
    @media (min-width: 768px) {
      .player-name {
        font-size: 16px;
        margin-bottom: 4px;
      }
      
      .player-skill {
        font-size: 14px;
      }
    }
    
    .win-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      padding: 16px;
      margin-top: 8px;
    }
    
    .win-btn {
      padding: 12px 24px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 120px;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(16px) saturate(180%);
      color: #333;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .win-btn.team1 {
      border-color: rgba(76, 175, 80, 0.4);
      color: #2e7d32;
    }
    
    .win-btn.team2 {
      border-color: rgba(244, 67, 54, 0.4);
      color: #c62828;
    }
    
    .win-btn:hover {
      background: rgba(255, 255, 255, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }
    
    .win-btn.team1:hover {
      background: rgba(76, 175, 80, 0.2);
      border-color: rgba(76, 175, 80, 0.6);
    }
    
    .win-btn.team2:hover {
      background: rgba(244, 67, 54, 0.2);
      border-color: rgba(244, 67, 54, 0.6);
    }
    
    .match-header {
      background: rgba(1, 117, 194, 0.9);
      backdrop-filter: blur(12px) saturate(180%);
      -webkit-backdrop-filter: blur(12px) saturate(180%);
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .court-name {
      font-weight: bold;
      font-size: 16px;
    }
    
    .match-timer {
      font-family: monospace;
      font-size: 14px;
      font-weight: bold;
    }
    
    .match-queue-card {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 20px;
      margin-bottom: 16px;
      overflow: hidden;
      box-shadow: 
        0 8px 32px 0 rgba(31, 38, 135, 0.37),
        0 4px 16px 0 rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    
    .match-queue-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
      );
      transition: left 0.5s;
      z-index: 1;
    }
    
    .match-queue-card:hover::before {
      left: 100%;
    }
    
    .match-queue-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 
        0 20px 40px 0 rgba(31, 38, 135, 0.4),
        0 8px 24px 0 rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.25);
    }
    
    .queue-header {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(12px) saturate(180%);
      -webkit-backdrop-filter: blur(12px) saturate(180%);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .queue-number {
      background: #4CAF50;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    
    .queue-title {
      font-weight: bold;
      color: #333;
    }
    
    .team-vs-layout {
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .team-side {
      flex: 1;
      text-align: center;
    }
    
    .team-label {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 4px;
    }
    
    .team-avg {
      font-size: 12px;
      color: #666;
      margin-bottom: 12px;
    }
    
    .team-players {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .player-avatar {
      width: 110px;
      height: 95px;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 12px;
      position: relative;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 8px;
      box-sizing: border-box;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(12px) saturate(180%);
      -webkit-backdrop-filter: blur(12px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 
        0 4px 16px 0 rgba(31, 38, 135, 0.2),
        0 2px 8px 0 rgba(0, 0, 0, 0.1);
    }
    
    .player-avatar:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 
        0 8px 24px 0 rgba(31, 38, 135, 0.3),
        0 4px 12px 0 rgba(0, 0, 0, 0.15);
      border-color: rgba(255, 255, 255, 0.4);
    }
    
    .player-name {
      font-size: 13px;
      margin-top: 3px;
      font-weight: 600;
    }
    
    .player-stats {
      position: absolute;
      bottom: -16px;
      font-size: 8px;
      color: #666;
    }
    
    .vs-divider {
      font-size: 20px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .match-type-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .match-type-btn {
      padding: 10px 20px;
      border-radius: 25px;
      border: 2px solid #0175C2;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      color: #0175C2;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 4px 16px 0 rgba(31, 38, 135, 0.2),
        0 2px 8px 0 rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .match-type-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
      );
      transition: left 0.5s;
      z-index: 1;
    }
    
    .match-type-btn:hover::before {
      left: 100%;
    }
    
    .match-type-btn:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 
        0 8px 24px 0 rgba(31, 38, 135, 0.3),
        0 4px 12px 0 rgba(0, 0, 0, 0.15);
    }
    
    .match-type-btn.active {
      background: #0175C2;
      color: white;
    }
    
    .active-matches-section {
      margin-bottom: 24px;
    }
    
    .section-subtitle {
      font-size: 18px;
      font-weight: bold;
      color: white;
      margin-bottom: 12px;
    }
    
    .standby-players-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }
    
    .standby-player-card {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .standby-player-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
      );
      transition: left 0.5s;
      z-index: 1;
    }
    
    .standby-player-card:hover::before {
      left: 100%;
    }
    
    .standby-player-card:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 
        0 12px 32px 0 rgba(31, 38, 135, 0.4),
        0 6px 20px 0 rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.25);
    }
    
    .standby-player-avatar {
      width: 40px;
      height: 40px;
      border-radius: 20px;
      margin: 0 auto 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 16px;
    }
    
    .standby-player-name {
      font-weight: 600;
      color: #333;
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .standby-player-games {
      font-size: 12px;
      color: #666;
    }
    
    .queue-player-clickable {
      cursor: pointer;
      position: relative;
      border-radius: 8px;
      transition: all 0.2s;
    }
    
    .queue-player-clickable:hover {
      background: rgba(255,255,255,0.1);
      transform: scale(1.05);
    }
    
    .player-menu-overlay {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #0175C2;
      color: white;
      border-radius: 12px;
      padding: 4px 8px;
      font-size: 10px;
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }
    
    .queue-player-clickable:hover .player-menu-overlay {
      opacity: 1;
    }
    
    .players-on-court {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .team-left {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 140px;
    }
    
    .team-right {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 140px;
      text-align: right;
    }
    
    .player-on-court {
      background: rgba(255,255,255,0.9);
      color: #0175C2;
      padding: 6px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .synergy-team-card {
      background: linear-gradient(135deg, #E8F5E8 0%, #F1F8E9 100%);
      border: 2px solid #4CAF50;
      border-radius: 12px;
      padding: 16px;
      margin: 8px 0;
    }
    
    .synergy-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .synergy-badge {
      background: #4CAF50;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .completed-match {
      background: #FFF3E0;
      border-left: 4px solid #FF9800;
    }
    
    .winner-text {
      color: #4CAF50;
      font-weight: 600;
    }
    
    .time-ago {
      color: #666;
      font-size: 12px;
    }
    
    .priority-indicator {
      background: #E3F2FD;
      color: #1976D2;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
    }
    
    @media (max-width: 768px) {
      .app-bar {
        padding: 12px 16px;
      }
      
      .tab-content {
        padding: 16px;
      }
      
      .section-title {
        font-size: 20px;
      }
      
      .dialog {
        width: 95%;
        padding: 20px;
      }
      
      .team-left, .team-right {
        width: 120px;
      }
      
      .player-on-court {
        font-size: 11px;
        padding: 4px 6px;
      }
      
      /* Mobile queue layout fixes */
      .team-vs-layout {
        padding: 12px;
        gap: 12px;
        flex-direction: column;
      }
      
      .team-side {
        flex: none;
        width: 100%;
      }
      
      .team-players {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
        margin: 8px 0;
      }
      
      .player-avatar {
        width: 90px;
        height: 90px;
        font-size: 11px;
        padding: 6px;
      }
      
      .player-name {
        font-size: 11px;
        line-height: 1.2;
        margin: 3px 0;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
        text-align: center;
        max-width: 80px;
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.7);
      }
      
      .player-skill {
        font-size: 9px !important;
        margin-top: 2px;
      }
      
      /* Gender icon size for mobile */
      .player-avatar > div:first-child {
        font-size: 20px !important;
        margin-bottom: 2px !important;
      }
      
      .vs-divider {
        font-size: 20px;
        font-weight: bold;
        color: #4CAF50;
        margin: 12px 0;
        order: 0; /* Keep VS in middle position */
        background: rgba(76, 175, 80, 0.1);
        padding: 10px 20px;
        border-radius: 25px;
        border: 2px solid #4CAF50;
        align-self: center;
      }
      
      .queue-header {
        flex-direction: column;
        gap: 8px;
        text-align: center;
      }
      
      .queue-header > div:first-child {
        justify-content: center;
      }
      
      /* Make buttons smaller on mobile */
      .btn-small {
        padding: 6px 12px;
        font-size: 12px;
      }
      
      /* Team labels with better mobile styling */
      .team-label {
        font-size: 14px;
        margin-bottom: 6px;
        font-weight: 600;
      }
      
      .team-avg {
        font-size: 12px;
        margin-bottom: 8px;
        opacity: 0.8;
      }
      
      /* Active matches mobile responsive */
      .active-match-card {
        margin: 0 8px 20px 8px;
        max-width: calc(100% - 16px);
        width: calc(100% - 16px);
        padding: 6px;
        box-sizing: border-box;
        overflow: hidden;
      }
      
      .active-match-card svg {
        width: 100% !important;
        height: 200px !important;
        max-width: 100% !important;
      }
      
      .active-match-card > div:first-child {
        margin: 4px 4px 8px 4px !important;
      }
      
      /* Court header adjustments */
      .match-header {
        padding: 8px 12px;
        font-size: 14px;
      }
      
      .court-name {
        font-size: 16px;
      }
      
      .match-timer {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Top Navigation -->
    <div class="top-nav" id="top-nav" style="display: none;">
      <div class="nav-item active" data-tab="players">
        <div class="nav-icon">👥</div>
        <div>Players</div>
      </div>
      <div class="nav-item" data-tab="courts">
        <div class="nav-icon">🏸</div>
        <div>Courts</div>
      </div>
      <div class="nav-item" data-tab="queue">
        <div class="nav-icon">📋</div>
        <div>Queue</div>
      </div>
      <div class="nav-item" data-tab="statistics">
        <div class="nav-icon">📊</div>
        <div>Stats</div>
      </div>
      <div class="nav-item" data-tab="finance">
        <div class="nav-icon">💰</div>
        <div>Finance</div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="tab-container">
        <!-- Home Tab -->
        <div class="tab-content active" id="home-tab">
          <div style="text-align: center; padding: 20px;">
            <div id="app-logo" style="width: 130px; height: 130px; background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(16px) saturate(180%); -webkit-backdrop-filter: blur(16px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.18); border-radius: 24px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 65px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37), 0 4px 16px 0 rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.3); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px) scale(1.05)'; this.style.boxShadow='0 20px 40px 0 rgba(31, 38, 135, 0.4), 0 8px 24px 0 rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 8px 32px 0 rgba(31, 38, 135, 0.37), 0 4px 16px 0 rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.3)'">🏸</div>
            
            <h1 style="font-size: 28px; margin-bottom: 8px;">Smash Syndicate</h1>
            <p style="font-size: 16px; margin-bottom: 16px; opacity: 0.8;">
              <span style="color: #4CAF50; font-weight: 600;">B</span>adminton 
              <span style="color: #4CAF50; font-weight: 600;">E</span>ngagement 
              <span style="color: #4CAF50; font-weight: 600;">N</span>etwork
            </p>
            
            <!-- Offline Notice -->
            <div style="
              background: linear-gradient(135deg, #4CAF50, #45a049);
              color: white;
              padding: 16px;
              border-radius: 12px;
              margin-bottom: 32px;
              text-align: center;
              box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
              border: 2px solid #45a049;
            ">
              <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">
                🌐 Works Completely Offline!
              </div>
              <div style="font-size: 14px; opacity: 0.9;">
                <strong>No internet required!</strong> This app works offline after initial download. 
                All your data is stored locally on your device and never leaves your control.
              </div>
            </div>
            
            <div class="mode-card" id="normal-queue-btn" style="cursor: pointer;">
              <div class="mode-icon">👥</div>
              <h3 style="color: #0175C2; margin-bottom: 4px;">Normal Queue Mode</h3>
              <p style="color: #666; font-size: 14px;">Manage players, queues, and matches</p>
            </div>
            
            <div class="mode-card" id="tournament-btn" style="cursor: pointer;">
              <div class="mode-icon">🏆</div>
              <h3 style="color: #0175C2; margin-bottom: 4px;">Tournament Mode</h3>
              <p style="color: #666; font-size: 14px;">Organize tournaments and brackets</p>
            </div>
            
            <div class="pwa-status">
              <h3 style="margin-bottom: 12px;">📱 PWA Features Active</h3>
              <p style="font-size: 14px; opacity: 0.8; margin-bottom: 16px;">
                ✅ Installable • ✅ Offline Ready • ✅ Fast Loading
              </p>
              <button class="btn" onclick="showInstallInfo()">How to Install App</button>
            </div>
            
            <!-- Action Icons -->
            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 24px;">
              <button class="action-icon-btn" onclick="sendEmail()" title="Send Feedback">
                <div style="font-size: 24px;">📧</div>
                <div style="font-size: 12px; margin-top: 4px;">Feedback</div>
              </button>
            </div>
          </div>
        </div>

        <!-- Players Tab -->
        <div class="tab-content" id="players-tab">
          <div class="section-header">
            <div class="section-title">Players</div>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-secondary btn-small" onclick="showSynergyTeamDialog()">🤝 Synergy</button>
              <button class="btn" onclick="showAddPlayerDialog()">+ Add Player</button>
            </div>
          </div>
          
          <!-- Player Count Section -->
          <div class="card" style="margin-bottom: 20px;">
            <div style="padding: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="font-size: 16px; font-weight: 600; color: #0175C2;">Registered Players</div>
                <div style="background: rgba(1, 117, 194, 0.1); color: #0175C2; padding: 6px 12px; border-radius: 16px; font-size: 14px; font-weight: 600;" id="total-player-count">
                  0 Players
                </div>
              </div>
              
              <div style="display: flex; gap: 16px; flex-wrap: wrap;" id="player-stats-breakdown">
                <!-- Stats will be populated by JavaScript -->
              </div>
            </div>
          </div>
          
          <!-- Player Sorting Section -->
          <div class="card" style="margin-bottom: 20px;">
            <div style="padding: 16px;">
              <div style="font-size: 16px; font-weight: 600; color: #0175C2; margin-bottom: 12px;">Sort Players</div>
              <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                <label style="display: flex; align-items: center; gap: 8px; color: #333;">
                  <span style="font-weight: 500;">By:</span>
                  <select id="sort-criteria" onchange="sortPlayers()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; background: white;">
                    <option value="name">Name (A-Z)</option>
                    <option value="gender">Gender</option>
                    <option value="skillLevel">Skill Level</option>
                    <option value="gamesPlayed">Games Played</option>
                    <option value="wins">Wins</option>
                  </select>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; color: #333;">
                  <input type="checkbox" id="sort-descending" onchange="sortPlayers()" />
                  <span>Descending</span>
                </label>
                <div style="margin-left: auto; display: flex; gap: 8px;">
                  <button class="btn btn-secondary btn-small" onclick="filterByGender('all')" id="filter-all">All</button>
                  <button class="btn btn-secondary btn-small" onclick="filterByGender('male')" id="filter-male">👨 Male</button>
                  <button class="btn btn-secondary btn-small" onclick="filterByGender('female')" id="filter-female">👩 Female</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Synergy Teams Section -->
          <div id="synergy-teams-section" style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <h3 style="color: white; margin: 0;">Synergy Teams</h3>
              <label style="display: flex; align-items: center; gap: 8px; color: white;">
                <input type="checkbox" id="synergy-mode-toggle" onchange="toggleSynergyMode()" />
                <span>Active</span>
              </label>
            </div>
            <div id="synergy-teams-list"></div>
          </div>
          
          <div id="players-list">
            <div class="empty-state">
              <div class="empty-icon">👥</div>
              <h3>No players added yet</h3>
              <p>Tap "Add Player" to get started!</p>
            </div>
          </div>
        </div>

        <!-- Courts Tab -->
        <div class="tab-content" id="courts-tab">
          <div class="section-header">
            <div class="section-title">Courts</div>
            <button class="btn" onclick="addCourt()">+ Add Court</button>
          </div>
          
          <div id="courts-list"></div>
        </div>

        <!-- Queue Tab -->
        <div class="tab-content" id="queue-tab">
          <!-- Active Matches Section -->
          <div class="active-matches-section">
            <div class="section-subtitle">Active Matches</div>
            <div id="active-matches-list">
              <div class="empty-state" style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px;">
                <div class="empty-icon">🏸</div>
                <h3>No active matches</h3>
                <p>Start a queue to see live matches!</p>
              </div>
            </div>
          </div>
          
          <!-- Match Queues Section -->
          <div class="section-header">
            <div class="section-title">Match Queues</div>
            <button class="btn" onclick="addToQueue()">+ Add Queue</button>
          </div>
          
          <!-- Match Type Selector -->
          <div class="match-type-selector">
            <button class="match-type-btn" id="match-type-mix" onclick="setMatchType('mix')">Mix</button>
            <button class="match-type-btn active" id="match-type-balanced" onclick="setMatchType('balanced')">Balanced Skill</button>
          </div>
          
          <!-- Queue List -->
          <div id="queue-list">
            <div class="empty-state">
              <div class="empty-icon">📋</div>
              <h3>No matches in queue</h3>
              <p>Add players first, then create a queue!</p>
            </div>
          </div>
          
          <!-- Players on Standby Section -->
          <div id="standby-players-section" style="margin-top: 24px;">
            <div class="section-subtitle">Players on Standby</div>
            <div id="standby-players-list"></div>
          </div>

          <!-- Recently Completed Matches -->
          <div id="recent-matches-section" style="margin-top: 24px;">
            <div class="section-subtitle">Recently Completed</div>
            <div id="recent-matches-list"></div>
          </div>
        </div>

        <!-- Statistics Tab -->
        <div class="tab-content" id="statistics-tab">
          <div class="section-header">
            <div class="section-title">Statistics</div>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-small" onclick="exportStats()">📊 Export</button>
            </div>
          </div>
          
          <!-- Individual Player Statistics -->
          <div id="individual-statistics-section" style="margin-bottom: 24px;">
            <!-- Will be populated by JavaScript -->
          </div>
          
          <!-- Pair Statistics Section -->
          <div id="pair-statistics-section" style="margin-bottom: 24px;">
            <!-- Will be populated by JavaScript -->
          </div>
          
          <!-- Star Player Section -->
          <div id="star-player-section" style="margin-bottom: 24px;">
            <!-- Will be populated by JavaScript -->
          </div>
          
          <!-- Players Needing Encouragement Section -->
          <div id="encouragement-section" style="margin-bottom: 24px;">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>

        <!-- Finance Tab -->
        <div class="tab-content" id="finance-tab">
          <div class="section-header">
            <div class="section-title">Finance Management</div>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-small" onclick="exportFinance()">📊 Export</button>
            </div>
          </div>

          <!-- Finance Management Card -->
          <div class="card" style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.05), inset 0 1px 0 rgba(255, 255, 255, 0.2);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <div style="font-size: 24px;">💰</div>
              <div>
                <div style="font-weight: 600; color: #1976D2; font-size: 18px;">Session Cost Calculator</div>
                <div style="color: #666; font-size: 14px;">Enter session details to calculate total costs</div>
              </div>
            </div>

            <!-- Cost Input Section -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
              <!-- Court Fee Section -->
              <div style="background: #F5F5F5; border-radius: 12px; padding: 16px;">
                <div style="font-weight: 600; color: #333; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                  <span>🏸</span>
                  <span>Court Fee</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                  <div>
                    <label style="font-size: 12px; color: #666; margin-bottom: 4px; display: block;">Fee per Hour</label>
                    <input type="number" id="court-fee-per-hour" placeholder="₱0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                  </div>
                  <div>
                    <label style="font-size: 12px; color: #666; margin-bottom: 4px; display: block;">Hours Played</label>
                    <input type="number" id="hours-played" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                  </div>
                </div>
                <div>
                  <label style="font-size: 12px; color: #666; margin-bottom: 4px; display: block;">Number of Courts</label>
                  <input type="number" id="number-of-courts" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                </div>
              </div>

              <!-- Shuttlecock Section -->
              <div style="background: #F5F5F5; border-radius: 12px; padding: 16px;">
                <div style="font-weight: 600; color: #333; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                  <span>🏸</span>
                  <span>Shuttlecocks</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                  <div>
                    <label style="font-size: 12px; color: #666; margin-bottom: 4px; display: block;">Price per Piece</label>
                    <input type="number" step="0.01" id="shuttlecock-price" placeholder="₱0.00" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                  </div>
                  <div>
                    <label style="font-size: 12px; color: #666; margin-bottom: 4px; display: block;">Pieces Used</label>
                    <input type="number" id="shuttlecocks-used" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                  </div>
                </div>
              </div>
            </div>

            <!-- Cost Breakdown -->
            <div style="background: #E3F2FD; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
              <div style="font-weight: 600; color: #1976D2; margin-bottom: 12px;">Cost Breakdown</div>
              
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div>
                  <div style="font-weight: 500;">🏸 Court Fee:</div>
                  <div style="font-size: 12px; color: #666;" id="court-fee-breakdown">₱0 × 0 hrs × 0 courts</div>
                </div>
                <div style="font-weight: bold; color: #1976D2;" id="total-court-fee">₱0.00</div>
              </div>
              
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div>
                  <div style="font-weight: 500;">🏸 Shuttlecocks:</div>
                  <div style="font-size: 12px; color: #666;" id="shuttlecock-breakdown">₱0.00 × 0 pieces</div>
                </div>
                <div style="font-weight: bold; color: #1976D2;" id="total-shuttlecock-cost">₱0.00</div>
              </div>
              
              <div style="border-top: 2px solid #1976D2; padding-top: 8px; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-weight: 600; font-size: 16px;">Total Cost:</div>
                <div style="font-weight: bold; font-size: 18px; color: #1976D2;" id="total-cost">₱0.00</div>
              </div>
              
              <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; padding-top: 8px; border-top: 1px solid #ccc;">
                <div style="font-weight: 600;">Cost per Player:</div>
                <div style="font-weight: bold; color: #FF9800;" id="cost-per-player">₱0.00</div>
              </div>
            </div>
          </div>

          <!-- Player Payment Tracker Card -->
          <div class="card" style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.05), inset 0 1px 0 rgba(255, 255, 255, 0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div>
                <div style="font-weight: 600; color: #1976D2; font-size: 18px;">Payment Tracker</div>
                <div style="color: #666; font-size: 14px;">Track who has paid their share</div>
              </div>
              <div style="background: rgba(76, 175, 80, 0.1); padding: 8px 12px; border-radius: 16px;">
                <span style="color: #4CAF50; font-weight: 600;" id="payment-summary">0/0 paid</span>
              </div>
            </div>

            <!-- Player Payment List -->
            <div id="player-payment-list">
              <div style="text-align: center; padding: 20px; color: #666;">
                <div style="font-size: 24px; margin-bottom: 8px;">👥</div>
                <div>No players registered yet</div>
                <div style="font-size: 12px;">Add players to track payments</div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div style="display: flex; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #eee;">
              <button class="btn" onclick="markAllPaid()" style="flex: 1; background: #4CAF50;">✓ Mark All Paid</button>
              <button class="btn btn-secondary" onclick="clearAllPayments()" style="flex: 1;">✗ Clear All</button>
            </div>
          </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="settings-tab">
          <div class="section-header">
            <div class="section-title">Settings</div>
            <div style="color: rgba(255,255,255,0.7); font-size: 14px;">Manage your app data</div>
          </div>
          
          <!-- Data Management Section -->
          <div class="card" style="margin-bottom: 20px;">
            <div style="padding: 20px;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                <div style="font-size: 24px;">🗃️</div>
                <div>
                  <div style="font-size: 18px; font-weight: 600; color: #0175C2;">Data Management</div>
                  <div style="font-size: 14px; color: #666;">Reset or clear your app data</div>
                </div>
              </div>
              
              <!-- Clear Statistics Button -->
              <div style="margin-bottom: 16px;">
                <button class="btn" onclick="showClearStatsDialog()" style="width: 100%; background: #FF9800; border-color: #FF9800; display: flex; align-items: center; justify-content: center; gap: 8px;">
                  <span style="font-size: 18px;">🔄</span>
                  <span>Clear Player Statistics</span>
                </button>
                <div style="font-size: 12px; color: #666; margin-top: 4px; text-align: center;">
                  Reset games played, wins, and win rates to zero (keeps player names)
                </div>
              </div>
              
              <!-- Clear All Players Button -->
              <div style="margin-bottom: 16px;">
                <button class="btn btn-secondary" onclick="showClearAllDataDialog()" style="width: 100%; background: #F44336; border-color: #F44336; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                  <span style="font-size: 18px;">🗑️</span>
                  <span>Clear All Players</span>
                </button>
                <div style="font-size: 12px; color: #666; margin-top: 4px; text-align: center;">
                  Remove all players, statistics, and match history completely
                </div>
              </div>
              
              <!-- Export Statistics Button -->
              <div>
                <button class="btn" onclick="exportStats()" style="width: 100%; background: #4CAF50; border-color: #4CAF50; display: flex; align-items: center; justify-content: center; gap: 8px;">
                  <span style="font-size: 18px;">📊</span>
                  <span>Export Statistics</span>
                </button>
                <div style="font-size: 12px; color: #666; margin-top: 4px; text-align: center;">
                  Save player statistics to clipboard or share
                </div>
              </div>
            </div>
          </div>
          
          <!-- App Information Section -->
          <div class="card">
            <div style="padding: 20px;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                <div style="font-size: 24px;">ℹ️</div>
                <div>
                  <div style="font-size: 18px; font-weight: 600; color: #0175C2;">App Information</div>
                  <div style="font-size: 14px; color: #666;">About SmashSyndicate</div>
                </div>
              </div>
              
              <div style="background: rgba(0,0,0,0.05); border-radius: 8px; padding: 16px;">
                <div style="margin-bottom: 12px;">
                  <div style="font-weight: 600; color: #333; margin-bottom: 4px;">SmashSyndicate</div>
                  <div style="font-size: 14px; color: #666;">Badminton Tournament Manager</div>
                </div>
                
                <div style="margin-bottom: 12px;">
                  <div style="font-weight: 600; color: #333; margin-bottom: 4px;">Version</div>
                  <div style="font-size: 14px; color: #666;">PWA v1.0.0</div>
                </div>
                
                <div style="margin-bottom: 12px;">
                  <div style="font-weight: 600; color: #333; margin-bottom: 4px;">Features</div>
                  <div style="font-size: 14px; color: #666;">
                    • Player Management with Skill Levels<br>
                    • Match Queue System with Synergy Teams<br>
                    • Live Match Tracking with Timers<br>
                    • Statistics and Export Functionality<br>
                    • Replace & Swap Player Options<br>
                    • Progressive Web App Support
                  </div>
                </div>
                
                <div>
                  <div style="font-weight: 600; color: #333; margin-bottom: 4px;">Storage</div>
                  <div style="font-size: 14px; color: #666;" id="storage-info">
                    Data stored locally in your browser
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tournament Tab -->
        <div class="tab-content" id="tournament-tab">
          <div class="section-header">
            <div class="section-title">Tournament</div>
            <button class="btn" onclick="createTournament()">+ Create Tournament</button>
          </div>
          
          <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 80px; margin-bottom: 20px;">🏆</div>
            <h3 style="margin-bottom: 8px;">Tournament Features</h3>
            <p style="opacity: 0.8; margin-bottom: 24px;">Create tournaments, manage brackets, and track championship matches.</p>
            <button class="btn" onclick="createTournament()">Create Tournament</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Actions Bar -->
    <div class="bottom-actions" id="bottom-actions" style="display: none;">
              <button class="btn btn-small" id="settings-btn" data-tab="settings" style="display: none;">⚙️ Settings</button>
        <button class="btn btn-small" id="home-btn" data-tab="home" style="display: none;">🏠 Home</button>
    </div>
  </div>

  <!-- Add Player Dialog -->
  <!-- Enhanced Player Registration Dialog -->
  <div class="dialog-overlay" id="add-player-dialog">
    <div class="dialog" style="max-width: 500px;">
      <div class="dialog-title">Player Registration</div>
      
      <!-- Single vs Bulk Toggle -->
      <div style="margin-bottom: 20px; text-align: center;">
        <button class="btn btn-small" id="single-mode-btn" onclick="setPlayerAddMode('single')" style="background: #2196F3; color: white; margin-right: 8px;">Single Player</button>
        <button class="btn btn-small btn-secondary" id="bulk-mode-btn" onclick="setPlayerAddMode('bulk')">Bulk Add</button>
      </div>
      
      <!-- Player Name(s) Input -->
      <div class="form-group">
        <label class="label" id="name-label">Name</label>
        <input type="text" class="input" id="player-name" placeholder="Enter player name" style="display: block;" />
        <textarea class="input" id="player-names-bulk" placeholder="Enter player names (one per line)&#10;Example:&#10;John Smith&#10;Jane Doe&#10;Mike Johnson" style="display: none; height: 100px; resize: vertical;"></textarea>
      </div>
      
      <!-- Gender Selection -->
      <div class="form-group">
        <label class="label">Select Gender</label>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="btn btn-secondary gender-btn" data-gender="male" onclick="selectGender('male')" style="flex: 1; min-width: 120px;">
            👨 MALE
          </button>
          <button class="btn btn-secondary gender-btn" data-gender="female" onclick="selectGender('female')" style="flex: 1; min-width: 120px;">
            👩 FEMALE
          </button>
        </div>
      </div>
      
      <!-- Skill Level Selection -->
      <div class="form-group">
        <label class="label">Select Skill Level</label>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="btn btn-secondary skill-btn" data-skill="beginner" onclick="selectSkillCategory('beginner')" style="flex: 1; min-width: 100px; background: #4CAF50; color: white;">
            Beginner
          </button>
          <button class="btn btn-secondary skill-btn" data-skill="intermediate" onclick="selectSkillCategory('intermediate')" style="flex: 1; min-width: 100px; background: #FF9800; color: white;">
            Intermediate
          </button>
          <button class="btn btn-secondary skill-btn" data-skill="advanced" onclick="selectSkillCategory('advanced')" style="flex: 1; min-width: 100px; background: #F44336; color: white;">
            Advanced
          </button>
        </div>
        <div id="selected-skill-display" style="margin-top: 8px; font-size: 14px; color: #666;">
          Please select a skill level
        </div>
      </div>
      
      <div class="dialog-actions">
        <button class="btn btn-secondary" onclick="hideAddPlayerDialog()">Cancel</button>
        <button class="btn" id="add-player-btn" onclick="addPlayerFromDialogNew()" disabled>Add Player</button>
      </div>
    </div>
  </div>

  <!-- Beginner Skill Level Dialog -->
  <div class="dialog-overlay" id="beginner-skill-dialog">
    <div class="dialog" style="max-width: 400px;">
      <div class="dialog-title" style="color: #4CAF50;">Select Beginner Level</div>
      <div style="margin-bottom: 20px;">
        <div class="skill-option" onclick="selectSpecificSkill('initiate')" style="padding: 16px; border: 2px solid #E8F5E9; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;">
          <div style="font-weight: 600; color: #4CAF50; margin-bottom: 4px;">Initiate</div>
          <div style="font-size: 14px; color: #666;">Just starting out, learning basic rules and game flow</div>
        </div>
        <div class="skill-option" onclick="selectSpecificSkill('cadet')" style="padding: 16px; border: 2px solid #E8F5E9; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;">
          <div style="font-weight: 600; color: #4CAF50; margin-bottom: 4px;">Cadet</div>
          <div style="font-size: 14px; color: #666;">Understands rules but needs practice and experience</div>
        </div>
      </div>
      <div class="dialog-actions">
        <button class="btn btn-secondary" onclick="hideSkillDialog()" style="color: #4CAF50;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Intermediate Skill Level Dialog -->
  <div class="dialog-overlay" id="intermediate-skill-dialog">
    <div class="dialog" style="max-width: 400px;">
      <div class="dialog-title" style="color: #FF9800;">Select Intermediate Level</div>
      <div style="margin-bottom: 20px;">
        <div class="skill-option" onclick="selectSpecificSkill('journeyman')" style="padding: 16px; border: 2px solid #FFF3E0; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;">
          <div style="font-weight: 600; color: #FF9800; margin-bottom: 4px;">Journeyman</div>
          <div style="font-size: 14px; color: #666;">Competent player with solid understanding and decent execution</div>
        </div>
        <div class="skill-option" onclick="selectSpecificSkill('veteran')" style="padding: 16px; border: 2px solid #FFF3E0; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;">
          <div style="font-weight: 600; color: #FF9800; margin-bottom: 4px;">Veteran</div>
          <div style="font-size: 14px; color: #666;">Experienced and consistent player with good game sense</div>
        </div>
      </div>
      <div class="dialog-actions">
        <button class="btn btn-secondary" onclick="hideSkillDialog()" style="color: #FF9800;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Advanced Skill Level Dialog -->
  <div class="dialog-overlay" id="advanced-skill-dialog">
    <div class="dialog" style="max-width: 400px;">
      <div class="dialog-title" style="color: #F44336;">Select Advanced Level</div>
      <div style="margin-bottom: 20px;">
        <div class="skill-option" onclick="selectSpecificSkill('elite')" style="padding: 16px; border: 2px solid #FFEBEE; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;">
          <div style="font-weight: 600; color: #F44336; margin-bottom: 4px;">Elite</div>
          <div style="font-size: 14px; color: #666;">Highly skilled with advanced strategic understanding</div>
        </div>
        <div class="skill-option" onclick="selectSpecificSkill('apex')" style="padding: 16px; border: 2px solid #FFEBEE; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;">
          <div style="font-weight: 600; color: #F44336; margin-bottom: 4px;">Apex</div>
          <div style="font-size: 14px; color: #666;">Among the absolute best, demonstrating exceptional skill</div>
        </div>
      </div>
      <div class="dialog-actions">
        <button class="btn btn-secondary" onclick="hideSkillDialog()" style="color: #F44336;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Edit Player Dialog -->
  <div class="dialog-overlay" id="edit-player-dialog">
    <div class="dialog" style="max-width: 500px;">
      <div class="dialog-title">Edit Player</div>
      
      <!-- Player Name Input -->
      <div class="form-group">
        <label class="label">Name</label>
        <input type="text" class="input" id="edit-player-name" placeholder="Enter player name" />
      </div>
      
      <!-- Gender Selection -->
      <div class="form-group">
        <label class="label">Select Gender</label>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="btn btn-secondary edit-gender-btn" data-gender="male" onclick="selectEditGender('male')" style="flex: 1; min-width: 120px;">
            👨 MALE
          </button>
          <button class="btn btn-secondary edit-gender-btn" data-gender="female" onclick="selectEditGender('female')" style="flex: 1; min-width: 120px;">
            👩 FEMALE
          </button>
        </div>
      </div>
      
      <!-- Skill Level Selection -->
      <div class="form-group">
        <label class="label">Select Skill Level</label>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="btn btn-secondary edit-skill-btn" data-skill="beginner" onclick="selectEditSkillCategory('beginner')" style="flex: 1; min-width: 100px; background: #4CAF50; color: white;">
            Beginner
          </button>
          <button class="btn btn-secondary edit-skill-btn" data-skill="intermediate" onclick="selectEditSkillCategory('intermediate')" style="flex: 1; min-width: 100px; background: #FF9800; color: white;">
            Intermediate
          </button>
          <button class="btn btn-secondary edit-skill-btn" data-skill="advanced" onclick="selectEditSkillCategory('advanced')" style="flex: 1; min-width: 100px; background: #F44336; color: white;">
            Advanced
          </button>
        </div>
        <div id="edit-selected-skill-display" style="margin-top: 8px; font-size: 14px; color: #666;">
          Please select a skill level
        </div>
      </div>
      
      <div class="dialog-actions">
        <button class="btn btn-secondary" onclick="hideEditPlayerDialog()">Cancel</button>
        <button class="btn" id="save-player-btn" onclick="savePlayerChanges()" disabled>Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Edit Player Skill Level Dialogs -->
  <div class="dialog-overlay" id="edit-beginner-skill-dialog">
    <div class="dialog" style="max-width: 400px;">
      <div class="dialog-title" style="color: #4CAF50;">Select Beginner Level</div>
      <div style="margin-bottom: 20px;">
        <div class="skill-option" onclick="selectEditSpecificSkill('initiate')" style="padding: 16px; border: 2px solid #E8F5E9; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;">
          <div style="font-weight: 600; color: #4CAF50; margin-bottom: 4px;">Initiate</div>
          <div style="font-size: 14px; color: #666;">Just starting out, learning basic rules and game flow</div>
        </div>
        <div class="skill-option" onclick="selectEditSpecificSkill('cadet')" style="padding: 16px; border: 2px solid #E8F5E9; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;">
          <div style="font-weight: 600; color: #4CAF50; margin-bottom: 4px;">Cadet</div>
          <div style="font-size: 14px; color: #666;">Understands rules but needs practice and experience</div>
        </div>
      </div>
      <div class="dialog-actions">
        <button class="btn btn-secondary" onclick="hideEditSkillDialog()" style="color: #4CAF50;">Cancel</button>
      </div>
    </div>
  </div>

  <div class="dialog-overlay" id="edit-intermediate-skill-dialog">
    <div class="dialog" style="max-width: 400px;">
      <div class="dialog-title" style="color: #FF9800;">Select Intermediate Level</div>
      <div style="margin-bottom: 20px;">
        <div class="skill-option" onclick="selectEditSpecificSkill('journeyman')" style="padding: 16px; border: 2px solid #FFF3E0; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;">
          <div style="font-weight: 600; color: #FF9800; margin-bottom: 4px;">Journeyman</div>
          <div style="font-size: 14px; color: #666;">Competent player with solid understanding and decent execution</div>
        </div>
        <div class="skill-option" onclick="selectEditSpecificSkill('veteran')" style="padding: 16px; border: 2px solid #FFF3E0; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;">
          <div style="font-weight: 600; color: #FF9800; margin-bottom: 4px;">Veteran</div>
          <div style="font-size: 14px; color: #666;">Experienced and consistent player with good game sense</div>
        </div>
      </div>
      <div class="dialog-actions">
        <button class="btn btn-secondary" onclick="hideEditSkillDialog()" style="color: #FF9800;">Cancel</button>
      </div>
    </div>
  </div>

  <div class="dialog-overlay" id="edit-advanced-skill-dialog">
    <div class="dialog" style="max-width: 400px;">
      <div class="dialog-title" style="color: #F44336;">Select Advanced Level</div>
      <div style="margin-bottom: 20px;">
        <div class="skill-option" onclick="selectEditSpecificSkill('elite')" style="padding: 16px; border: 2px solid #FFEBEE; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;">
          <div style="font-weight: 600; color: #F44336; margin-bottom: 4px;">Elite</div>
          <div style="font-size: 14px; color: #666;">Highly skilled with advanced strategic understanding</div>
        </div>
        <div class="skill-option" onclick="selectEditSpecificSkill('apex')" style="padding: 16px; border: 2px solid #FFEBEE; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;">
          <div style="font-weight: 600; color: #F44336; margin-bottom: 4px;">Apex</div>
          <div style="font-size: 14px; color: #666;">Among the absolute best, demonstrating exceptional skill</div>
        </div>
      </div>
      <div class="dialog-actions">
        <button class="btn btn-secondary" onclick="hideEditSkillDialog()" style="color: #F44336;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Synergy Team Dialog -->
  <div class="dialog-overlay" id="synergy-team-dialog">
    <div class="dialog">
      <div class="dialog-title">Create Synergy Team</div>
      <div class="form-group">
        <label class="label">Player 1</label>
        <select class="select" id="synergy-player1">
          <option value="">Select Player 1</option>
        </select>
      </div>
      <div class="form-group">
        <label class="label">Player 2</label>
        <select class="select" id="synergy-player2">
          <option value="">Select Player 2</option>
        </select>
      </div>
      <div class="form-group">
        <label class="label">Team Name (Optional)</label>
        <input type="text" class="input" id="synergy-team-name" placeholder="Auto-generated if empty" />
      </div>
      <div class="dialog-actions">
        <button class="btn btn-secondary" onclick="hideSynergyTeamDialog()">Cancel</button>
        <button class="btn" onclick="createSynergyTeamFromDialog()">Create Team</button>
      </div>
    </div>
  </div>

  <!-- Replace Player Dialog -->
  <div class="dialog-overlay" id="replace-player-dialog">
    <div class="dialog">
      <div class="dialog-title">Replace Player</div>
      <p style="margin-bottom: 16px; color: #666;">Select a standby player to replace <strong id="replace-target-name"></strong></p>
      <div id="replace-player-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="dialog-actions">
        <button class="btn btn-secondary" onclick="hideReplacePlayerDialog()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Swap Player Dialog -->
  <div class="dialog-overlay" id="swap-player-dialog">
    <div class="dialog">
      <div class="dialog-title">Swap Partners</div>
      <p style="margin-bottom: 16px; color: #666;">Select a player to swap with <strong id="swap-target-name"></strong></p>
      <div id="swap-player-list" style="max-height: 300px; overflow-y: auto;"></div>
      <div class="dialog-actions">
        <button class="btn btn-secondary" onclick="hideSwapPlayerDialog()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Player Action Selection Dialog -->
  <div class="dialog-overlay" id="player-action-dialog">
    <div class="dialog">
      <div class="dialog-title">Player Actions</div>
      <p style="margin-bottom: 20px; color: #666;">What would you like to do with <strong id="action-target-name"></strong>?</p>
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <button class="btn" onclick="selectPlayerAction('replace')" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #4CAF50; border-color: #4CAF50;">
          <span style="font-size: 20px;">🔄</span>
          <div style="text-align: left;">
            <div style="font-weight: 600;">REPLACE</div>
            <div style="font-size: 12px; opacity: 0.9;">Replace with a standby player</div>
          </div>
        </button>
        <button class="btn" onclick="selectPlayerAction('swap')" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #FF9800; border-color: #FF9800;">
          <span style="font-size: 20px;">🔀</span>
          <div style="text-align: left;">
            <div style="font-weight: 600;">SWAP</div>
            <div style="font-size: 12px; opacity: 0.9;">Swap with teammate or opponent</div>
          </div>
        </button>
      </div>
      <div class="dialog-actions" style="margin-top: 16px;">
        <button class="btn btn-secondary" onclick="hidePlayerActionDialog()">Cancel</button>
      </div>
    </div>
  </div>



  <!-- Clear Statistics Dialog -->
  <div class="dialog-overlay" id="clear-stats-dialog">
    <div class="dialog" style="max-width: 480px;">
      <div class="dialog-title" style="color: #FF9800;">⚠️ Clear Player Statistics</div>
      <div style="margin: 16px 0; line-height: 1.5; color: #333;">
        <p><strong>Are you sure you want to clear all player statistics?</strong></p>
        <p>This action will:</p>
        <ul style="margin: 12px 0; padding-left: 20px;">
          <li>Reset all games played to <strong>0</strong></li>
          <li>Reset all wins to <strong>0</strong></li>
          <li>Reset all win rates to <strong>0%</strong></li>
          <li>Clear all match history</li>
        </ul>
        <p style="color: #4CAF50;"><strong>✓ Player names will be preserved</strong></p>
        <p style="color: #F44336; font-weight: 600;">⚠️ This action cannot be undone!</p>
      </div>
      <div class="dialog-actions">
        <button class="btn btn-secondary" onclick="hideClearStatsDialog()">Cancel</button>
        <button class="btn" onclick="confirmClearStats()" style="background: #FF9800; border-color: #FF9800;">Clear Statistics</button>
      </div>
    </div>
  </div>

  <!-- Clear All Data Dialog -->
  <div class="dialog-overlay" id="clear-all-data-dialog">
    <div class="dialog" style="max-width: 480px;">
      <div class="dialog-title" style="color: #F44336;">🚨 Clear All Players</div>
      <div style="margin: 16px 0; line-height: 1.5; color: #333;">
        <p><strong>DANGER: This will completely remove all data!</strong></p>
        <p>This action will:</p>
        <ul style="margin: 12px 0; padding-left: 20px;">
          <li>Delete <strong>ALL PLAYERS</strong> permanently</li>
          <li>Delete <strong>ALL STATISTICS</strong></li>
          <li>Delete <strong>ALL MATCH HISTORY</strong></li>
          <li>Delete <strong>ALL QUEUE DATA</strong></li>
          <li>Delete <strong>ALL SYNERGY TEAMS</strong></li>
        </ul>
        <p style="color: #F44336; font-weight: 600; background: #FFEBEE; padding: 12px; border-radius: 8px; border-left: 4px solid #F44336;">
          ⚠️ THIS ACTION CANNOT BE UNDONE!<br>
          You will lose all your data permanently.
        </p>
      </div>
      <div style="margin: 16px 0;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="confirm-clear-all" style="transform: scale(1.2);">
          <span style="color: #333; font-weight: 600;">I understand this will permanently delete all data</span>
        </label>
      </div>
      <div class="dialog-actions">
        <button class="btn btn-secondary" onclick="hideClearAllDataDialog()">Cancel</button>
        <button class="btn" onclick="confirmClearAllData()" style="background: #F44336; border-color: #F44336;" disabled id="confirm-clear-all-btn">Delete Everything</button>
      </div>
    </div>
  </div>

  <!-- Live Match Dialog -->
  <div class="dialog-overlay" id="live-match-dialog">
    <div class="dialog">
      <div class="dialog-title">Live Match</div>
      
      <!-- Court Visualization -->
      <div class="court-container" style="margin: 16px 0;">
        <svg class="badminton-court-svg" viewBox="0 0 400 240" xmlns="http://www.w3.org/2000/svg">
          <!-- Court background -->
          <rect width="400" height="240" fill="#228B22"/>
          
          <!-- Outer boundary -->
          <rect x="20" y="20" width="360" height="200" fill="none" stroke="white" stroke-width="3"/>
          
          <!-- Center line -->
          <line x1="200" y1="20" x2="200" y2="220" stroke="white" stroke-width="2"/>
          
          <!-- Service lines (long service line for doubles) -->
          <line x1="20" y1="60" x2="380" y2="60" stroke="white" stroke-width="2"/>
          <line x1="20" y1="180" x2="380" y2="180" stroke="white" stroke-width="2"/>
          
          <!-- Short service lines -->
          <line x1="20" y1="100" x2="380" y2="100" stroke="white" stroke-width="2"/>
          <line x1="20" y1="140" x2="380" y2="140" stroke="white" stroke-width="2"/>
          
          <!-- Side lines for doubles -->
          <line x1="60" y1="20" x2="60" y2="220" stroke="white" stroke-width="2"/>
          <line x1="340" y1="20" x2="340" y2="220" stroke="white" stroke-width="2"/>
          
          <!-- Player positions -->
          <!-- Team 1 (Left side) -->
          <g class="team-left-players">
            <rect x="70" y="80" width="80" height="25" rx="12" fill="rgba(255,255,255,0.9)"/>
            <text x="110" y="97" text-anchor="middle" font-size="12" font-weight="bold" fill="#0175C2" id="live-player1-svg">Player 1</text>
            
            <rect x="70" y="130" width="80" height="25" rx="12" fill="rgba(255,255,255,0.9)"/>
            <text x="110" y="147" text-anchor="middle" font-size="12" font-weight="bold" fill="#0175C2" id="live-player2-svg">Player 2</text>
          </g>
          
          <!-- Team 2 (Right side) -->
          <g class="team-right-players">
            <rect x="250" y="80" width="80" height="25" rx="12" fill="rgba(255,255,255,0.9)"/>
            <text x="290" y="97" text-anchor="middle" font-size="12" font-weight="bold" fill="#E91E63" id="live-player3-svg">Player 3</text>
            
            <rect x="250" y="130" width="80" height="25" rx="12" fill="rgba(255,255,255,0.9)"/>
            <text x="290" y="147" text-anchor="middle" font-size="12" font-weight="bold" fill="#E91E63" id="live-player4-svg">Player 4</text>
          </g>
        </svg>
      </div>
      
      <!-- Team Selection for Winner -->
      <div style="margin: 20px 0;">
        <h4 style="margin-bottom: 12px; text-align: center;">Select Winner</h4>
        <div style="display: flex; gap: 12px;">
          <button class="btn btn-success" id="team1-wins" onclick="selectWinner(1)" style="flex: 1;">
            <div style="font-weight: bold;">Team 1 Wins</div>
            <div style="font-size: 12px;" id="team1-names"></div>
          </button>
          <button class="btn btn-success" id="team2-wins" onclick="selectWinner(2)" style="flex: 1;">
            <div style="font-weight: bold;">Team 2 Wins</div>
            <div style="font-size: 12px;" id="team2-names"></div>
          </button>
        </div>
      </div>
      
      <div class="dialog-actions">
        <button class="btn btn-secondary" onclick="hideLiveMatchDialog()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // Player data structure with skill level ordinals
    const skillLevels = {
      initiate: { name: 'Initiate', description: 'Just starting out, learning basic rules and game flow', tier: 'Beginner Tier', ordinal: 0 },
      cadet: { name: 'Cadet', description: 'Understands rules but needs practice and experience', tier: 'Beginner Tier', ordinal: 1 },
      journeyman: { name: 'Journeyman', description: 'Competent player with solid understanding and decent execution', tier: 'Intermediate Tier', ordinal: 2 },
      veteran: { name: 'Veteran', description: 'Experienced player with good game sense', tier: 'Intermediate Tier', ordinal: 3 },
      elite: { name: 'Elite', description: 'Highly skilled with advanced strategic understanding', tier: 'Advanced Tier', ordinal: 4 },
      apex: { name: 'Apex', description: 'Among the absolute best, demonstrating exceptional skill', tier: 'Advanced Tier', ordinal: 5 }
    };

    // App State
    let players = [];
    let courts = ['Court 1', 'Court 2'];
    let queue = [];
    let synergyTeams = [];
    let isSynergyModeActive = false;
    let recentMatches = [];
    let activeMatches = [];
    let activeTab = 'home';
    let playerIdCounter = 1;
    let currentMatchType = 'balanced';
    let currentReplaceTarget = null;
    
    // Finance data
    let financeData = {
      courtFeePerHour: 0,
      hoursPlayed: 0,
      numberOfCourts: 0,
      shuttlecockPrice: 0,
      shuttlecocksUsed: 0,
      playersPaid: new Set(),
      paymentMethods: new Map() // Store payment method for each player
    };
    let currentSwapTarget = null;

    // PWA Setup
    function setupPWA() {
      const manifest = {
        name: "Smash Syndicate - Badminton Engagement Network",
        short_name: "Smash Syndicate",
        start_url: window.location.href,
        display: "standalone",
        background_color: "#2196F3",
        theme_color: "#2196F3",
        description: "Complete badminton tournament and match management application",
        icons: [
          {
            src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='50' fill='%232196F3'/%3E%3Ctext x='256' y='340' font-family='Arial' font-size='300' text-anchor='middle' fill='white'%3E🏸%3C/text%3E%3C/svg%3E",
            sizes: "512x512",
            type: "image/svg+xml"
          }
        ]
      };

      const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
      const manifestUrl = URL.createObjectURL(manifestBlob);
      document.getElementById('manifest-link').href = manifestUrl;
    }

    // Navigation
    function switchTab(tabName) {
      console.log('switchTab called with:', tabName);
      
      try {
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });
        document.querySelectorAll('.nav-item').forEach(nav => {
          nav.classList.remove('active');
        });

        const targetTab = document.getElementById(tabName + '-tab');
        if (targetTab) {
          targetTab.classList.add('active');
          console.log('Tab activated:', tabName + '-tab');
        } else {
          console.error('Tab not found:', tabName + '-tab');
        }
      
      // Handle navigation visibility based on mode
      const topNav = document.getElementById('top-nav');
      const bottomActions = document.getElementById('bottom-actions');
      const settingsBtn = document.getElementById('settings-btn');
      const homeBtn = document.getElementById('home-btn');
      const content = document.querySelector('.content');
      
      if (tabName === 'home') {
        // Home page - hide navigation, clean interface
        topNav.style.display = 'none';
        bottomActions.style.display = 'none';
        content.style.paddingTop = '20px';
        content.style.paddingBottom = '20px';
      } else if (tabName === 'tournament') {
        // Tournament mode - hide Normal Queue navigation
        topNav.style.display = 'none';
        bottomActions.style.display = 'none';
        content.style.paddingTop = '20px';
        content.style.paddingBottom = '20px';
      } else {
        // Normal Queue Mode - show top navigation and bottom actions
        topNav.style.display = 'flex';
        bottomActions.style.display = 'flex';
        settingsBtn.style.display = 'block';
        homeBtn.style.display = 'block';
        content.style.paddingTop = '90px';
        content.style.paddingBottom = '80px';
        
        // Update active nav item
        const navItem = document.querySelector(`[data-tab="${tabName}"]`);
        if (navItem) {
          navItem.classList.add('active');
        }
      }
      
      activeTab = tabName;
      
      // Update storage info when settings tab is opened
      if (tabName === 'settings') {
        updateStorageInfo();
      }
      
      // Update finance displays when finance tab is opened
      if (tabName === 'finance') {
        updatePlayerPaymentList();
      }
      
      console.log('switchTab completed successfully');
    } catch (error) {
      console.error('Error in switchTab:', error);
    }
    }

    // Enhanced Player Registration Variables
    let currentPlayerAddMode = 'single';
    let selectedGender = null;
    let selectedSkillLevel = null;
    let currentGenderFilter = 'all';
    let currentSortCriteria = 'name';
    let currentSortDescending = false;
    
    // Player Management
    function showAddPlayerDialog() {
      // Ensure all dialogs are hidden first
      hideSkillDialog();
      
      // Reset form
      currentPlayerAddMode = 'single';
      selectedGender = null;
      selectedSkillLevel = null;
      
      document.getElementById('player-name').value = '';
      document.getElementById('player-names-bulk').value = '';
      document.getElementById('selected-skill-display').textContent = 'Please select a skill level';
      document.getElementById('add-player-btn').disabled = true;
      
      // Reset button states
      setPlayerAddMode('single');
      updateGenderButtons();
      updateSkillButtons();
      
      // Show the dialog with proper display
      const dialog = document.getElementById('add-player-dialog');
      dialog.style.display = 'flex';
      dialog.classList.add('show');
      
      console.log('Player dialog opened');
    }
    
    function setPlayerAddMode(mode) {
      currentPlayerAddMode = mode;
      
      const singleBtn = document.getElementById('single-mode-btn');
      const bulkBtn = document.getElementById('bulk-mode-btn');
      const nameInput = document.getElementById('player-name');
      const namesTextarea = document.getElementById('player-names-bulk');
      const nameLabel = document.getElementById('name-label');
      const addBtn = document.getElementById('add-player-btn');
      
      if (mode === 'single') {
        singleBtn.style.background = '#2196F3';
        singleBtn.style.color = 'white';
        bulkBtn.style.background = '#f0f0f0';
        bulkBtn.style.color = '#333';
        
        nameInput.style.display = 'block';
        namesTextarea.style.display = 'none';
        nameLabel.textContent = 'Name';
        addBtn.textContent = 'Add Player';
      } else {
        bulkBtn.style.background = '#2196F3';
        bulkBtn.style.color = 'white';
        singleBtn.style.background = '#f0f0f0';
        singleBtn.style.color = '#333';
        
        nameInput.style.display = 'none';
        namesTextarea.style.display = 'block';
        nameLabel.textContent = 'Names (one per line)';
        addBtn.textContent = 'Add Players';
      }
      
      validatePlayerForm();
    }
    
    function selectGender(gender) {
      selectedGender = gender;
      updateGenderButtons();
      validatePlayerForm();
    }
    
    function updateGenderButtons() {
      document.querySelectorAll('.gender-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (btn.dataset.gender === selectedGender) {
          btn.classList.add('selected');
        }
      });
    }
    
    function selectSkillCategory(category) {
      // Hide main dialog temporarily and show skill selection dialog
      document.getElementById('add-player-dialog').style.display = 'none';
      
      if (category === 'beginner') {
        document.getElementById('beginner-skill-dialog').classList.add('show');
      } else if (category === 'intermediate') {
        document.getElementById('intermediate-skill-dialog').classList.add('show');
      } else if (category === 'advanced') {
        document.getElementById('advanced-skill-dialog').classList.add('show');
      }
    }
    
    function selectSpecificSkill(skillLevel) {
      selectedSkillLevel = skillLevel;
      
      // Hide skill dialog and show main dialog
      hideSkillDialog();
      document.getElementById('add-player-dialog').style.display = 'flex';
      
      // Update display
      const skillData = skillLevels[skillLevel];
      document.getElementById('selected-skill-display').innerHTML = 
        `<strong>${skillData.name}</strong> - ${getSkillDescription(skillLevel)}`;
      
      updateSkillButtons();
      validatePlayerForm();
    }
    
    function getSkillDescription(skillLevel) {
      const descriptions = {
        'initiate': 'Just starting out, learning basic rules and game flow',
        'cadet': 'Understands rules but needs practice and experience',
        'journeyman': 'Competent player with solid understanding and decent execution',
        'veteran': 'Experienced and consistent player with good game sense',
        'elite': 'Highly skilled with advanced strategic understanding',
        'apex': 'Among the absolute best, demonstrating exceptional skill'
      };
      return descriptions[skillLevel] || '';
    }
    
    function updateSkillButtons() {
      document.querySelectorAll('.skill-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      if (selectedSkillLevel) {
        const category = getSkillCategory(selectedSkillLevel);
        const categoryBtn = document.querySelector(`[data-skill="${category}"]`);
        if (categoryBtn) {
          categoryBtn.classList.add('selected');
        }
      }
    }
    
    function getSkillCategory(skillLevel) {
      if (['initiate', 'cadet'].includes(skillLevel)) return 'beginner';
      if (['journeyman', 'veteran'].includes(skillLevel)) return 'intermediate';
      if (['elite', 'apex'].includes(skillLevel)) return 'advanced';
      return null;
    }
    
    function hideSkillDialog() {
      document.getElementById('beginner-skill-dialog').classList.remove('show');
      document.getElementById('intermediate-skill-dialog').classList.remove('show');
      document.getElementById('advanced-skill-dialog').classList.remove('show');
      
      // Reset main dialog display to flex if it was hidden
      const mainDialog = document.getElementById('add-player-dialog');
      if (mainDialog.classList.contains('show')) {
        mainDialog.style.display = 'flex';
      }
    }
    
    function validatePlayerForm() {
      const nameInput = document.getElementById('player-name');
      const namesTextarea = document.getElementById('player-names-bulk');
      const addBtn = document.getElementById('add-player-btn');
      
      let hasValidName = false;
      
      if (currentPlayerAddMode === 'single') {
        hasValidName = nameInput.value.trim().length > 0;
      } else {
        const names = namesTextarea.value.trim().split('\n').filter(name => name.trim().length > 0);
        hasValidName = names.length > 0;
      }
      
      const isValid = hasValidName && selectedGender && selectedSkillLevel;
      addBtn.disabled = !isValid;
    }

    function hideAddPlayerDialog() {
      console.log('hideAddPlayerDialog called');
      
      // Hide main dialog with multiple methods to ensure it closes
      const mainDialog = document.getElementById('add-player-dialog');
      if (mainDialog) {
        mainDialog.classList.remove('show');
        mainDialog.style.display = 'none';
        console.log('Main dialog hidden');
      }
      
      // Also hide any skill level dialogs that might be open
      hideSkillDialog();
      
      // Reset form state
      selectedGender = null;
      selectedSkillLevel = null;
      currentPlayerAddMode = 'single';
      
      // Clear form fields
      document.getElementById('player-name').value = '';
      document.getElementById('player-names-bulk').value = '';
      document.getElementById('selected-skill-display').textContent = 'Please select a skill level';
      document.getElementById('add-player-btn').disabled = true;
      
      console.log('Player dialog closed and reset');
    }

    // Old function removed - using addPlayerFromDialogNew() instead

    // Enhanced addPlayerFromDialog with bulk support
    function addPlayerFromDialogNew() {
      if (!selectedGender || !selectedSkillLevel) {
        alert('Please select both gender and skill level');
        return;
      }

      if (currentPlayerAddMode === 'single') {
        // Single player addition
        const name = document.getElementById('player-name').value.trim();
        
        if (!name) {
          alert('Please enter a player name');
          return;
        }

        if (players.some(player => player.name.toLowerCase() === name.toLowerCase())) {
          alert('A player with this name already exists');
          return;
        }

        const player = {
          id: playerIdCounter++,
          name: name.charAt(0).toUpperCase() + name.slice(1), // Capitalize first letter
          gender: selectedGender,
          skillLevel: selectedSkillLevel,
          stats: { wins: 0, gamesPlayed: 0, winRate: 0 },
          matchHistory: { recentTeammates: [], recentOpponents: [] },
          isExcluded: false
        };

        players.push(player);
        console.log('Added player:', player);
        
      } else {
        // Bulk player addition
        const namesText = document.getElementById('player-names-bulk').value.trim();
        const names = namesText.split('\n').filter(name => name.trim().length > 0);
        
        if (names.length === 0) {
          alert('Please enter at least one player name');
          return;
        }

        const duplicates = [];
        const addedPlayers = [];
        
        names.forEach(name => {
          const trimmedName = name.trim();
          const capitalizedName = trimmedName.charAt(0).toUpperCase() + trimmedName.slice(1);
          
          if (players.some(player => player.name.toLowerCase() === capitalizedName.toLowerCase())) {
            duplicates.push(capitalizedName);
          } else {
            const player = {
              id: playerIdCounter++,
              name: capitalizedName,
              gender: selectedGender,
              skillLevel: selectedSkillLevel,
              stats: { wins: 0, gamesPlayed: 0, winRate: 0 },
              matchHistory: { recentTeammates: [], recentOpponents: [] },
              isExcluded: false
            };
            
            players.push(player);
            addedPlayers.push(player);
          }
        });
        
        console.log(`Added ${addedPlayers.length} players:`, addedPlayers);
        
        if (duplicates.length > 0) {
          alert(`Added ${addedPlayers.length} players successfully!\n\nSkipped duplicates: ${duplicates.join(', ')}`);
        } else {
          alert(`Successfully added ${addedPlayers.length} players!`);
        }
      }

      updatePlayersDisplay();
      updateSynergyPlayerOptions();
      updateStandbyPlayersDisplay();
      
      console.log('About to hide player dialog...');
      
      // Use setTimeout to ensure DOM updates complete before hiding dialog
      setTimeout(() => {
        hideAddPlayerDialog();
        console.log('Player dialog should be hidden now');
      }, 100);
      
      saveToStorage();
    }

    // Player Editing Functions
    let editingPlayerId = null;
    let editSelectedGender = null;
    let editSelectedSkillLevel = null;

    function editPlayer(playerId) {
      console.log('editPlayer called with ID:', playerId);
      
      const player = players.find(p => p.id === playerId);
      if (!player) {
        alert('Player not found');
        return;
      }

      editingPlayerId = playerId;
      // Handle "other" gender by defaulting to male
      editSelectedGender = player.gender === 'other' ? 'male' : player.gender;
      editSelectedSkillLevel = player.skillLevel;

      console.log('Setting up edit for player:', player.name, 'Gender:', player.gender, 'Skill:', player.skillLevel);

      // Populate the form
      const nameInput = document.getElementById('edit-player-name');
      const skillDisplay = document.getElementById('edit-selected-skill-display');
      
      if (nameInput) {
        nameInput.value = player.name;
      } else {
        console.error('edit-player-name element not found');
      }
      
      if (skillDisplay && skillLevels[player.skillLevel]) {
        skillDisplay.innerHTML = `<strong>${skillLevels[player.skillLevel].name}</strong> - ${getSkillDescription(player.skillLevel)}`;
      } else {
        console.error('edit-selected-skill-display element not found or skill level invalid');
      }

      // Update button states
      updateEditGenderButtons();
      updateEditSkillButtons();
      validateEditPlayerForm();

      // Show the dialog
      const dialog = document.getElementById('edit-player-dialog');
      if (dialog) {
      dialog.style.display = 'flex';
      dialog.classList.add('show');
        console.log('Edit dialog shown successfully');
      } else {
        console.error('edit-player-dialog element not found');
      }

      console.log('Editing player:', player);
    }

    function hideEditPlayerDialog() {
      document.getElementById('edit-player-dialog').classList.remove('show');
      document.getElementById('edit-player-dialog').style.display = 'none';
      hideEditSkillDialog();

      // Reset state
      editingPlayerId = null;
      editSelectedGender = null;
      editSelectedSkillLevel = null;
    }

    function selectEditGender(gender) {
      console.log('selectEditGender called with:', gender);
      editSelectedGender = gender;
      updateEditGenderButtons();
      validateEditPlayerForm();
      console.log('Gender selection updated, editSelectedGender:', editSelectedGender);
    }

    function updateEditGenderButtons() {
      console.log('updateEditGenderButtons called, editSelectedGender:', editSelectedGender);
      document.querySelectorAll('.edit-gender-btn').forEach(btn => {
        btn.classList.remove('selected');
        console.log('Button gender:', btn.dataset.gender, 'Selected gender:', editSelectedGender);
        if (btn.dataset.gender === editSelectedGender) {
          btn.classList.add('selected');
          console.log('Added selected class to button:', btn.dataset.gender);
        }
      });
    }

    function selectEditSkillCategory(category) {
      document.getElementById('edit-player-dialog').style.display = 'none';
      
      if (category === 'beginner') {
        document.getElementById('edit-beginner-skill-dialog').classList.add('show');
      } else if (category === 'intermediate') {
        document.getElementById('edit-intermediate-skill-dialog').classList.add('show');
      } else if (category === 'advanced') {
        document.getElementById('edit-advanced-skill-dialog').classList.add('show');
      }
    }

    function selectEditSpecificSkill(skillLevel) {
      editSelectedSkillLevel = skillLevel;
      
      hideEditSkillDialog();
      document.getElementById('edit-player-dialog').style.display = 'flex';
      
      const skillData = skillLevels[skillLevel];
      document.getElementById('edit-selected-skill-display').innerHTML = 
        `<strong>${skillData.name}</strong> - ${getSkillDescription(skillLevel)}`;
      
      updateEditSkillButtons();
      validateEditPlayerForm();
    }

    function updateEditSkillButtons() {
      document.querySelectorAll('.edit-skill-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      if (editSelectedSkillLevel) {
        const category = getSkillCategory(editSelectedSkillLevel);
        const categoryBtn = document.querySelector(`[data-skill="${category}"]`);
        if (categoryBtn && categoryBtn.classList.contains('edit-skill-btn')) {
          categoryBtn.classList.add('selected');
        }
      }
    }

    function hideEditSkillDialog() {
      document.getElementById('edit-beginner-skill-dialog').classList.remove('show');
      document.getElementById('edit-intermediate-skill-dialog').classList.remove('show');
      document.getElementById('edit-advanced-skill-dialog').classList.remove('show');
      
      const mainDialog = document.getElementById('edit-player-dialog');
      if (mainDialog.classList.contains('show')) {
        mainDialog.style.display = 'flex';
      }
    }

    function validateEditPlayerForm() {
      const nameInput = document.getElementById('edit-player-name');
      const saveBtn = document.getElementById('save-player-btn');
      
      const hasValidName = nameInput.value.trim().length > 0;
      const isValid = hasValidName && editSelectedGender && editSelectedSkillLevel;
      
      console.log('Form validation:', {
        hasValidName,
        editSelectedGender,
        editSelectedSkillLevel,
        isValid
      });
      
      saveBtn.disabled = !isValid;
    }

    function savePlayerChanges() {
      console.log('savePlayerChanges called');
      console.log('Current state:', {
        editingPlayerId,
        editSelectedGender,
        editSelectedSkillLevel
      });
      

      
      try {
        if (!editingPlayerId || !editSelectedGender || !editSelectedSkillLevel) {
          alert('Please fill in all required fields');
          return;
        }

      const newName = document.getElementById('edit-player-name').value.trim();
      if (!newName) {
        alert('Please enter a player name');
        return;
      }

      // Check for duplicate names (excluding current player)
      const duplicatePlayer = players.find(p => 
        p.id !== editingPlayerId && 
        p.name.toLowerCase() === newName.toLowerCase()
      );

      if (duplicatePlayer) {
        alert('A player with this name already exists');
        return;
      }

      // Find and update the player
      const player = players.find(p => p.id === editingPlayerId);
      if (!player) {
        alert('Player not found');
        return;
      }

      // Store old values for reference
      const oldName = player.name;
      const oldGender = player.gender;
      const oldSkillLevel = player.skillLevel;

      // Check for major changes that need warnings
      const warnings = [];
      
      // Major skill level changes
      const skillCategories = ['beginner', 'intermediate', 'advanced'];
      const oldCategory = getSkillCategory(oldSkillLevel);
      const newCategory = getSkillCategory(editSelectedSkillLevel);
      const oldCategoryIndex = skillCategories.indexOf(oldCategory);
      const newCategoryIndex = skillCategories.indexOf(newCategory);
      const categoryJump = Math.abs(newCategoryIndex - oldCategoryIndex);
      
      if (categoryJump >= 2) {
        warnings.push(`⚠️ Major skill change: ${oldSkillLevel} → ${editSelectedSkillLevel}\nThis may affect historical match fairness.`);
      }
      
      // Gender changes that might affect existing matches
      if (oldGender !== editSelectedGender) {
        const hasActiveMatches = activeMatches && Array.isArray(activeMatches) && activeMatches.some(match => 
          match && match.match && match.match.team1 && match.match.team2 &&
          (match.match.team1.some(p => p && p.id === editingPlayerId) || 
           match.match.team2.some(p => p && p.id === editingPlayerId))
        );
        
        if (hasActiveMatches) {
          warnings.push(`⚠️ Gender change with active matches\nThis may affect match balance.`);
        }
      }

      // Show warnings if any
      if (warnings.length > 0) {
        const warningMessage = warnings.join('\n\n') + '\n\nDo you want to continue?';
        if (!confirm(warningMessage)) {
          return;
        }
      }

      // Update player data
      player.name = newName.charAt(0).toUpperCase() + newName.slice(1);
      player.gender = editSelectedGender;
      player.skillLevel = editSelectedSkillLevel;

      console.log(`Player updated: ${oldName} -> ${player.name}, ${oldGender} -> ${player.gender}, ${oldSkillLevel} -> ${player.skillLevel}`);

      // Update all references across the app
      updatePlayerReferencesAcrossApp(editingPlayerId, oldName, player.name);

      // Refresh displays
      updatePlayersDisplay();
      updateSynergyPlayerOptions();
      updateStandbyPlayersDisplay();
      updateActiveMatchesDisplay();
      updateRecentMatchesDisplay();
      updateQueueDisplay();

      // Save to storage
      saveToStorage();

      // Close dialog
      hideEditPlayerDialog();

      alert(`✅ Player updated successfully!\n\nChanges made:\n• Name: ${oldName} → ${player.name}\n• Gender: ${oldGender} → ${player.gender}\n• Skill: ${oldSkillLevel} → ${player.skillLevel}\n\nAll statistics and match history have been preserved.`);
      } catch (error) {
        console.error('Error in savePlayerChanges:', error);
        alert(`Error saving player changes: ${error.message}`);
      }
    }

    function updatePlayerReferencesAcrossApp(playerId, oldName, newName) {
      console.log('Updating player references:', { playerId, oldName, newName });
      
      try {
        // Update active matches
        if (activeMatches && Array.isArray(activeMatches)) {
          activeMatches.forEach(match => {
            if (match && match.match && match.match.team1 && match.match.team2) {
              match.match.team1.forEach(player => {
                if (player && player.id === playerId) {
                  player.name = newName;
                }
              });
              match.match.team2.forEach(player => {
                if (player && player.id === playerId) {
                  player.name = newName;
                }
              });
            }
          });
        }

        // Update queue
        if (queue && Array.isArray(queue)) {
          queue.forEach(match => {
            if (match && match.team1 && match.team2) {
              match.team1.forEach(player => {
                if (player && player.id === playerId) {
                  player.name = newName;
                }
              });
              match.team2.forEach(player => {
                if (player && player.id === playerId) {
                  player.name = newName;
                }
              });
            }
          });
        }

        // Update recent matches
        if (recentMatches && Array.isArray(recentMatches)) {
          recentMatches.forEach(match => {
            if (match && match.team1 && match.team2) {
              match.team1.forEach(player => {
                if (player && player.id === playerId) {
                  player.name = newName;
                }
              });
              match.team2.forEach(player => {
                if (player && player.id === playerId) {
                  player.name = newName;
                }
              });
            }
          });
        }

        // Update synergy teams
        if (synergyTeams && Array.isArray(synergyTeams)) {
          synergyTeams.forEach(team => {
            if (team && team.player1 && team.player1.id === playerId) {
              team.player1.name = newName;
            }
            if (team && team.player2 && team.player2.id === playerId) {
              team.player2.name = newName;
            }
          });
        }

        // Update finance data (player payment tracking by name)
        if (financeData && financeData.playersPaid && financeData.playersPaid.has(oldName)) {
          financeData.playersPaid.delete(oldName);
          financeData.playersPaid.add(newName);
        }

        console.log('✅ Updated player references across app successfully');
      } catch (error) {
        console.error('❌ Error updating player references:', error);
        // Don't throw the error - just log it and continue
      }
    }

    // Add event listener for edit form validation
    function setupEditPlayerFormListeners() {
      const nameInput = document.getElementById('edit-player-name');
      if (nameInput) {
        nameInput.addEventListener('input', validateEditPlayerForm);
      }
    }

    // Player Sorting and Filtering Functions
    function sortPlayers() {
      currentSortCriteria = document.getElementById('sort-criteria').value;
      currentSortDescending = document.getElementById('sort-descending').checked;
      updatePlayersDisplay();
    }

    function filterByGender(gender) {
      currentGenderFilter = gender;
      
      // Update filter button states
      document.getElementById('filter-all').classList.remove('btn-primary');
      document.getElementById('filter-male').classList.remove('btn-primary');
      document.getElementById('filter-female').classList.remove('btn-primary');
      
      document.getElementById('filter-all').classList.add('btn-secondary');
      document.getElementById('filter-male').classList.add('btn-secondary');
      document.getElementById('filter-female').classList.add('btn-secondary');
      
      const activeButton = document.getElementById(`filter-${gender}`);
      if (activeButton) {
        activeButton.classList.remove('btn-secondary');
        activeButton.classList.add('btn-primary');
      }
      
      updatePlayersDisplay();
    }

    function getFilteredAndSortedPlayers() {
      let filteredPlayers = [...players];
      
      // Apply gender filter
      if (currentGenderFilter !== 'all') {
        filteredPlayers = filteredPlayers.filter(player => player.gender === currentGenderFilter);
      }
      
      // Apply sorting
      filteredPlayers.sort((a, b) => {
        let aValue, bValue;
        
        switch (currentSortCriteria) {
          case 'name':
            aValue = a.name.toLowerCase();
            bValue = b.name.toLowerCase();
            break;
          case 'gender':
            aValue = a.gender;
            bValue = b.gender;
            break;
          case 'skillLevel':
            aValue = skillLevels[a.skillLevel].ordinal;
            bValue = skillLevels[b.skillLevel].ordinal;
            break;
          case 'gamesPlayed':
            aValue = a.stats.gamesPlayed;
            bValue = b.stats.gamesPlayed;
            break;
          case 'wins':
            aValue = a.stats.wins;
            bValue = b.stats.wins;
            break;
          default:
            aValue = a.name.toLowerCase();
            bValue = b.name.toLowerCase();
        }
        
        if (aValue < bValue) return currentSortDescending ? 1 : -1;
        if (aValue > bValue) return currentSortDescending ? -1 : 1;
        return 0;
      });
      
      return filteredPlayers;
    }

    function removePlayer(playerId) {
      if (confirm('Are you sure you want to remove this player?')) {
        players = players.filter(player => player.id !== playerId);
        updatePlayersDisplay();
        updateSynergyPlayerOptions();
        saveToStorage();
      }
    }

    function togglePlayerExclusion(playerId) {
      const player = players.find(p => p.id === playerId);
      if (player) {
        player.isExcluded = !player.isExcluded;
        updatePlayersDisplay();
        saveToStorage();
      }
    }

    function updatePlayerCounts() {
      const totalPlayers = players.length;
      const includedPlayers = players.filter(p => !p.isExcluded).length;
      const excludedPlayers = players.filter(p => p.isExcluded).length;
      const malePlayers = players.filter(p => p.gender === 'male').length;
      const femalePlayers = players.filter(p => p.gender === 'female').length;
      const otherPlayers = players.filter(p => p.gender === 'other').length;
      
      // Update total count
      const totalCountElement = document.getElementById('total-player-count');
      if (totalCountElement) {
        totalCountElement.textContent = `${totalPlayers} Player${totalPlayers !== 1 ? 's' : ''}`;
      }
      
      // Update breakdown stats
      const breakdownElement = document.getElementById('player-stats-breakdown');
      if (breakdownElement) {
        if (totalPlayers === 0) {
          breakdownElement.innerHTML = `
            <div style="color: #666; font-size: 14px; width: 100%; text-align: center;">
              No players registered yet
            </div>
          `;
        } else {
          breakdownElement.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="width: 8px; height: 8px; background: #4CAF50; border-radius: 50%;"></div>
              <span style="color: #333; font-size: 14px;"><strong>${includedPlayers}</strong> Active</span>
            </div>
            ${excludedPlayers > 0 ? `
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 8px; height: 8px; background: #F44336; border-radius: 50%;"></div>
                <span style="color: #333; font-size: 14px;"><strong>${excludedPlayers}</strong> Excluded</span>
              </div>
            ` : ''}
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="width: 8px; height: 8px; background: #0175C2; border-radius: 50%;"></div>
              <span style="color: #333; font-size: 14px;"><strong>${malePlayers}</strong> Male</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="width: 8px; height: 8px; background: #E91E63; border-radius: 50%;"></div>
              <span style="color: #333; font-size: 14px;"><strong>${femalePlayers}</strong> Female</span>
            </div>
            ${otherPlayers > 0 ? `
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 8px; height: 8px; background: #9C27B0; border-radius: 50%;"></div>
                <span style="color: #333; font-size: 14px;"><strong>${otherPlayers}</strong> Other</span>
              </div>
            ` : ''}
          `;
        }
      }
    }

    function updatePlayersDisplay() {
      // Update player counts first
      updatePlayerCounts();
      
      const container = document.getElementById('players-list');
      
      // Get filtered and sorted players
      const sortedPlayers = getFilteredAndSortedPlayers();
      
      if (players.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">👥</div>
            <h3>No players added yet</h3>
            <p>Tap "Add Player" to get started!</p>
          </div>
        `;
        return;
      }
      
      if (sortedPlayers.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">🔍</div>
            <h3>No players match current filters</h3>
            <p>Try adjusting your filters or add more players.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = sortedPlayers.map(player => {
        const skill = skillLevels[player.skillLevel];
        const genderIcon = player.gender === 'male' ? '👨' : player.gender === 'female' ? '👩' : '👤';
        const excludeText = player.isExcluded ? 'Include' : 'Exclude';
        const excludeIcon = player.isExcluded ? '👁️' : '🚫';
        const winRate = player.stats.gamesPlayed > 0 ? Math.round((player.stats.wins / player.stats.gamesPlayed) * 100) : 0;
        const isPriority = player.stats.gamesPlayed === Math.min(...players.map(p => p.stats.gamesPlayed));
        
        return `
          <div class="card ${player.isExcluded ? 'excluded' : ''}">
            <div class="list-item">
              <div class="avatar ${player.gender}">${genderIcon}</div>
              <div class="list-content">
                <div class="list-title">
                  ${player.name}
                  ${isPriority && player.stats.gamesPlayed < 2 ? '<span class="priority-indicator">PRIORITY</span>' : ''}
                </div>
                <div class="list-subtitle">
                  <span class="skill-badge skill-${player.skillLevel}">${skill.name}</span>
                  ${player.gender.charAt(0).toUpperCase() + player.gender.slice(1)}
                </div>
                <div class="stats">
                  Games: ${player.stats.gamesPlayed} • Wins: ${player.stats.wins} • Win Rate: ${winRate}%
                </div>
                ${player.isExcluded ? '<div style="color: #f44336; font-size: 12px; margin-top: 4px;">EXCLUDED FROM MATCHES</div>' : ''}
              </div>
              <div class="player-actions">
                <button class="btn btn-secondary btn-small" onclick="editPlayer(${player.id})" title="Edit">
                  ✏️
                </button>
                <button class="btn btn-secondary btn-small" onclick="togglePlayerExclusion(${player.id})" title="${excludeText}">
                  ${excludeIcon}
                </button>
                <button class="btn btn-secondary btn-small" onclick="removePlayer(${player.id})" title="Remove">
                  🗑️
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Synergy Team Management
    function showSynergyTeamDialog() {
      updateSynergyPlayerOptions();
      document.getElementById('synergy-team-dialog').classList.add('show');
    }

    function hideSynergyTeamDialog() {
      document.getElementById('synergy-team-dialog').classList.remove('show');
      document.getElementById('synergy-player1').value = '';
      document.getElementById('synergy-player2').value = '';
      document.getElementById('synergy-team-name').value = '';
    }

    function updateSynergyPlayerOptions() {
      const player1Select = document.getElementById('synergy-player1');
      const player2Select = document.getElementById('synergy-player2');
      
      const options = players.sort((a, b) => a.name.localeCompare(b.name)).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      
      player1Select.innerHTML = '<option value="">Select Player 1</option>' + options;
      player2Select.innerHTML = '<option value="">Select Player 2</option>' + options;
    }

    function createSynergyTeamFromDialog() {
      const player1Id = parseInt(document.getElementById('synergy-player1').value);
      const player2Id = parseInt(document.getElementById('synergy-player2').value);
      const teamName = document.getElementById('synergy-team-name').value.trim();

      if (!player1Id || !player2Id) {
        alert('Please select both players');
        return;
      }

      if (player1Id === player2Id) {
        alert('Please select different players');
        return;
      }

      const player1 = players.find(p => p.id === player1Id);
      const player2 = players.find(p => p.id === player2Id);

      const finalTeamName = teamName || `${player1.name} & ${player2.name}`;

      const synergyTeam = {
        id: Date.now(),
        player1: player1,
        player2: player2,
        teamName: finalTeamName,
        createdTime: Date.now(),
        isActive: true
      };

      synergyTeams.push(synergyTeam);
      updateSynergyTeamsDisplay();
      hideSynergyTeamDialog();
      saveToStorage();
    }

    function removeSynergyTeam(teamId) {
      if (confirm('Are you sure you want to remove this synergy team?')) {
        synergyTeams = synergyTeams.filter(team => team.id !== teamId);
        updateSynergyTeamsDisplay();
        saveToStorage();
      }
    }

    function toggleSynergyMode() {
      isSynergyModeActive = document.getElementById('synergy-mode-toggle').checked;
      saveToStorage();
    }

    function updateSynergyTeamsDisplay() {
      const container = document.getElementById('synergy-teams-list');
      
      if (synergyTeams.length === 0) {
        container.innerHTML = '<p style="color: rgba(255,255,255,0.7); font-size: 14px;">No synergy teams created</p>';
        return;
      }

      container.innerHTML = synergyTeams.map(team => `
        <div class="synergy-team-card">
          <div class="synergy-header">
            <span class="synergy-badge">SYNERGY</span>
            <span style="font-weight: 600; color: #2E7D32;">${team.teamName}</span>
            <button class="btn btn-secondary btn-small" onclick="removeSynergyTeam(${team.id})" style="margin-left: auto;">
              🗑️
            </button>
          </div>
          <div style="color: #2E7D32; font-size: 14px;">
            👤 ${team.player1.name} & ${team.player2.name}
          </div>
        </div>
      `).join('');
    }

    // Court Management with Visual Display
    function addCourt() {
      const name = prompt('Enter court name:');
      if (name && name.trim()) {
        courts.push(name.trim());
        updateCourtsDisplay();
        saveToStorage();
      }
    }

    function removeCourt(index) {
      if (confirm('Are you sure you want to remove this court?')) {
        courts.splice(index, 1);
        updateCourtsDisplay();
        saveToStorage();
      }
    }

    function updateCourtsDisplay() {
      const container = document.getElementById('courts-list');
      
      container.innerHTML = courts.map((court, index) => `
        <div class="active-match-card">
          <div class="match-header">
            <div class="court-name">${court}</div>
            <div class="match-timer">Available</div>
          </div>
          
          <!-- Enhanced Badminton Court Visualization -->
          <div style="margin: 12px 16px; display: flex; flex-direction: column; align-items: center;">
            <svg viewBox="0 0 624 312" style="width: 100%; height: 260px; max-width: 624px; border-radius: 8px; margin-bottom: 12px;" xmlns="http://www.w3.org/2000/svg">
              <!-- Court background -->
              <rect width="624" height="312" fill="#2E7D32"/>
              
              <!-- Outer court boundary -->
              <rect x="52" y="52" width="520" height="208" fill="none" stroke="white" stroke-width="4"/>
              
              <!-- Center line (net) -->
              <line x1="312" y1="52" x2="312" y2="260" stroke="white" stroke-width="4"/>
              
              <!-- Doubles sidelines -->
              <line x1="78" y1="52" x2="78" y2="260" stroke="white" stroke-width="3"/>
              <line x1="546" y1="52" x2="546" y2="260" stroke="white" stroke-width="3"/>
              
              <!-- Left service courts -->
              <line x1="52" y1="110" x2="312" y2="110" stroke="white" stroke-width="3"/>
              <line x1="52" y1="202" x2="312" y2="202" stroke="white" stroke-width="3"/>
              <line x1="182" y1="110" x2="182" y2="202" stroke="white" stroke-width="3"/>
              
              <!-- Right service courts -->
              <line x1="312" y1="110" x2="572" y2="110" stroke="white" stroke-width="3"/>
              <line x1="312" y1="202" x2="572" y2="202" stroke="white" stroke-width="3"/>
              <line x1="442" y1="110" x2="442" y2="202" stroke="white" stroke-width="3"/>
              
              <!-- Court status text -->
              <text x="312" y="156" text-anchor="middle" font-size="24" font-weight="600" fill="white" opacity="0.9">AVAILABLE</text>
            </svg>
            
            <!-- Remove Court Button -->
            <div style="display: flex; gap: 12px; justify-content: center;">
              <button class="btn btn-secondary" onclick="removeCourt(${index})" style="width: 180px; font-size: 13px; padding: 12px 16px; border-radius: 8px; white-space: nowrap; font-weight: 600;">
                🗑️ Remove Court
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Get truly available players (not excluded, not in queues, not in active matches)
    function getAvailablePlayers() {
      // Get players currently in active matches
      const playersInActiveMatches = new Set();
      activeMatches.forEach(match => {
        match.team1.forEach(player => playersInActiveMatches.add(player.id));
        match.team2.forEach(player => playersInActiveMatches.add(player.id));
      });
      
      // Get players currently in queues
      const playersInQueues = new Set();
      queue.forEach(match => {
        match.team1.forEach(player => playersInQueues.add(player.id));
        match.team2.forEach(player => playersInQueues.add(player.id));
      });
      
      // Filter out excluded players and those already playing/queued
      const availablePlayers = players.filter(player => 
        !player.isExcluded && 
        !playersInActiveMatches.has(player.id) && 
        !playersInQueues.has(player.id)
      );
      
      console.log(`Available players for new queue:`, availablePlayers.map(p => `${p.name}(${p.stats.gamesPlayed}g)`));
      console.log(`Players in active matches:`, Array.from(playersInActiveMatches));
      console.log(`Players in queues:`, Array.from(playersInQueues));
      
      return availablePlayers;
    }

    // Queue Management with Priority and Synergy
    function addToQueue() {
      const availablePlayers = getAvailablePlayers();
      
      if (availablePlayers.length < 4) {
        const busyCount = players.length - availablePlayers.length;
        alert(`⚠️ Not enough available players!\\n\\n` +
              `📊 Available: ${availablePlayers.length}/4 needed\\n` +
              `🔄 Busy (playing/queued): ${busyCount}\\n` +
              `❌ Excluded: ${players.filter(p => p.isExcluded).length}\\n\\n` +
              `💡 Tip: Finish some matches or include more players`);
        return;
      }

      let match;
      
      if (isSynergyModeActive && synergyTeams.length > 0) {
        match = createSynergyMatch(availablePlayers);
      } else {
        match = createBalancedMatch(availablePlayers);
      }

      if (match) {
        queue.push(match);
        updateQueueDisplay();
        updateStandbyPlayersDisplay();
        saveToStorage();
      }
    }

    function createSynergyMatch(availablePlayers) {
      console.log(`Creating synergy match with ${availablePlayers.length} available players`);
      
      // Filter synergy teams to only include those where BOTH players are truly available
      const availableTeams = synergyTeams.filter(team => {
        const player1Available = availablePlayers.some(p => p.id === team.player1.id);
        const player2Available = availablePlayers.some(p => p.id === team.player2.id);
        const teamAvailable = player1Available && player2Available;
        
        console.log(`Synergy team ${team.player1.name} & ${team.player2.name}: ${teamAvailable ? 'AVAILABLE' : 'BUSY'} (P1: ${player1Available}, P2: ${player2Available})`);
        
        return teamAvailable;
      });

      if (availableTeams.length >= 2) {
        // Use two synergy teams
        const team1 = availableTeams[0];
        const team2 = availableTeams[1];
        return {
          id: Date.now(),
          team1: [team1.player1, team1.player2],
          team2: [team2.player1, team2.player2],
          created: new Date().toLocaleTimeString(),
          hasSynergyTeams: true
        };
      } else if (availableTeams.length === 1) {
        // Use one synergy team + two individual players
        const synergyTeam = availableTeams[0];
        const remainingPlayers = availablePlayers.filter(p => 
          p.id !== synergyTeam.player1.id && p.id !== synergyTeam.player2.id
        );
        
        if (remainingPlayers.length >= 2) {
          const synergyTeamMembers = [synergyTeam.player1, synergyTeam.player2];
          
          // For balanced mode, find best skill-balanced opponents
          if (currentMatchType === 'balanced') {
            let bestOpponentPair = null;
            let bestScore = Infinity;
            
            // Try all combinations of remaining players
            for (let i = 0; i < remainingPlayers.length - 1; i++) {
              for (let j = i + 1; j < remainingPlayers.length; j++) {
                const opponentPair = [remainingPlayers[i], remainingPlayers[j]];
                
                if (isMatchBalanced(synergyTeamMembers, opponentPair)) {
                  const score = getMatchBalanceScore(synergyTeamMembers, opponentPair);
                  const totalGames = opponentPair.reduce((sum, p) => sum + p.stats.gamesPlayed, 0);
                  const finalScore = score + totalGames * 0.1;
                  
                  if (finalScore < bestScore) {
                    bestScore = finalScore;
                    bestOpponentPair = opponentPair;
                  }
                }
              }
            }
            
            if (bestOpponentPair) {
              console.log(`✅ Synergy team skill-balanced match found`);
              return {
                id: Date.now(),
                team1: synergyTeamMembers,
                team2: bestOpponentPair,
                created: new Date().toLocaleTimeString(),
                hasSynergyTeams: true
              };
            } else {
              console.log(`❌ No skill-balanced opponents found for synergy team`);
              // Fall through to regular logic
            }
          } else {
            // For non-balanced modes, use games-played priority
            const sortedRemaining = remainingPlayers.sort((a, b) => a.stats.gamesPlayed - b.stats.gamesPlayed);
            return {
              id: Date.now(),
              team1: synergyTeamMembers,
              team2: [sortedRemaining[0], sortedRemaining[1]],
              created: new Date().toLocaleTimeString(),
              hasSynergyTeams: true
            };
          }
        }
      }

      // Fallback to regular balanced match
      return createBalancedMatch(availablePlayers);
    }

    // Skill balancing functions based on Android app logic
    function getSkillOrdinal(skillLevel) {
      return skillLevels[skillLevel].ordinal;
    }

    function getTeamSkillLevel(team) {
      return (getSkillOrdinal(team[0].skillLevel) + getSkillOrdinal(team[1].skillLevel)) / 2.0;
    }

    function isTeamInternallyBalanced(team) {
      const skill1 = getSkillOrdinal(team[0].skillLevel);
      const skill2 = getSkillOrdinal(team[1].skillLevel);
      const skillDifference = Math.abs(skill1 - skill2);
      // Allow up to 3 skill levels difference within teams (relaxed from Android's stricter rules)
      return skillDifference <= 3;
    }

    function isMatchBalanced(team1, team2) {
      // First check: Both teams must be internally balanced
      if (!isTeamInternallyBalanced(team1) || !isTeamInternallyBalanced(team2)) {
        return false;
      }
      
      // Second check: Team averages should be close (within 0.5 skill level)
      const team1Level = getTeamSkillLevel(team1);
      const team2Level = getTeamSkillLevel(team2);
      const teamLevelDifference = Math.abs(team1Level - team2Level);
      
      // Third check: Prevent extreme mismatches
      const team1Max = Math.max(getSkillOrdinal(team1[0].skillLevel), getSkillOrdinal(team1[1].skillLevel));
      const team1Min = Math.min(getSkillOrdinal(team1[0].skillLevel), getSkillOrdinal(team1[1].skillLevel));
      const team2Max = Math.max(getSkillOrdinal(team2[0].skillLevel), getSkillOrdinal(team2[1].skillLevel));
      const team2Min = Math.min(getSkillOrdinal(team2[0].skillLevel), getSkillOrdinal(team2[1].skillLevel));
      
      // CRITICAL: Prevent matches where highest skill player is 3+ levels above lowest skill player
      const overallSkillGap = Math.max(team1Max, team2Max) - Math.min(team1Min, team2Min);
      if (overallSkillGap > 3) {
        console.log(`❌ Extreme skill mismatch detected: ${overallSkillGap} level gap (max allowed: 3)`);
        return false;
      }
      
      return teamLevelDifference <= 0.5;
    }

    function getMatchBalanceScore(team1, team2) {
      const team1Level = getTeamSkillLevel(team1);
      const team2Level = getTeamSkillLevel(team2);
      const teamLevelDifference = Math.abs(team1Level - team2Level);
      
      // Internal team balance penalty
      const team1InternalDiff = Math.abs(getSkillOrdinal(team1[0].skillLevel) - getSkillOrdinal(team1[1].skillLevel));
      const team2InternalDiff = Math.abs(getSkillOrdinal(team2[0].skillLevel) - getSkillOrdinal(team2[1].skillLevel));
      const internalBalancePenalty = (team1InternalDiff + team2InternalDiff) * 0.1;
      
      // Extreme mismatch penalty
      const team1Max = Math.max(getSkillOrdinal(team1[0].skillLevel), getSkillOrdinal(team1[1].skillLevel));
      const team1Min = Math.min(getSkillOrdinal(team1[0].skillLevel), getSkillOrdinal(team1[1].skillLevel));
      const team2Max = Math.max(getSkillOrdinal(team2[0].skillLevel), getSkillOrdinal(team2[1].skillLevel));
      const team2Min = Math.min(getSkillOrdinal(team2[0].skillLevel), getSkillOrdinal(team2[1].skillLevel));
      const overallSkillGap = Math.max(team1Max, team2Max) - Math.min(team1Min, team2Min);
      
      // Heavy penalty for extreme skill gaps
      const extremeMismatchPenalty = overallSkillGap >= 4 ? 10000.0 :  // Elite vs Initiate = massive penalty
                                   overallSkillGap >= 3 ? 1000.0 :    // Elite vs Cadet = very high penalty
                                   overallSkillGap >= 2 ? 100.0 :     // Veteran vs Initiate = high penalty
                                   0.0;
      
      // Base penalty if not balanced
      const balancePenalty = !isMatchBalanced(team1, team2) ? 5000.0 : 0.0;
      
      // Diversity penalty for repeated pairings
      const diversityPenalty = calculateDiversityPenalty(team1, team2);
      
      // Debug logging for diversity
      if (diversityPenalty > 0) {
        console.log(`🎯 Diversity penalty: ${diversityPenalty.toFixed(2)} for match: ${team1[0].name} & ${team1[1].name} vs ${team2[0].name} & ${team2[1].name}`);
      }
      
      return teamLevelDifference + internalBalancePenalty + extremeMismatchPenalty + balancePenalty + diversityPenalty;
    }

    // Diversity and Rotation Logic
    function calculateDiversityPenalty(team1, team2) {
      const allPlayers = [...team1, ...team2];
      let totalPenalty = 0;
      
      // Calculate teammate diversity penalties
      const team1Diversity = getTeammateDiversityScore(team1[0], team1[1]);
      const team2Diversity = getTeammateDiversityScore(team2[0], team2[1]);
      totalPenalty += (1.0 / (team1Diversity + 0.1)) * 10; // Heavily weight teammate diversity
      totalPenalty += (1.0 / (team2Diversity + 0.1)) * 10;
      
      // Calculate opponent diversity penalties
      const team1Opponents = [team2[0].name, team2[1].name];
      const team2Opponents = [team1[0].name, team1[1].name];
      
      const team1OpponentDiversity = getOpponentDiversityScore(team1[0], team1Opponents) + 
                                    getOpponentDiversityScore(team1[1], team1Opponents);
      const team2OpponentDiversity = getOpponentDiversityScore(team2[0], team2Opponents) + 
                                    getOpponentDiversityScore(team2[1], team2Opponents);
      
      totalPenalty += (1.0 / (team1OpponentDiversity + 0.1)) * 5; // Weight opponent diversity
      totalPenalty += (1.0 / (team2OpponentDiversity + 0.1)) * 5;
      
      return totalPenalty;
    }

    function getTeammateDiversityScore(player1, player2) {
      const recentTeammates = player1.matchHistory.recentTeammates || [];
      const teammateIndex = recentTeammates.indexOf(player2.name);
      
      if (teammateIndex === -1) {
        return 10.0; // Never played together = highest diversity
      } else if (teammateIndex >= 7) {
        return 3.0;  // Long ago = good diversity
      } else if (teammateIndex >= 4) {
        return 1.0;  // Medium recent = low diversity
      } else {
        return 0.1;  // Very recent = very low diversity
      }
    }

    function getOpponentDiversityScore(player, opponents) {
      const recentOpponents = player.matchHistory.recentOpponents || [];
      let totalScore = 0;
      
      for (const opponent of opponents) {
        const opponentIndex = recentOpponents.indexOf(opponent);
        
        if (opponentIndex === -1) {
          totalScore += 10.0; // Never played against = highest diversity
        } else if (opponentIndex >= 10) {
          totalScore += 4.0;  // Long ago = good diversity
        } else if (opponentIndex >= 5) {
          totalScore += 2.0;  // Medium recent = medium diversity
        } else {
          totalScore += 0.5;  // Very recent = low diversity
        }
      }
      
      return totalScore / opponents.length; // Average diversity score
    }

    function updatePlayerMatchHistory(match) {
      const team1Players = match.team1;
      const team2Players = match.team2;
      
      // Update teammate history for team 1
      for (const player of team1Players) {
        const otherTeammate = team1Players.find(p => p.id !== player.id);
        if (otherTeammate) {
          if (!player.matchHistory.recentTeammates) {
            player.matchHistory.recentTeammates = [];
          }
          // Add teammate to recent list (remove if already exists, then add to front)
          player.matchHistory.recentTeammates = player.matchHistory.recentTeammates.filter(name => name !== otherTeammate.name);
          player.matchHistory.recentTeammates.unshift(otherTeammate.name);
          // Keep only last 10 teammates
          if (player.matchHistory.recentTeammates.length > 10) {
            player.matchHistory.recentTeammates = player.matchHistory.recentTeammates.slice(0, 10);
          }
        }
        
        // Update opponent history for team 1
        if (!player.matchHistory.recentOpponents) {
          player.matchHistory.recentOpponents = [];
        }
        for (const opponent of team2Players) {
          player.matchHistory.recentOpponents = player.matchHistory.recentOpponents.filter(name => name !== opponent.name);
          player.matchHistory.recentOpponents.unshift(opponent.name);
        }
        // Keep only last 15 opponents
        if (player.matchHistory.recentOpponents.length > 15) {
          player.matchHistory.recentOpponents = player.matchHistory.recentOpponents.slice(0, 15);
        }
      }
      
      // Update teammate history for team 2
      for (const player of team2Players) {
        const otherTeammate = team2Players.find(p => p.id !== player.id);
        if (otherTeammate) {
          if (!player.matchHistory.recentTeammates) {
            player.matchHistory.recentTeammates = [];
          }
          player.matchHistory.recentTeammates = player.matchHistory.recentTeammates.filter(name => name !== otherTeammate.name);
          player.matchHistory.recentTeammates.unshift(otherTeammate.name);
          if (player.matchHistory.recentTeammates.length > 10) {
            player.matchHistory.recentTeammates = player.matchHistory.recentTeammates.slice(0, 10);
          }
        }
        
        // Update opponent history for team 2
        if (!player.matchHistory.recentOpponents) {
          player.matchHistory.recentOpponents = [];
        }
        for (const opponent of team1Players) {
          player.matchHistory.recentOpponents = player.matchHistory.recentOpponents.filter(name => name !== opponent.name);
          player.matchHistory.recentOpponents.unshift(opponent.name);
        }
        if (player.matchHistory.recentOpponents.length > 15) {
          player.matchHistory.recentOpponents = player.matchHistory.recentOpponents.slice(0, 15);
        }
      }
      
      console.log('✅ Updated match history for all players');
    }

    function removeMatchFromPlayerHistory(match) {
      const team1Players = match.team1;
      const team2Players = match.team2;
      
      // Remove teammate history for team 1
      for (const player of team1Players) {
        const otherTeammate = team1Players.find(p => p.id !== player.id);
        if (otherTeammate && player.matchHistory.recentTeammates) {
          player.matchHistory.recentTeammates = player.matchHistory.recentTeammates.filter(name => name !== otherTeammate.name);
        }
        
        // Remove opponent history for team 1
        if (player.matchHistory.recentOpponents) {
          for (const opponent of team2Players) {
            player.matchHistory.recentOpponents = player.matchHistory.recentOpponents.filter(name => name !== opponent.name);
          }
        }
      }
      
      // Remove teammate history for team 2
      for (const player of team2Players) {
        const otherTeammate = team2Players.find(p => p.id !== player.id);
        if (otherTeammate && player.matchHistory.recentTeammates) {
          player.matchHistory.recentTeammates = player.matchHistory.recentTeammates.filter(name => name !== otherTeammate.name);
        }
        
        // Remove opponent history for team 2
        if (player.matchHistory.recentOpponents) {
          for (const opponent of team1Players) {
            player.matchHistory.recentOpponents = player.matchHistory.recentOpponents.filter(name => name !== opponent.name);
          }
        }
      }
      
      console.log('✅ Removed match from player history');
    }

    function findBestSkillBalancedMatch(availablePlayers) {
      if (availablePlayers.length < 4) return null;
      
      let bestMatch = null;
      let bestScore = Infinity;
      
      // Try all possible combinations of 4 players
      for (let i = 0; i < availablePlayers.length - 3; i++) {
        for (let j = i + 1; j < availablePlayers.length - 2; j++) {
          for (let k = j + 1; k < availablePlayers.length - 1; k++) {
            for (let l = k + 1; l < availablePlayers.length; l++) {
              const players = [availablePlayers[i], availablePlayers[j], availablePlayers[k], availablePlayers[l]];
              
              // Try different team combinations
              const combinations = [
                { team1: [players[0], players[1]], team2: [players[2], players[3]] },
                { team1: [players[0], players[2]], team2: [players[1], players[3]] },
                { team1: [players[0], players[3]], team2: [players[1], players[2]] }
              ];
              
              for (const combo of combinations) {
                if (isMatchBalanced(combo.team1, combo.team2)) {
                  const score = getMatchBalanceScore(combo.team1, combo.team2);
                  // Add games played priority (lower total games = better)
                  const totalGames = players.reduce((sum, p) => sum + p.stats.gamesPlayed, 0);
                  const finalScore = score + totalGames * 0.1;
                  
                  if (finalScore < bestScore) {
                    bestScore = finalScore;
                    bestMatch = {
                      id: Date.now(),
                      team1: combo.team1,
                      team2: combo.team2,
                      created: new Date().toLocaleTimeString(),
                      hasSynergyTeams: false
                    };
                  }
                }
              }
            }
          }
        }
      }
      
      if (bestMatch) {
        console.log(`✅ Found skill-balanced match:`, 
          `Team 1: ${bestMatch.team1.map(p => `${p.name}(${skillLevels[p.skillLevel].name})`).join(' & ')} vs `,
          `Team 2: ${bestMatch.team2.map(p => `${p.name}(${skillLevels[p.skillLevel].name})`).join(' & ')}`);
      } else {
        console.log(`❌ No skill-balanced match found with current players`);
      }
      
      return bestMatch;
    }

    function createBalancedMatch(availablePlayers) {
      console.log(`Creating balanced match with ${availablePlayers.length} available players`);
      
      if (availablePlayers.length < 4) {
        alert('Need at least 4 available players to create a match!');
        return null;
      }

      // Sort by priority: least games played first, then by name for consistency
      const prioritizedPlayers = availablePlayers.sort((a, b) => {
        const gamesComparison = a.stats.gamesPlayed - b.stats.gamesPlayed;
        if (gamesComparison !== 0) return gamesComparison;
        return a.name.localeCompare(b.name);
      });

      console.log(`Available players:`, prioritizedPlayers.map(p => `${p.name}(${p.stats.gamesPlayed}g, ${skillLevels[p.skillLevel].name})`));

      // For "balanced" match type, use skill-based balancing
      if (currentMatchType === 'balanced') {
        const skillBalancedMatch = findBestSkillBalancedMatch(prioritizedPlayers);
        if (skillBalancedMatch) {
          return skillBalancedMatch;
        } else {
          alert(`⚠️ No skill-balanced match possible!\\n\\n` +
                `The current players have skill levels that would create\\n` +
                `unfair matches (e.g., Beginners vs Advanced players).\\n\\n` +
                `💡 Try switching to "Mix" mode or add more players\\n` +
                `with intermediate skill levels.`);
          return null;
        }
      }

      // For "mix" and other types, use games-played priority with basic pairing
      let selectedPlayers;
      const zeroGamePlayers = prioritizedPlayers.filter(p => p.stats.gamesPlayed === 0);
      
      if (zeroGamePlayers.length >= 4) {
        selectedPlayers = zeroGamePlayers.slice(0, 4);
      } else if (zeroGamePlayers.length > 0) {
        const playedPlayers = prioritizedPlayers.filter(p => p.stats.gamesPlayed > 0);
        selectedPlayers = [...zeroGamePlayers, ...playedPlayers.slice(0, 4 - zeroGamePlayers.length)];
      } else {
        selectedPlayers = prioritizedPlayers.slice(0, 4);
      }
      
      console.log(`Selected players:`, selectedPlayers.map(p => `${p.name}(${p.stats.gamesPlayed}g, ${skillLevels[p.skillLevel].name})`));
      
      return {
        id: Date.now(),
        team1: [selectedPlayers[0], selectedPlayers[1]],
        team2: [selectedPlayers[2], selectedPlayers[3]],
        created: new Date().toLocaleTimeString(),
        hasSynergyTeams: false
      };
    }

    function startMatch(matchId) {
      const matchIndex = queue.findIndex(m => m.id === matchId);
      if (matchIndex !== -1) {
        const match = queue[matchIndex];
        
        if (courts.length === 0) {
          alert('No courts available! Please add a court first.');
          return;
        }

        // Check if all courts are occupied
        if (activeMatches.length >= courts.length) {
          const courtNames = courts.join(', ');
          const occupiedCount = activeMatches.length;
          
          alert(`⚠️ All courts are currently occupied!\n\n` +
                `📊 Active matches: ${occupiedCount}/${courts.length}\n` +
                `🏸 Courts: ${courtNames}\n\n` +
                `💡 To start a new match:\n` +
                `• Finish a current match by selecting who won\n` +
                `• Or add more courts in the Courts tab`);
          return;
        }

        // Find first available court
        const occupiedCourts = activeMatches.map(m => m.court);
        const availableCourt = courts.find(court => !occupiedCourts.includes(court));
        
        if (!availableCourt) {
          alert('⚠️ No available courts found!');
          return;
        }

        // Move to active matches
        const activeMatch = {
          ...match,
          startTime: Date.now(),
          court: availableCourt
        };
        
        activeMatches.push(activeMatch);
        
        queue.splice(matchIndex, 1);
        updateQueueDisplay();
        updateActiveMatchesDisplay();
        updateStandbyPlayersDisplay();
        saveToStorage();
        
        // Show success message
        console.log(`✅ Match started on ${availableCourt}`);
      }
    }

    // Match Type Functions
    function setMatchType(type) {
      currentMatchType = type;
      
      // Save preference to localStorage
      localStorage.setItem('preferredMatchType', type);
      
      // Update button styles
      document.querySelectorAll('.match-type-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`match-type-${type}`).classList.add('active');
    }



    function completeMatch(match) {
      // Randomly determine winner (in real app, this would be user input)
      const winningTeam = Math.random() < 0.5 ? 1 : 2;
      const winners = winningTeam === 1 ? match.team1 : match.team2;
      const losers = winningTeam === 1 ? match.team2 : match.team1;
      
      // Update winner stats
      winners.forEach(player => {
        const playerInList = players.find(p => p.id === player.id);
        if (playerInList) {
          playerInList.stats.wins += 1;
          playerInList.stats.winRate = playerInList.stats.wins / playerInList.stats.gamesPlayed;
        }
      });

      // Update match history for diversity tracking
      updatePlayerMatchHistory(match);

      const completedMatch = {
        id: Date.now(),
        match: match,
        winningTeam: winningTeam,
        winners: winners,
        losers: losers,
        completedTime: Date.now()
      };

      recentMatches.unshift(completedMatch);
      if (recentMatches.length > 5) {
        recentMatches.pop(); // Keep only last 5
      }

      updatePlayersDisplay();
      updateRecentMatchesDisplay();
      saveToStorage();
    }

    function undoMatch(matchId) {
      const matchIndex = recentMatches.findIndex(m => m.id === matchId);
      if (matchIndex !== -1) {
        const match = recentMatches[matchIndex];
        
        // Reverse the stats changes
        match.match.team1.concat(match.match.team2).forEach(player => {
          const playerInList = players.find(p => p.id === player.id);
          if (playerInList) {
            playerInList.stats.gamesPlayed -= 1;
          }
        });
        
        match.winners.forEach(player => {
          const playerInList = players.find(p => p.id === player.id);
          if (playerInList) {
            playerInList.stats.wins -= 1;
            playerInList.stats.winRate = playerInList.stats.gamesPlayed > 0 ? 
              playerInList.stats.wins / playerInList.stats.gamesPlayed : 0;
          }
        });

        // Remove match from player history (reverse the diversity update)
        removeMatchFromPlayerHistory(match.match);

        recentMatches.splice(matchIndex, 1);
        updatePlayersDisplay();
        updateRecentMatchesDisplay();
        saveToStorage();
        
        alert('Match result has been undone');
      }
    }

    function removeFromQueue(matchId) {
      const matchIndex = queue.findIndex(m => m.id === matchId);
      if (matchIndex !== -1) {
        queue.splice(matchIndex, 1);
        updateQueueDisplay();
        updateStandbyPlayersDisplay();
        saveToStorage();
      }
    }

    function updateQueueDisplay() {
      const container = document.getElementById('queue-list');
      
      if (queue.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">📋</div>
            <h3>No matches in queue</h3>
            <p>Add players first, then create a queue!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = queue.map((match, index) => {
        // Calculate team averages
        const team1Avg = (match.team1[0].stats.gamesPlayed + match.team1[1].stats.gamesPlayed) / 2;
        const team2Avg = (match.team2[0].stats.gamesPlayed + match.team2[1].stats.gamesPlayed) / 2;
        
        return `
          <div class="match-queue-card">
            <div class="queue-header">
              <div style="display: flex; align-items: center; gap: 8px;">
                <div class="queue-number">${index + 1}</div>
                <div class="queue-title">Queue ${index + 1}</div>
                ${match.hasSynergyTeams ? '<span class="synergy-badge">SYNERGY</span>' : ''}
                ${match.isManual ? '<span class="manual-badge" style="background: #9C27B0; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600;">MANUAL</span>' : ''}
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-success btn-small" onclick="startMatch(${match.id})">▶ PLAY</button>
                <button class="btn btn-secondary btn-small" onclick="removeFromQueue(${match.id})">🗑️</button>
              </div>
            </div>
            
            <div class="team-vs-layout">
              <!-- Team 1 -->
              <div class="team-side">
                <div class="team-label" style="color: #0175C2;">Team 1</div>
                <div class="team-avg">Avg. ${team1Avg.toFixed(1)} games</div>
                <div class="team-players">
                  ${match.team1.map(player => {
                    const genderIcon = player.gender === 'male' ? '👨' : player.gender === 'female' ? '👩' : '👤';
                    const bgColor = player.gender === 'male' ? '#0175C2' : player.gender === 'female' ? '#E91E63' : '#9C27B0';
                    const skillLevel = skillLevels[player.skillLevel];
                    return `
                      <div class="player-avatar queue-player-clickable" style="background: ${bgColor};" onclick="showPlayerMenu(${player.id}, ${index}, 1)" title="Click for options">
                        <div style="font-size: 24px; margin-bottom: 4px;">${genderIcon}</div>
                        <div class="player-name">${player.name}</div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.8); margin-top: 2px;">${player.stats.gamesPlayed}g</div>
                        <div class="player-skill" style="font-size: 10px; color: rgba(255,255,255,0.7);">${skillLevel.name}</div>
                        <div class="player-menu-overlay">CLICK</div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
              
              <!-- VS Divider -->
              <div class="vs-divider">VS</div>
              
              <!-- Team 2 -->
              <div class="team-side">
                <div class="team-label" style="color: #E91E63;">Team 2</div>
                <div class="team-avg">Avg. ${team2Avg.toFixed(1)} games</div>
                <div class="team-players">
                  ${match.team2.map(player => {
                    const genderIcon = player.gender === 'male' ? '👨' : player.gender === 'female' ? '👩' : '👤';
                    const bgColor = player.gender === 'male' ? '#0175C2' : player.gender === 'female' ? '#E91E63' : '#9C27B0';
                    const skillLevel = skillLevels[player.skillLevel];
                    return `
                      <div class="player-avatar queue-player-clickable" style="background: ${bgColor};" onclick="showPlayerMenu(${player.id}, ${index}, 2)" title="Click for options">
                        <div style="font-size: 24px; margin-bottom: 4px;">${genderIcon}</div>
                        <div class="player-name">${player.name}</div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.8); margin-top: 2px;">${player.stats.gamesPlayed}g</div>
                        <div class="player-skill" style="font-size: 10px; color: rgba(255,255,255,0.7);">${skillLevel.name}</div>
                        <div class="player-menu-overlay">CLICK</div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function getStandbyPlayers() {
      // Use the same logic as getAvailablePlayers for consistency
      return getAvailablePlayers();
    }

    function updateStandbyPlayersDisplay() {
      const container = document.getElementById('standby-players-list');
      const standbyPlayers = getStandbyPlayers().sort((a, b) => a.name.localeCompare(b.name));
      
      if (standbyPlayers.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 12px; color: rgba(255,255,255,0.7);">
            <div style="font-size: 24px; margin-bottom: 8px;">👥</div>
            <div>No players on standby</div>
            <div style="font-size: 14px;">All players are either in queues or excluded</div>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="color: white; font-weight: 600;">Players on Standby</div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="background: rgba(255,255,255,0.2); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                ${standbyPlayers.length} waiting
              </div>
              <div style="background: rgba(255,255,255,0.2); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                <span style="font-size: 14px;">➕</span>
                <span style="font-size: 10px;">Click to queue</span>
              </div>
            </div>
          </div>
          <div class="standby-players-grid">
            ${standbyPlayers.map(player => {
              const initial = player.name.charAt(0).toUpperCase();
              const bgColor = player.gender === 'male' ? '#0175C2' : player.gender === 'female' ? '#E91E63' : '#9C27B0';
              const skillLevel = skillLevels[player.skillLevel];
              return `
                <div class="standby-player-card" onclick="addPlayerToManualQueue(${player.id})" title="Click to add to manual queue" style="position: relative; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                  <div class="standby-player-avatar" style="background: ${bgColor}; position: relative;">
                    ${initial}
                    <div style="position: absolute; top: -4px; right: -4px; background: #4CAF50; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white;">+</div>
                  </div>
                  <div class="standby-player-name">${player.name}</div>
                  <div class="standby-player-games">${player.stats.gamesPlayed} games</div>
                  <div class="standby-player-skill" style="font-size: 12px; color: #666; margin-top: 2px;">${skillLevel.name}</div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function showPlayerMenu(playerId, queueIndex, teamNumber) {
      const player = players.find(p => p.id === playerId);
      if (!player) return;
      
      // Show clear action selection dialog
      showPlayerActionDialog(player, queueIndex, teamNumber);
    }

    // Global variable to store current action target
    let currentActionTarget = null;

    function showPlayerActionDialog(player, queueIndex, teamNumber) {
      currentActionTarget = { player, queueIndex, teamNumber };
      document.getElementById('action-target-name').textContent = player.name;
      document.getElementById('player-action-dialog').classList.add('show');
    }

    function hidePlayerActionDialog() {
      document.getElementById('player-action-dialog').classList.remove('show');
      currentActionTarget = null;
    }

    function selectPlayerAction(action) {
      if (!currentActionTarget) return;
      
      const { player, queueIndex, teamNumber, isActiveMatch, matchId, playerIndex } = currentActionTarget;
      hidePlayerActionDialog();
      
      if (action === 'replace') {
        if (isActiveMatch) {
          showActiveReplacePlayerDialog(player, matchId, teamNumber, playerIndex);
        } else {
          showReplacePlayerDialog(player, queueIndex, teamNumber);
        }
      } else if (action === 'swap') {
        if (isActiveMatch) {
          showActiveSwapPlayerDialog(player, matchId, teamNumber, playerIndex);
        } else {
          showSwapPlayerDialog(player, queueIndex, teamNumber);
        }
      }
    }

    // Manual Queue Creation - Simple Click-to-Add System
    let manualQueuePlayers = [];

    function addPlayerToManualQueue(playerId) {
      const player = players.find(p => p.id === playerId);
      if (!player) return;

      // Check if player is already in manual queue
      if (manualQueuePlayers.some(p => p.id === playerId)) {
        alert(`${player.name} is already in the manual queue!`);
        return;
      }

      // Add player to manual queue
      manualQueuePlayers.push(player);
      
      console.log(`➕ Added ${player.name} to manual queue (${manualQueuePlayers.length}/4)`);

      // If we have 4 players, create the queue
      if (manualQueuePlayers.length === 4) {
        createManualQueueFromPlayers();
      } else {
        // Show feedback
        const remaining = 4 - manualQueuePlayers.length;
        const playerNames = manualQueuePlayers.map(p => p.name).join(', ');
        
        // Create floating notification
        showManualQueueProgress(playerNames, manualQueuePlayers.length, remaining);
      }
    }

    function createManualQueueFromPlayers() {
      if (manualQueuePlayers.length !== 4) return;

      // Create match with manual selection
      const manualMatch = {
        id: Date.now(),
        team1: [manualQueuePlayers[0], manualQueuePlayers[1]],
        team2: [manualQueuePlayers[2], manualQueuePlayers[3]],
        created: new Date().toLocaleTimeString(),
        hasSynergyTeams: false,
        isManual: true
      };

      // Check for skill balance if in balanced mode
      if (currentMatchType === 'balanced' && !isMatchBalanced(manualMatch.team1, manualMatch.team2)) {
        const confirmed = confirm(`⚠️ Skill Balance Warning!\\n\\n` +
          `This match may be unbalanced:\\n` +
          `Team 1: ${manualMatch.team1.map(p => `${p.name} (${skillLevels[p.skillLevel].name})`).join(' & ')}\\n` +
          `Team 2: ${manualMatch.team2.map(p => `${p.name} (${skillLevels[p.skillLevel].name})`).join(' & ')}\\n\\n` +
          `Do you want to create this match anyway?`);
        
        if (!confirmed) {
          // Reset manual queue
          manualQueuePlayers = [];
          hideManualQueueProgress();
          return;
        }
      }

      // Add to queue
      queue.push(manualMatch);
      updateQueueDisplay();
      updateStandbyPlayersDisplay();
      saveToStorage();

      // Reset manual queue
      manualQueuePlayers = [];
      hideManualQueueProgress();

      console.log(`✅ Manual queue created:`, 
        `Team 1: ${manualMatch.team1.map(p => `${p.name} (${skillLevels[p.skillLevel].name})`).join(' & ')} vs `,
        `Team 2: ${manualMatch.team2.map(p => `${p.name} (${skillLevels[p.skillLevel].name})`).join(' & ')}`);
    }

    function showManualQueueProgress(playerNames, current, remaining) {
      // Create or update floating progress indicator
      let progressDiv = document.getElementById('manual-queue-progress');
      if (!progressDiv) {
        progressDiv = document.createElement('div');
        progressDiv.id = 'manual-queue-progress';
        progressDiv.style.cssText = `
          position: fixed;
          top: 80px;
          right: 20px;
          background: #2196F3;
          color: white;
          padding: 12px 16px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          z-index: 1000;
          max-width: 300px;
          font-size: 14px;
        `;
        document.body.appendChild(progressDiv);
      }

      progressDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <span style="font-size: 16px;">🎯</span>
          <strong>Manual Queue (${current}/4)</strong>
          <button onclick="clearManualQueue()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 12px;">Clear</button>
        </div>
        <div style="font-size: 12px; opacity: 0.9;">
          Selected: ${playerNames}
        </div>
        <div style="font-size: 12px; opacity: 0.7; margin-top: 4px;">
          Need ${remaining} more player${remaining !== 1 ? 's' : ''}
        </div>
      `;
    }

    function hideManualQueueProgress() {
      const progressDiv = document.getElementById('manual-queue-progress');
      if (progressDiv) {
        progressDiv.remove();
      }
    }

    function clearManualQueue() {
      manualQueuePlayers = [];
      hideManualQueueProgress();
      console.log('🗑️ Manual queue cleared');
    }

    // Active match player menu
    function showActivePlayerMenu(playerId, matchId, teamNumber, playerIndex) {
      const player = players.find(p => p.id === playerId);
      if (!player) return;
      
      currentActionTarget = { 
        player, 
        matchId, 
        teamNumber, 
        playerIndex,
        isActiveMatch: true 
      };
      document.getElementById('action-target-name').textContent = player.name;
      document.getElementById('player-action-dialog').classList.add('show');
    }

    // Active match replace functionality
    function showActiveReplacePlayerDialog(targetPlayer, matchId, teamNumber, playerIndex) {
      currentReplaceTarget = { 
        player: targetPlayer, 
        matchId, 
        teamNumber, 
        playerIndex,
        isActiveMatch: true 
      };
      document.getElementById('replace-target-name').textContent = targetPlayer.name;
      
      const standbyPlayers = getStandbyPlayers().sort((a, b) => a.name.localeCompare(b.name));
      const container = document.getElementById('replace-player-list');
      
      if (standbyPlayers.length === 0) {
        container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No standby players available</div>';
      } else {
        container.innerHTML = standbyPlayers.map(player => {
          const initial = player.name.charAt(0).toUpperCase();
          const bgColor = player.gender === 'male' ? '#0175C2' : player.gender === 'female' ? '#E91E63' : '#9C27B0';
          return `
            <div class="card" style="margin-bottom: 8px; cursor: pointer;" onclick="executeActiveReplace(${player.id})">
              <div class="list-item">
                <div class="avatar" style="background: ${bgColor}; width: 36px; height: 36px; font-size: 14px;">
                  ${initial}
                </div>
                <div class="list-content">
                  <div class="list-title">${player.name}</div>
                  <div class="list-subtitle">${player.stats.gamesPlayed} games • ${skillLevels[player.skillLevel].name}</div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      document.getElementById('replace-player-dialog').classList.add('show');
    }

    // Execute replace in active match
    function executeActiveReplace(newPlayerId) {
      if (!currentReplaceTarget || !currentReplaceTarget.isActiveMatch) return;
      
      const newPlayer = players.find(p => p.id === newPlayerId);
      const { player: oldPlayer, matchId, teamNumber, playerIndex } = currentReplaceTarget;
      
      if (!newPlayer) return;
      
      // Find the active match
      const matchIndex = activeMatches.findIndex(m => m.id === matchId);
      if (matchIndex === -1) return;
      
      const match = activeMatches[matchIndex];
      
      // Replace the player
      if (teamNumber === 1) {
        match.team1[playerIndex] = newPlayer;
      } else {
        match.team2[playerIndex] = newPlayer;
      }
      
      updateActiveMatchesDisplay();
      updateStandbyPlayersDisplay();
      saveToStorage();
      hideReplacePlayerDialog();
      
      console.log(`✅ Replaced ${oldPlayer.name} with ${newPlayer.name} in active match`);
    }

    // Active match swap functionality
    function showActiveSwapPlayerDialog(targetPlayer, matchId, teamNumber, playerIndex) {
      currentSwapTarget = { 
        player: targetPlayer, 
        matchId, 
        teamNumber, 
        playerIndex,
        isActiveMatch: true 
      };
      document.getElementById('swap-target-name').textContent = targetPlayer.name;
      
      const matchIndex = activeMatches.findIndex(m => m.id === matchId);
      if (matchIndex === -1) return;
      
      const match = activeMatches[matchIndex];
      
      // Separate teammates and opponents
      const allMatchPlayers = [...match.team1, ...match.team2];
      const otherPlayers = allMatchPlayers.filter(p => p.id !== targetPlayer.id);
      
      const teammates = otherPlayers.filter(player => 
        (teamNumber === 1 && match.team1.includes(player)) || 
        (teamNumber === 2 && match.team2.includes(player))
      ).sort((a, b) => a.name.localeCompare(b.name));
      
      const opponents = otherPlayers.filter(player => 
        (teamNumber === 1 && match.team2.includes(player)) || 
        (teamNumber === 2 && match.team1.includes(player))
      ).sort((a, b) => a.name.localeCompare(b.name));
      
      const container = document.getElementById('swap-player-list');
      
      if (teammates.length === 0 && opponents.length === 0) {
        container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No other players in this match</div>';
      } else {
        let html = '';
        
        // Show teammates (non-clickable, informational only)
        if (teammates.length > 0) {
          html += `
            <div style="margin-bottom: 16px;">
              <div style="font-weight: 600; color: #4CAF50; margin-bottom: 8px; padding: 8px; background: rgba(76, 175, 80, 0.1); border-radius: 6px;">
                👥 Teammate${teammates.length > 1 ? 's' : ''} (Cannot swap)
              </div>
              ${teammates.map(player => {
                const initial = player.name.charAt(0).toUpperCase();
                const bgColor = player.gender === 'male' ? '#0175C2' : player.gender === 'female' ? '#E91E63' : '#9C27B0';
                return `
                  <div class="card" style="margin-bottom: 8px; opacity: 0.6; cursor: not-allowed;">
                    <div class="list-item">
                      <div class="avatar" style="background: ${bgColor}; width: 36px; height: 36px; font-size: 14px;">
                        ${initial}
                      </div>
                      <div class="list-content">
                        <div class="list-title">
                          ${player.name}
                          <span style="font-size: 12px; color: #4CAF50;">(Teammate)</span>
                        </div>
                        <div class="list-subtitle">${player.stats.gamesPlayed} games • ${skillLevels[player.skillLevel].name}</div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }
        
        // Show opponents (clickable for swapping)
        if (opponents.length > 0) {
          html += `
            <div>
              <div style="font-weight: 600; color: #FF9800; margin-bottom: 8px; padding: 8px; background: rgba(255, 152, 0, 0.1); border-radius: 6px;">
                ⚔️ Opponent${opponents.length > 1 ? 's' : ''} (Click to swap)
              </div>
              ${opponents.map(player => {
                const initial = player.name.charAt(0).toUpperCase();
                const bgColor = player.gender === 'male' ? '#0175C2' : player.gender === 'female' ? '#E91E63' : '#9C27B0';
                return `
                  <div class="card" style="margin-bottom: 8px; cursor: pointer; transition: all 0.2s;" onclick="executeActiveSwap(${player.id})" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                    <div class="list-item">
                      <div class="avatar" style="background: ${bgColor}; width: 36px; height: 36px; font-size: 14px;">
                        ${initial}
                      </div>
                      <div class="list-content">
                        <div class="list-title">
                          ${player.name}
                          <span style="font-size: 12px; color: #FF9800;">(Opponent)</span>
                        </div>
                        <div class="list-subtitle">${player.stats.gamesPlayed} games • ${skillLevels[player.skillLevel].name}</div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }
        
        container.innerHTML = html;
      }
      
      document.getElementById('swap-player-dialog').classList.add('show');
    }

    // Execute swap in active match
    function executeActiveSwap(swapWithPlayerId) {
      if (!currentSwapTarget || !currentSwapTarget.isActiveMatch) return;
      
      const swapWithPlayer = players.find(p => p.id === swapWithPlayerId);
      const { player: targetPlayer, matchId, teamNumber, playerIndex } = currentSwapTarget;
      
      if (!swapWithPlayer) return;
      
      const matchIndex = activeMatches.findIndex(m => m.id === matchId);
      if (matchIndex === -1) return;
      
      const match = activeMatches[matchIndex];
      
      // Find positions of both players
      let swapPlayerTeam = 0;
      let swapPlayerIndex = 0;
      
      for (let i = 0; i < match.team1.length; i++) {
        if (match.team1[i].id === swapWithPlayerId) {
          swapPlayerTeam = 1;
          swapPlayerIndex = i;
          break;
        }
      }
      for (let i = 0; i < match.team2.length; i++) {
        if (match.team2[i].id === swapWithPlayerId) {
          swapPlayerTeam = 2;
          swapPlayerIndex = i;
          break;
        }
      }
      
      // Perform the swap
      if (teamNumber === 1) {
        match.team1[playerIndex] = swapWithPlayer;
      } else {
        match.team2[playerIndex] = swapWithPlayer;
      }
      
      if (swapPlayerTeam === 1) {
        match.team1[swapPlayerIndex] = targetPlayer;
      } else {
        match.team2[swapPlayerIndex] = targetPlayer;
      }
      
      updateActiveMatchesDisplay();
      saveToStorage();
      hideSwapPlayerDialog();
      
      console.log(`✅ Swapped ${targetPlayer.name} with ${swapWithPlayer.name} in active match`);
    }

    function showReplacePlayerDialog(targetPlayer, queueIndex, teamNumber) {
      currentReplaceTarget = { player: targetPlayer, queueIndex, teamNumber };
      document.getElementById('replace-target-name').textContent = targetPlayer.name;
      
      const standbyPlayers = getStandbyPlayers().sort((a, b) => a.name.localeCompare(b.name));
      const container = document.getElementById('replace-player-list');
      
      if (standbyPlayers.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #666;">
            <div style="font-size: 24px; margin-bottom: 8px;">😕</div>
            <div>No standby players available</div>
            <div style="font-size: 14px;">All players are currently in queues or excluded</div>
          </div>
        `;
      } else {
        container.innerHTML = standbyPlayers.map(player => {
          const initial = player.name.charAt(0).toUpperCase();
          const bgColor = player.gender === 'male' ? '#0175C2' : player.gender === 'female' ? '#E91E63' : '#9C27B0';
          return `
            <div class="card" style="margin-bottom: 8px; cursor: pointer;" onclick="executeReplace(${player.id})">
              <div class="list-item">
                <div class="avatar" style="background: ${bgColor}; width: 36px; height: 36px; font-size: 14px;">
                  ${initial}
                </div>
                <div class="list-content">
                  <div class="list-title">${player.name}</div>
                  <div class="list-subtitle">${player.stats.gamesPlayed} games • ${skillLevels[player.skillLevel].name}</div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      document.getElementById('replace-player-dialog').classList.add('show');
    }

    function hideReplacePlayerDialog() {
      document.getElementById('replace-player-dialog').classList.remove('show');
      currentReplaceTarget = null;
    }

    function executeReplace(newPlayerId) {
      if (!currentReplaceTarget) return;
      
      // Check if this is an active match replacement
      if (currentReplaceTarget.isActiveMatch) {
        executeActiveReplace(newPlayerId);
        return;
      }
      
      const newPlayer = players.find(p => p.id === newPlayerId);
      const { player: oldPlayer, queueIndex, teamNumber } = currentReplaceTarget;
      
      if (!newPlayer) return;
      
      // Replace the player in the queue
      const match = queue[queueIndex];
      if (teamNumber === 1) {
        // Replace in team 1
        const playerIndex = match.team1.findIndex(p => p.id === oldPlayer.id);
        if (playerIndex !== -1) {
          match.team1[playerIndex] = newPlayer;
        }
      } else {
        // Replace in team 2
        const playerIndex = match.team2.findIndex(p => p.id === oldPlayer.id);
        if (playerIndex !== -1) {
          match.team2[playerIndex] = newPlayer;
        }
      }
      
      updateQueueDisplay();
      updateStandbyPlayersDisplay();
      hideReplacePlayerDialog();
      saveToStorage();
      
      alert(`✅ ${oldPlayer.name} replaced with ${newPlayer.name}`);
    }

    function showSwapPlayerDialog(targetPlayer, queueIndex, teamNumber) {
      currentSwapTarget = { player: targetPlayer, queueIndex, teamNumber };
      document.getElementById('swap-target-name').textContent = targetPlayer.name;
      
      const match = queue[queueIndex];
      
      // Separate teammates and opponents
      const allMatchPlayers = [...match.team1, ...match.team2];
      const otherPlayers = allMatchPlayers.filter(p => p.id !== targetPlayer.id);
      
      const teammates = otherPlayers.filter(player => 
        (teamNumber === 1 && match.team1.includes(player)) || 
        (teamNumber === 2 && match.team2.includes(player))
      ).sort((a, b) => a.name.localeCompare(b.name));
      
      const opponents = otherPlayers.filter(player => 
        (teamNumber === 1 && match.team2.includes(player)) || 
        (teamNumber === 2 && match.team1.includes(player))
      ).sort((a, b) => a.name.localeCompare(b.name));
      
      const container = document.getElementById('swap-player-list');
      
      if (teammates.length === 0 && opponents.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #666;">
            <div style="font-size: 24px; margin-bottom: 8px;">😕</div>
            <div>No players available for swap</div>
          </div>
        `;
      } else {
        let html = '';
        
        // Show teammates (non-clickable, informational only)
        if (teammates.length > 0) {
          html += `
            <div style="margin-bottom: 16px;">
              <div style="font-weight: 600; color: #4CAF50; margin-bottom: 8px; padding: 8px; background: rgba(76, 175, 80, 0.1); border-radius: 6px;">
                👥 Teammate${teammates.length > 1 ? 's' : ''} (Cannot swap)
              </div>
              ${teammates.map(player => {
                const initial = player.name.charAt(0).toUpperCase();
                const bgColor = player.gender === 'male' ? '#0175C2' : player.gender === 'female' ? '#E91E63' : '#9C27B0';
                return `
                  <div class="card" style="margin-bottom: 8px; opacity: 0.6; cursor: not-allowed;">
                    <div class="list-item">
                      <div class="avatar" style="background: ${bgColor}; width: 36px; height: 36px; font-size: 14px;">
                        ${initial}
                      </div>
                      <div class="list-content">
                        <div class="list-title">
                          ${player.name}
                          <span style="font-size: 12px; color: #4CAF50;">(Teammate)</span>
                        </div>
                        <div class="list-subtitle">${player.stats.gamesPlayed} games • ${skillLevels[player.skillLevel].name}</div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }
        
        // Show opponents (clickable for swapping)
        if (opponents.length > 0) {
          html += `
            <div>
              <div style="font-weight: 600; color: #FF9800; margin-bottom: 8px; padding: 8px; background: rgba(255, 152, 0, 0.1); border-radius: 6px;">
                ⚔️ Opponent${opponents.length > 1 ? 's' : ''} (Click to swap)
              </div>
              ${opponents.map(player => {
                const initial = player.name.charAt(0).toUpperCase();
                const bgColor = player.gender === 'male' ? '#0175C2' : player.gender === 'female' ? '#E91E63' : '#9C27B0';
                return `
                  <div class="card" style="margin-bottom: 8px; cursor: pointer; transition: all 0.2s;" onclick="executeSwap(${player.id})" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                    <div class="list-item">
                      <div class="avatar" style="background: ${bgColor}; width: 36px; height: 36px; font-size: 14px;">
                        ${initial}
                      </div>
                      <div class="list-content">
                        <div class="list-title">
                          ${player.name}
                          <span style="font-size: 12px; color: #FF9800;">(Opponent)</span>
                        </div>
                        <div class="list-subtitle">${player.stats.gamesPlayed} games • ${skillLevels[player.skillLevel].name}</div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }
        
        container.innerHTML = html;
      }
      
      document.getElementById('swap-player-dialog').classList.add('show');
    }

    function hideSwapPlayerDialog() {
      document.getElementById('swap-player-dialog').classList.remove('show');
      currentSwapTarget = null;
    }

    function executeSwap(swapWithPlayerId) {
      if (!currentSwapTarget) return;
      
      // Check if this is an active match swap
      if (currentSwapTarget.isActiveMatch) {
        executeActiveSwap(swapWithPlayerId);
        return;
      }
      
      const swapWithPlayer = players.find(p => p.id === swapWithPlayerId);
      const { player: targetPlayer, queueIndex } = currentSwapTarget;
      
      if (!swapWithPlayer) return;
      
      const match = queue[queueIndex];
      
      // Find both players and swap their positions
      const allPlayers = [...match.team1, ...match.team2];
      let targetIndex = -1;
      let swapWithIndex = -1;
      let targetTeam = 0;
      let swapWithTeam = 0;
      
      // Find positions
      match.team1.forEach((player, idx) => {
        if (player.id === targetPlayer.id) {
          targetIndex = idx;
          targetTeam = 1;
        }
        if (player.id === swapWithPlayer.id) {
          swapWithIndex = idx;
          swapWithTeam = 1;
        }
      });
      
      match.team2.forEach((player, idx) => {
        if (player.id === targetPlayer.id) {
          targetIndex = idx;
          targetTeam = 2;
        }
        if (player.id === swapWithPlayer.id) {
          swapWithIndex = idx;
          swapWithTeam = 2;
        }
      });
      
      // Perform the swap
      if (targetTeam === 1 && swapWithTeam === 1) {
        // Both in team 1
        [match.team1[targetIndex], match.team1[swapWithIndex]] = [match.team1[swapWithIndex], match.team1[targetIndex]];
      } else if (targetTeam === 2 && swapWithTeam === 2) {
        // Both in team 2
        [match.team2[targetIndex], match.team2[swapWithIndex]] = [match.team2[swapWithIndex], match.team2[targetIndex]];
      } else if (targetTeam === 1 && swapWithTeam === 2) {
        // Target in team 1, swapWith in team 2
        [match.team1[targetIndex], match.team2[swapWithIndex]] = [match.team2[swapWithIndex], match.team1[targetIndex]];
      } else if (targetTeam === 2 && swapWithTeam === 1) {
        // Target in team 2, swapWith in team 1
        [match.team2[targetIndex], match.team1[swapWithIndex]] = [match.team1[swapWithIndex], match.team2[targetIndex]];
      }
      
      updateQueueDisplay();
      hideSwapPlayerDialog();
      saveToStorage();
      
      alert(`🔄 Swapped ${targetPlayer.name} with ${swapWithPlayer.name}`);
    }

    function selectStandbyPlayer(playerId) {
      const player = players.find(p => p.id === playerId);
      if (player) {
        alert(`Selected: ${player.name}\n\nStandby players can be used to replace players in queues. Click on any player in a queue to replace them with a standby player.`);
      }
    }

    function updateActiveMatchesDisplay() {
      const container = document.getElementById('active-matches-list');
      
      if (activeMatches.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px;">
            <div class="empty-icon">🏸</div>
            <h3>No active matches</h3>
            <p>Start a queue to see live matches!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = activeMatches.map(match => {
        const elapsedTime = Math.floor((Date.now() - match.startTime) / 1000);
        const minutes = Math.floor(elapsedTime / 60);
        const seconds = elapsedTime % 60;
        const timeDisplay = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        return `
          <div class="active-match-card">
            <div class="match-header">
              <div class="court-name">${match.court}</div>
              <div class="match-timer">${timeDisplay}</div>
            </div>
            
            <!-- New Badminton Court Design -->
            <div class="court-container">
              <svg class="court-svg" viewBox="0 0 400 200" xmlns="http://www.w3.org/2000/svg">
                <!-- Court background -->
                <rect width="400" height="200" fill="#4CAF50"/>
                
                <!-- Outer court boundary -->
                <rect x="20" y="20" width="360" height="160" fill="none" stroke="white" stroke-width="3"/>
                
                <!-- Center line (net) -->
                <line x1="200" y1="20" x2="200" y2="180" stroke="white" stroke-width="3"/>
                
                <!-- Doubles sidelines -->
                <line x1="40" y1="20" x2="40" y2="180" stroke="white" stroke-width="2"/>
                <line x1="360" y1="20" x2="360" y2="180" stroke="white" stroke-width="2"/>
                
                <!-- Service court lines -->
                <line x1="20" y1="60" x2="200" y2="60" stroke="white" stroke-width="2"/>
                <line x1="20" y1="140" x2="200" y2="140" stroke="white" stroke-width="2"/>
                <line x1="120" y1="60" x2="120" y2="140" stroke="white" stroke-width="2"/>
                
                <line x1="200" y1="60" x2="380" y2="60" stroke="white" stroke-width="2"/>
                <line x1="200" y1="140" x2="380" y2="140" stroke="white" stroke-width="2"/>
                <line x1="280" y1="60" x2="280" y2="140" stroke="white" stroke-width="2"/>
              </svg>
              
              <!-- Team 1 Players (Left side) -->
              <div class="player-position" style="top: 40px; left: 40px;" onclick="showActivePlayerMenu(${match.team1[0].id}, ${match.id}, 1, 0)">
                <div class="player-card">
                  <div class="player-name">${match.team1[0].name}</div>
                  <div class="player-skill">${skillLevels[match.team1[0].skillLevel].name}</div>
                </div>
              </div>
              
              <div class="player-position" style="top: 40px; right: 40px;" onclick="showActivePlayerMenu(${match.team1[1].id}, ${match.id}, 1, 1)">
                <div class="player-card">
                  <div class="player-name">${match.team1[1].name}</div>
                  <div class="player-skill">${skillLevels[match.team1[1].skillLevel].name}</div>
                </div>
              </div>
              
              <!-- Team 2 Players (Right side) -->
              <div class="player-position" style="bottom: 40px; left: 40px;" onclick="showActivePlayerMenu(${match.team2[0].id}, ${match.id}, 2, 0)">
                <div class="player-card">
                  <div class="player-name">${match.team2[0].name}</div>
                  <div class="player-skill">${skillLevels[match.team2[0].skillLevel].name}</div>
                </div>
              </div>
              
              <div class="player-position" style="bottom: 40px; right: 40px;" onclick="showActivePlayerMenu(${match.team2[1].id}, ${match.id}, 2, 1)">
                <div class="player-card">
                  <div class="player-name">${match.team2[1].name}</div>
                  <div class="player-skill">${skillLevels[match.team2[1].skillLevel].name}</div>
                </div>
              </div>
            </div>
            
            <!-- Winner Selection Buttons -->
            <div class="win-buttons">
              <button class="win-btn team1" onclick="selectWinnerFromActive(${match.id}, 1)">
                Team 1 Wins
              </button>
              <button class="win-btn team2" onclick="selectWinnerFromActive(${match.id}, 2)">
                Team 2 Wins
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Handle winner selection from active matches
    function selectWinnerFromActive(matchId, teamNumber) {
      const matchIndex = activeMatches.findIndex(m => m.id === matchId);
      if (matchIndex !== -1) {
        const match = activeMatches[matchIndex];
        
        const winners = teamNumber === 1 ? match.team1 : match.team2;
        const losers = teamNumber === 1 ? match.team2 : match.team1;
        
        // Update player stats
        match.team1.concat(match.team2).forEach(player => {
          const playerInList = players.find(p => p.id === player.id);
          if (playerInList) {
            playerInList.stats.gamesPlayed += 1;
          }
        });
        
        winners.forEach(player => {
          const playerInList = players.find(p => p.id === player.id);
          if (playerInList) {
            playerInList.stats.wins += 1;
            playerInList.stats.winRate = playerInList.stats.wins / playerInList.stats.gamesPlayed;
          }
        });

        const completedMatch = {
          id: Date.now(),
          match: match,
          winningTeam: teamNumber,
          winners: winners,
          losers: losers,
          completedTime: Date.now()
        };

        // Update match history for diversity tracking
        updatePlayerMatchHistory(match);

        recentMatches.unshift(completedMatch);
        if (recentMatches.length > 5) {
          recentMatches.pop();
        }

        // Remove from active matches
        activeMatches.splice(matchIndex, 1);

        updatePlayersDisplay();
        updateActiveMatchesDisplay();
        updateStandbyPlayersDisplay();
        updateRecentMatchesDisplay();
        updateStatisticsDisplay();
        saveToStorage();
      }
    }

    // Update timers every second
    setInterval(() => {
      if (activeMatches.length > 0) {
        updateActiveMatchesDisplay();
      }
    }, 1000);

    function updateRecentMatchesDisplay() {
      const container = document.getElementById('recent-matches-list');
      
      if (recentMatches.length === 0) {
        container.innerHTML = '<p style="color: rgba(255,255,255,0.7); font-size: 14px;">No recent matches</p>';
        return;
      }

      container.innerHTML = recentMatches.map(match => {
        const timeDiff = Math.floor((Date.now() - match.completedTime) / 60000);
        const timeText = timeDiff < 60 ? 
          (timeDiff < 1 ? 'Just now' : `${timeDiff}m ago`) : 
          (timeDiff < 1440 ? `${Math.floor(timeDiff/60)}h ago` : `${Math.floor(timeDiff/1440)}d ago`);
        
        // Get original team arrangements
        const originalMatch = match.match;
        const team1Players = originalMatch.team1;
        const team2Players = originalMatch.team2;
        
        return `
          <div class="card completed-match" style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.05), inset 0 1px 0 rgba(255, 255, 255, 0.2);">
            <!-- Match Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div style="font-weight: 600; color: #FF9800; font-size: 16px;">
                ${originalMatch.court || 'Court'} - Team ${match.winningTeam} Won
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="color: #666; font-size: 12px;">${timeText}</span>
                <button class="btn btn-secondary btn-small" onclick="editMatchWinner(${match.id})" style="padding: 4px 8px; font-size: 11px;">
                  ✏️ Edit
                </button>
              </div>
            </div>
            
            <!-- Teams Layout -->
            <div style="display: flex; align-items: center; gap: 16px;">
              <!-- Team 1 -->
              <div style="flex: 1; text-align: center;">
                <div style="font-weight: 600; color: #0175C2; margin-bottom: 8px; font-size: 14px;">Team 1</div>
                <div style="font-size: 16px; font-weight: 600; color: #333;">
                  ${team1Players[0].name} & ${team1Players[1].name}
                  ${match.winningTeam === 1 ? ' <span style="color: #FFD700; font-size: 18px;">🏆</span>' : ''}
                </div>
              </div>
              
              <!-- VS Divider -->
              <div style="color: #666; font-weight: 600; font-size: 14px;">VS</div>
              
              <!-- Team 2 -->
              <div style="flex: 1; text-align: center;">
                <div style="font-weight: 600; color: #E91E63; margin-bottom: 8px; font-size: 14px;">Team 2</div>
                <div style="font-size: 16px; font-weight: 600; color: #333;">
                  ${team2Players[0].name} & ${team2Players[1].name}
                  ${match.winningTeam === 2 ? ' <span style="color: #FFD700; font-size: 18px;">🏆</span>' : ''}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Statistics Management
    let currentStatSort = 'wins';

    function sortStats(sortType) {
      currentStatSort = sortType;
      
      // Update button styles
      document.getElementById('sort-wins').className = sortType === 'wins' ? 'btn btn-small' : 'btn btn-secondary btn-small';
      document.getElementById('sort-games').className = sortType === 'games' ? 'btn btn-small' : 'btn btn-secondary btn-small';
      document.getElementById('sort-winrate').className = sortType === 'winrate' ? 'btn btn-small' : 'btn btn-secondary btn-small';
      
      if (sortType === 'wins') {
        document.getElementById('sort-wins').style.background = '#4CAF50';
        document.getElementById('sort-games').style.background = '';
        document.getElementById('sort-winrate').style.background = '';
      } else if (sortType === 'games') {
        document.getElementById('sort-games').style.background = '#4CAF50';
        document.getElementById('sort-wins').style.background = '';
        document.getElementById('sort-winrate').style.background = '';
      } else if (sortType === 'winrate') {
        document.getElementById('sort-winrate').style.background = '#4CAF50';
        document.getElementById('sort-wins').style.background = '';
        document.getElementById('sort-games').style.background = '';
      }
      
      updateStatisticsDisplay();
    }

    function updateStatisticsDisplay() {
      // Update new statistics sections in order
      updateIndividualStatisticsSection();
      updatePairStatisticsSection();
      updateStarPlayerSection();
      updateEncouragementSection();
    }

    // Enhanced Statistics Functions
    function updateIndividualStatisticsSection() {
      const container = document.getElementById('individual-statistics-section');
      
      if (players.length === 0) {
        container.innerHTML = `
          <div class="active-match-card">
            <div class="match-header" style="background: #2196F3;">
              <div class="court-name">👥 Individual Player Statistics</div>
              <div class="match-timer">Player Performance</div>
            </div>
            <div style="padding: 20px; text-align: center;">
              <div class="empty-state">
                <div class="empty-icon">📊</div>
                <h3>No statistics yet</h3>
                <p>Play some matches to see player statistics!</p>
              </div>
            </div>
          </div>
        `;
        return;
      }

      // Sort players based on current sort type
      let sortedPlayers = [...players];
      
      switch (currentStatSort) {
        case 'wins':
          sortedPlayers.sort((a, b) => {
            if (b.stats.wins !== a.stats.wins) return b.stats.wins - a.stats.wins;
            if (b.stats.gamesPlayed !== a.stats.gamesPlayed) return b.stats.gamesPlayed - a.stats.gamesPlayed;
            return b.stats.winRate - a.stats.winRate;
          });
          break;
        case 'games':
          sortedPlayers.sort((a, b) => {
            if (b.stats.gamesPlayed !== a.stats.gamesPlayed) return b.stats.gamesPlayed - a.stats.gamesPlayed;
            if (b.stats.wins !== a.stats.wins) return b.stats.wins - a.stats.wins;
            return b.stats.winRate - a.stats.winRate;
          });
          break;
        case 'winrate':
          sortedPlayers.sort((a, b) => {
            if (Math.abs(b.stats.winRate - a.stats.winRate) > 0.001) return b.stats.winRate - a.stats.winRate;
            if (b.stats.wins !== a.stats.wins) return b.stats.wins - a.stats.wins;
            return b.stats.gamesPlayed - a.stats.gamesPlayed;
          });
          break;
      }

      container.innerHTML = `
        <div class="active-match-card">
          <div class="match-header" style="background: #2196F3;">
            <div class="court-name">👥 Individual Player Statistics</div>
            <div class="match-timer">Player Performance</div>
          </div>
          
          <!-- Sort Options -->
          <div style="margin: 16px; margin-bottom: 8px;">
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="btn btn-small" id="sort-wins" onclick="sortStats('wins')" style="background: ${currentStatSort === 'wins' ? '#4CAF50' : '#666'}; color: white;">Most Wins</button>
              <button class="btn btn-small" id="sort-games" onclick="sortStats('games')" style="background: ${currentStatSort === 'games' ? '#4CAF50' : '#666'}; color: white;">Most Games</button>
              <button class="btn btn-small" id="sort-winrate" onclick="sortStats('winrate')" style="background: ${currentStatSort === 'winrate' ? '#4CAF50' : '#666'}; color: white;">Win Rate</button>
            </div>
          </div>
          
          <div style="padding: 16px; padding-top: 8px;">
            ${sortedPlayers.map((player, index) => {
              const winRate = Math.round(player.stats.winRate * 100);
              const losses = player.stats.gamesPlayed - player.stats.wins;
              
              return `
                <div style="display: flex; flex-direction: column; padding: 16px; border-radius: 16px; background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(12px) saturate(180%); -webkit-backdrop-filter: blur(12px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.18); margin-bottom: 8px; box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.2), 0 2px 8px 0 rgba(0, 0, 0, 0.1); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px 0 rgba(31, 38, 135, 0.3), 0 4px 12px 0 rgba(0, 0, 0, 0.15)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 16px 0 rgba(31, 38, 135, 0.2), 0 2px 8px 0 rgba(0, 0, 0, 0.1)'">
                  <!-- Player Info Row -->
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <div style="font-size: 16px; font-weight: bold; color: #2196F3; min-width: 24px;">#${index + 1}</div>
                    <div style="font-size: 20px;">${player.gender === 'male' ? '👨' : player.gender === 'female' ? '👩' : '👤'}</div>
                    <div style="flex-grow: 1;">
                      <div style="font-weight: 600; color: #424242; font-size: 16px;">${player.name}</div>
                      <div style="font-size: 12px; color: #666; margin-top: 2px;">
                        ${skillLevels[player.skillLevel].name} • ${player.isExcluded ? '🚫 Excluded' : '✅ Active'}
                      </div>
                    </div>
                  </div>
                  <!-- Stats Row -->
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%;">
                    <div style="text-align: center;">
                      <div style="font-size: 16px; font-weight: bold; color: #4CAF50;">${player.stats.wins}</div>
                      <div style="font-size: 10px; color: #666;">WINS</div>
                    </div>
                    <div style="text-align: center;">
                      <div style="font-size: 16px; font-weight: bold; color: #F44336;">${losses}</div>
                      <div style="font-size: 10px; color: #666;">LOSSES</div>
                    </div>
                    <div style="text-align: center;">
                      <div style="font-size: 16px; font-weight: bold; color: #2196F3;">${player.stats.gamesPlayed}</div>
                      <div style="font-size: 10px; color: #666;">GAMES</div>
                    </div>
                    <div style="text-align: center;">
                      <div style="font-size: 16px; font-weight: bold; color: #FF9800;">${winRate}%</div>
                      <div style="font-size: 10px; color: #666;">RATE</div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function updateStarPlayerSection() {
      const container = document.getElementById('star-player-section');
      
      const playersWithGames = players.filter(p => p.stats.gamesPlayed > 0);
      if (playersWithGames.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      // Find all players with the most wins
      const maxWins = Math.max(...playersWithGames.map(p => p.stats.wins));
      const topPlayersByWins = playersWithGames.filter(p => p.stats.wins === maxWins);
      
      // If tied by wins, find those with highest win rate among the tied players
      const maxWinRate = Math.max(...topPlayersByWins.map(p => p.stats.winRate));
      const starPlayers = topPlayersByWins.filter(p => p.stats.winRate === maxWinRate);
      
      container.innerHTML = `
        <div class="active-match-card">
          <div class="match-header" style="background: #FFD700;">
            <div class="court-name" style="color: #000;">⭐ Star Player${starPlayers.length > 1 ? 's' : ''}</div>
            <div class="match-timer" style="color: #000;">Top Performer${starPlayers.length > 1 ? 's' : ''}</div>
          </div>
          <div style="padding: 16px;">
            ${starPlayers.map(player => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-radius: 16px; background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(12px) saturate(180%); -webkit-backdrop-filter: blur(12px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.18); margin-bottom: 8px; box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.2), 0 2px 8px 0 rgba(0, 0, 0, 0.1); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px 0 rgba(31, 38, 135, 0.3), 0 4px 12px 0 rgba(0, 0, 0, 0.15)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 16px 0 rgba(31, 38, 135, 0.2), 0 2px 8px 0 rgba(0, 0, 0, 0.1)'">
                <div style="display: flex; align-items: center; gap: 16px;">
                  <div style="font-size: 24px;">${player.gender === 'male' ? '👨' : player.gender === 'female' ? '👩' : '👤'}</div>
                  <div>
                    <div style="font-weight: 600; color: #424242; font-size: 18px;">${player.name}</div>
                    <div style="font-size: 12px; color: #666; margin-top: 2px;">
                      ${skillLevels[player.skillLevel].name} • ${player.isExcluded ? '🚫 Excluded' : '✅ Active'}
                    </div>
                  </div>
                </div>
                <div style="display: flex; gap: 20px; align-items: center;">
                  <div style="text-align: center;">
                    <div style="font-size: 18px; font-weight: bold; color: #4CAF50;">${player.stats.wins}</div>
                    <div style="font-size: 10px; color: #666;">WINS</div>
                  </div>
                  <div style="text-align: center;">
                    <div style="font-size: 18px; font-weight: bold; color: #2196F3;">${player.stats.gamesPlayed}</div>
                    <div style="font-size: 10px; color: #666;">GAMES</div>
                  </div>
                  <div style="text-align: center;">
                    <div style="font-size: 18px; font-weight: bold; color: #FF9800;">${Math.round(player.stats.winRate * 100)}%</div>
                    <div style="font-size: 10px; color: #666;">WIN RATE</div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function updateEncouragementSection() {
      const container = document.getElementById('encouragement-section');
      
      const playersWithGames = players.filter(p => p.stats.gamesPlayed > 0);
      if (playersWithGames.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      // Find players with most losses
      const playersWithLosses = playersWithGames.map(p => ({
        ...p,
        losses: p.stats.gamesPlayed - p.stats.wins
      })).filter(p => p.losses > 0);
      
      if (playersWithLosses.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      const maxLosses = Math.max(...playersWithLosses.map(p => p.losses));
      const needEncouragement = playersWithLosses.filter(p => p.losses === maxLosses);
      
      container.innerHTML = `
        <div class="active-match-card">
          <div class="match-header" style="background: #FF9800;">
            <div class="court-name">💪 Player${needEncouragement.length > 1 ? 's' : ''} Needing Encouragement</div>
            <div class="match-timer">Keep Going!</div>
          </div>
          <div style="padding: 16px;">
            ${needEncouragement.map(player => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 16px; background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(12px) saturate(180%); -webkit-backdrop-filter: blur(12px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.18); margin-bottom: 8px; box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.2), 0 2px 8px 0 rgba(0, 0, 0, 0.1); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px 0 rgba(31, 38, 135, 0.3), 0 4px 12px 0 rgba(0, 0, 0, 0.15)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 16px 0 rgba(31, 38, 135, 0.2), 0 2px 8px 0 rgba(0, 0, 0, 0.1)'">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="font-size: 20px;">${player.gender === 'male' ? '👨' : player.gender === 'female' ? '👩' : '👤'}</div>
                  <div>
                    <div style="font-weight: 600; color: #424242;">${player.name}</div>
                    <div style="font-size: 12px; color: #666;">${skillLevels[player.skillLevel].name}</div>
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 16px; font-weight: bold; color: #FF9800;">${player.losses} losses</div>
                  <div style="font-size: 12px; color: #666;">${player.stats.wins}W-${player.losses}L</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function calculatePairStatistics() {
      const pairStatsMap = new Map();
      
      recentMatches.forEach(completedMatch => {
        const match = completedMatch.match;
        
        // Process Team 1
        const team1Key = [match.team1[0].name, match.team1[1].name].sort().join('|');
        const team1Won = completedMatch.winningTeam === 1;
        
        if (!pairStatsMap.has(team1Key)) {
          pairStatsMap.set(team1Key, {
            player1: match.team1[0].name,
            player2: match.team1[1].name,
            wins: 0,
            losses: 0,
            gamesPlayed: 0
          });
        }
        
        const team1Stats = pairStatsMap.get(team1Key);
        team1Stats.wins += team1Won ? 1 : 0;
        team1Stats.losses += team1Won ? 0 : 1;
        team1Stats.gamesPlayed += 1;
        
        // Process Team 2
        const team2Key = [match.team2[0].name, match.team2[1].name].sort().join('|');
        const team2Won = completedMatch.winningTeam === 2;
        
        if (!pairStatsMap.has(team2Key)) {
          pairStatsMap.set(team2Key, {
            player1: match.team2[0].name,
            player2: match.team2[1].name,
            wins: 0,
            losses: 0,
            gamesPlayed: 0
          });
        }
        
        const team2Stats = pairStatsMap.get(team2Key);
        team2Stats.wins += team2Won ? 1 : 0;
        team2Stats.losses += team2Won ? 0 : 1;
        team2Stats.gamesPlayed += 1;
      });
      
      return Array.from(pairStatsMap.values()).map(pair => ({
        ...pair,
        winRate: pair.gamesPlayed > 0 ? pair.wins / pair.gamesPlayed : 0
      }));
    }

    function updatePairStatisticsSection() {
      const container = document.getElementById('pair-statistics-section');
      
      const pairStats = calculatePairStatistics();
      if (pairStats.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      // Sort by wins, then by win rate
      const sortedPairs = pairStats.sort((a, b) => {
        if (b.wins !== a.wins) return b.wins - a.wins;
        return b.winRate - a.winRate;
      });
      
      const topPairs = sortedPairs.slice(0, 8);
      
      container.innerHTML = `
        <div class="active-match-card">
          <div class="match-header" style="background: #4CAF50;">
            <div class="court-name">🏆 Pair Statistics</div>
            <div class="match-timer">Best Performing Pairs</div>
          </div>
          <div style="padding: 16px;">
            ${topPairs.map((pair, index) => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 16px; background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(12px) saturate(180%); -webkit-backdrop-filter: blur(12px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.18); margin-bottom: 8px; box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.2), 0 2px 8px 0 rgba(0, 0, 0, 0.1); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px 0 rgba(31, 38, 135, 0.3), 0 4px 12px 0 rgba(0, 0, 0, 0.15)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 16px 0 rgba(31, 38, 135, 0.2), 0 2px 8px 0 rgba(0, 0, 0, 0.1)'">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="font-size: 18px; font-weight: bold; color: #4CAF50; min-width: 24px;">#${index + 1}</div>
                  <div>
                    <div style="font-weight: 600; color: #424242;">${pair.player1} & ${pair.player2}</div>
                    <div style="font-size: 12px; color: #666;">${pair.gamesPlayed} games played</div>
                  </div>
                </div>
                <div style="text-align: right; display: flex; gap: 12px; align-items: center;">
                  <div style="font-size: 14px; font-weight: bold; color: #4CAF50;">${pair.wins}W</div>
                  <div style="font-size: 14px; color: #666;">${pair.losses}L</div>
                  <div style="font-size: 14px; font-weight: bold; color: #2196F3;">${Math.round(pair.winRate * 100)}%</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Settings Functions
    function showClearStatsDialog() {
      document.getElementById('clear-stats-dialog').classList.add('show');
    }

    function hideClearStatsDialog() {
      const dialog = document.getElementById('clear-stats-dialog');
      if (dialog) {
        dialog.classList.remove('show');
        dialog.style.display = 'none';
      }
    }

    function confirmClearStats() {
      console.log('confirmClearStats called');
      
      // Hide dialog FIRST before doing anything else
      const dialog = document.getElementById('clear-stats-dialog');
      if (dialog) {
        console.log('Hiding dialog...');
        dialog.classList.remove('show');
        dialog.style.display = 'none';
        dialog.style.visibility = 'hidden';
      }
      
      // Clear all player statistics but keep player names
      players.forEach(player => {
        player.stats.wins = 0;
        player.stats.gamesPlayed = 0;
        player.stats.winRate = 0;
      });
      
      // Clear match-related data
      recentMatches = [];
      activeMatches = [];
      queue = [];
      
      // Update displays with error handling
      try {
        updatePlayersDisplay();
      } catch (e) { console.log('Error updating players:', e); }
      
      try {
        updateStatisticsDisplay();
      } catch (e) { console.log('Error updating statistics:', e); }
      
      try {
        updateRecentMatchesDisplay();
      } catch (e) { console.log('Error updating recent matches:', e); }
      
      try {
        updateActiveMatchesDisplay();
      } catch (e) { console.log('Error updating active matches:', e); }
      
      try {
        updateQueueDisplay();
      } catch (e) { console.log('Error updating queue:', e); }
      
      try {
        updateStandbyPlayersDisplay();
      } catch (e) { console.log('Error updating standby players:', e); }
      
      // Save data
      saveToStorage();
      
      alert('✅ Player statistics have been cleared!\nPlayer names and information preserved.');
    }

    function showClearAllDataDialog() {
      // Reset checkbox state
      const checkbox = document.getElementById('confirm-clear-all');
      const button = document.getElementById('confirm-clear-all-btn');
      checkbox.checked = false;
      button.disabled = true;
      
      document.getElementById('clear-all-data-dialog').classList.add('show');
    }

    function hideClearAllDataDialog() {
      document.getElementById('clear-all-data-dialog').classList.remove('show');
    }

    function confirmClearAllData() {
      const checkbox = document.getElementById('confirm-clear-all');
      if (!checkbox.checked) {
        alert('Please confirm that you understand this will permanently delete all data.');
        return;
      }
      
      // Clear all application data
      players = [];
      courts = ['Court 1', 'Court 2'];
      queue = [];
      synergyTeams = [];
      isSynergyModeActive = false;
      recentMatches = [];
      activeMatches = [];
      playerIdCounter = 1;
      
      // Clear match history for diversity tracking
      console.log('🗑️ Cleared all match history for diversity tracking');
      
      // Update all displays
      updatePlayersDisplay();
      updateCourtsDisplay();
      updateQueueDisplay();
      updateSynergyTeamsDisplay();
      updateStandbyPlayersDisplay();
      updateRecentMatchesDisplay();
      updateActiveMatchesDisplay();
      updateStatisticsDisplay();
      
      hideClearAllDataDialog();
      saveToStorage();
      
      alert('🗑️ All data has been permanently deleted!\nStarting fresh with a clean slate.');
    }

    function updateStorageInfo() {
      try {
        const data = localStorage.getItem('smashsyndicate_enhanced_data');
        const dataSize = data ? new Blob([data]).size : 0;
        const playerCount = players.length;
        const matchCount = recentMatches.length;
        const synergyCount = synergyTeams.length;
        
        let storageText = `Data stored locally in your browser<br>`;
        storageText += `<small style="color: #666;">`;
        storageText += `${playerCount} players • ${matchCount} recent matches • ${synergyCount} synergy teams<br>`;
        storageText += `Storage used: ${(dataSize / 1024).toFixed(2)} KB`;
        storageText += `</small>`;
        
        const storageElement = document.getElementById('storage-info');
        if (storageElement) {
          storageElement.innerHTML = storageText;
        }
      } catch (error) {
        console.log('Could not calculate storage info:', error);
      }
    }

    async function exportStats() {
      // Safety check for global variables
      if (!players || !Array.isArray(players)) {
        alert('Error: Player data not available. Please refresh the page and try again.');
        return;
      }
      
      if (players.length === 0) {
        alert('No statistics to export!');
        return;
      }
      
        // Show loading state
        const exportButton = document.querySelector('button[onclick="exportStats()"]');
        const originalText = exportButton ? exportButton.textContent : '📊 Export';
        if (exportButton) {
          exportButton.textContent = '⏳ Generating...';
        }
      
      try {
        
        const canvas = await generateStatisticsImage();
        
        // Convert canvas to blob
        canvas.toBlob(async (blob) => {
          if (blob) {
            try {
              // Try to use Web Share API for mobile sharing
              if (navigator.share && navigator.canShare) {
                const file = new File([blob], 'smashsyndicate-statistics.png', { type: 'image/png' });
                
                if (navigator.canShare({ files: [file] })) {
                  await navigator.share({
                    title: 'Smash Syndicate Statistics',
                    text: 'Check out these badminton statistics!',
                    files: [file]
                  });
                  return;
                }
              }
              
              // Fallback: Download the image
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.href = url;
              link.download = `smashsyndicate-stats-${new Date().toISOString().split('T')[0]}.png`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
              
              // Show a subtle success indicator instead of alert
              showSuccessIndicator('📊 Statistics image downloaded successfully!');
              
            } catch (error) {
              console.error('Share failed:', error);
              // Fallback download if sharing completely fails
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.href = url;
              link.download = `smashsyndicate-stats-${new Date().toISOString().split('T')[0]}.png`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
              
              showSuccessIndicator('📊 Statistics image downloaded successfully!');
            }
          }
        }, 'image/png', 0.95);
        
      } catch (error) {
        console.error('Export failed:', error);
        alert('❌ Failed to generate statistics image: ' + error.message + '\n\nPlease try again or refresh the page.');
      } finally {
        // Restore button text
        const button = document.querySelector('button[onclick="exportStats()"]');
        if (button) {
          button.textContent = originalText || '📊 Export';
        }
      }
    }

    async function exportFinance() {
      // Safety check for finance data
      if (!financeData) {
        alert('Error: Finance data not available. Please refresh the page and try again.');
        return;
      }
      
      try {
        // Show loading state
        const exportButton = document.querySelector('button[onclick="exportFinance()"]');
        const originalText = exportButton ? exportButton.textContent : '📊 Export';
        if (exportButton) {
          exportButton.textContent = '⏳ Generating...';
        }
        
        const canvas = await generateFinanceImage();
        
        // Convert canvas to blob
        canvas.toBlob(async (blob) => {
          if (blob) {
            try {
              // Try to use Web Share API for mobile sharing
              if (navigator.share && navigator.canShare) {
                const file = new File([blob], 'smashsyndicate-finance.png', { type: 'image/png' });
                
                if (navigator.canShare({ files: [file] })) {
                  await navigator.share({
                    title: 'Smash Syndicate Finance Report',
                    text: 'Check out this badminton session finance report!',
                    files: [file]
                  });
                  // Restore button text after successful share
                  const button = document.querySelector('button[onclick="exportFinance()"]');
                  if (button) {
                    button.textContent = originalText || '📊 Export';
                  }
                  return;
                }
              }
              
              // Fallback: Download the image
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.href = url;
              link.download = `smashsyndicate-finance-${new Date().toISOString().split('T')[0]}.png`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
              
              // Show a subtle success indicator instead of alert
              showSuccessIndicator('💰 Finance report downloaded successfully!');
              
            } catch (error) {
              console.error('Share failed:', error);
              // Fallback download if sharing completely fails
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.href = url;
              link.download = `smashsyndicate-finance-${new Date().toISOString().split('T')[0]}.png`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
              
              showSuccessIndicator('💰 Finance report downloaded successfully!');
            }
            
            // Restore button text after blob processing is complete
            const button = document.querySelector('button[onclick="exportFinance()"]');
            if (button) {
              button.textContent = originalText || '📊 Export';
            }
          } else {
            // Restore button text if blob creation failed
            const button = document.querySelector('button[onclick="exportFinance()"]');
            if (button) {
              button.textContent = originalText || '📊 Export';
            }
          }
        }, 'image/png', 0.95);
        
      } catch (error) {
        console.error('Export failed:', error);
        alert('❌ Failed to generate finance report: ' + error.message + '\n\nPlease try again or refresh the page.');
        
        // Restore button text on error
        const button = document.querySelector('button[onclick="exportFinance()"]');
        if (button) {
          button.textContent = originalText || '📊 Export';
        }
      }
    }

    // Success indicator function
    function showSuccessIndicator(message) {
      // Create success indicator element
      const indicator = document.createElement('div');
      indicator.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(76, 175, 80, 0.95);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transform: translateX(100%);
        transition: transform 0.3s ease;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      `;
      indicator.textContent = message;
      
      // Add to page
      document.body.appendChild(indicator);
      
      // Animate in
      setTimeout(() => {
        indicator.style.transform = 'translateX(0)';
      }, 100);
      
      // Auto-remove after 3 seconds
      setTimeout(() => {
        indicator.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (indicator.parentNode) {
            indicator.parentNode.removeChild(indicator);
          }
        }, 300);
      }, 3000);
    }

    async function generateStatisticsImage() {
      // Safety checks
      if (!players || !Array.isArray(players)) {
        throw new Error('Player data not available');
      }
      if (!skillLevels || typeof skillLevels !== 'object') {
        throw new Error('Skill level data not available');
      }
      if (!calculatePairStatistics || typeof calculatePairStatistics !== 'function') {
        throw new Error('Pair statistics function not available');
      }
      
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // Set canvas size for high quality - simplified dynamic height
      const width = 800;
      const baseHeight = 600;
      const playerCount = players ? players.length : 0;
      const estimatedHeight = baseHeight + (playerCount * 50) + 800; // Simple estimation
      const height = Math.max(1400, estimatedHeight);
      canvas.width = width;
      canvas.height = height;
      
      // Background
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, width, height);
      
      // Header background
      const headerHeight = 120;
      const gradient = ctx.createLinearGradient(0, 0, width, headerHeight);
      gradient.addColorStop(0, '#2196F3');
      gradient.addColorStop(1, '#1976D2');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, width, headerHeight);
      
      // Title
      ctx.fillStyle = '#FFFFFF';
      ctx.font = 'bold 28px Arial, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('🏸 Smash Syndicate Statistics', width / 2, 40);
      
      // Subtitle with B.E.N highlighted - simplified approach
      ctx.font = '16px Arial, sans-serif';
      const subtitle = 'Badminton Engagement Network';
      ctx.fillText(subtitle, width / 2, 65);
      
      ctx.font = '14px Arial, sans-serif';
      ctx.fillText(`Generated on ${new Date().toLocaleDateString()}`, width / 2, 90);
      
      let yPos = headerHeight + 40;
      
      // Get statistics data with safety checks
      const playersWithGames = players.filter(p => p && p.stats && p.stats.gamesPlayed > 0);
      const sortedPlayers = [...players].sort((a, b) => {
        const aWins = (a && a.stats && a.stats.wins) || 0;
        const bWins = (b && b.stats && b.stats.wins) || 0;
        const aGames = (a && a.stats && a.stats.gamesPlayed) || 0;
        const bGames = (b && b.stats && b.stats.gamesPlayed) || 0;
        
        if (bWins !== aWins) return bWins - aWins;
        return bGames - aGames;
      });
      
      const pairStats = calculatePairStatistics();
      const topPairs = pairStats.sort((a, b) => {
        if (b.wins !== a.wins) return b.wins - a.wins;
        return b.winRate - a.winRate;
      }).slice(0, 5);
      
      // Star Player Section
      if (playersWithGames.length > 0) {
        // Find all players with the most wins
        const maxWins = Math.max(...playersWithGames.map(p => p.stats.wins));
        const topPlayersByWins = playersWithGames.filter(p => p.stats.wins === maxWins);
        
        // If tied by wins, find those with highest win rate among the tied players
        const maxWinRate = Math.max(...topPlayersByWins.map(p => p.stats.winRate));
        const starPlayers = topPlayersByWins.filter(p => p.stats.winRate === maxWinRate);
        
        ctx.fillStyle = '#FFD700';
        ctx.font = 'bold 24px Arial, sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(`⭐ STAR PLAYER${starPlayers.length > 1 ? 'S' : ''}`, 40, yPos);
        yPos += 40;
        
        starPlayers.forEach((starPlayer, index) => {
          // Star player card background
          ctx.fillStyle = '#FFF9C4';
          ctx.fillRect(20, yPos - 10, width - 40, 60);
          ctx.strokeStyle = '#FFD700';
          ctx.lineWidth = 2;
          ctx.strokeRect(20, yPos - 10, width - 40, 60);
          
          ctx.fillStyle = '#424242';
          ctx.font = '20px Arial, sans-serif';
          ctx.fillText(`${starPlayer.name}`, 40, yPos + 15);
          ctx.font = '16px Arial, sans-serif';
          ctx.fillText(`${skillLevels[starPlayer.skillLevel].name} • ${starPlayer.stats.wins} wins • ${Math.round(starPlayer.stats.winRate * 100)}% win rate`, 40, yPos + 35);
          yPos += 80;
        });
      }
      
      // Top Pairs Section
      if (topPairs.length > 0) {
        ctx.fillStyle = '#4CAF50';
        ctx.font = 'bold 24px Arial, sans-serif';
        ctx.fillText('🏆 TOP PERFORMING PAIRS', 40, yPos);
        yPos += 40;
        
        topPairs.slice(0, 5).forEach((pair, index) => {
          // Alternating row background
          if (index % 2 === 0) {
            ctx.fillStyle = '#E8F5E9';
            ctx.fillRect(20, yPos - 15, width - 40, 35);
          }
          
          ctx.fillStyle = '#424242';
          ctx.font = '18px Arial, sans-serif';
          ctx.textAlign = 'left';
          ctx.fillText(`${index + 1}. ${pair.player1} & ${pair.player2}`, 40, yPos);
          
          ctx.textAlign = 'right';
          ctx.fillStyle = '#4CAF50';
          ctx.font = 'bold 16px Arial, sans-serif';
          ctx.fillText(`${pair.wins}W-${pair.losses}L (${Math.round(pair.winRate * 100)}%)`, width - 40, yPos);
          yPos += 35;
        });
        yPos += 20;
      }
      
      // Players Needing Encouragement Section
      const playersWithLosses = playersWithGames.map(p => ({
        ...p,
        losses: p.stats.gamesPlayed - p.stats.wins
      })).filter(p => p.losses > 0);
      
      if (playersWithLosses.length > 0) {
        const maxLosses = Math.max(...playersWithLosses.map(p => p.losses));
        const needEncouragement = playersWithLosses.filter(p => p.losses === maxLosses);
        
        ctx.fillStyle = '#FF9800';
        ctx.font = 'bold 24px Arial, sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(`💪 PLAYER${needEncouragement.length > 1 ? 'S' : ''} NEEDING ENCOURAGEMENT`, 40, yPos);
        yPos += 40;
        
        needEncouragement.forEach((player, index) => {
          // Encouragement card background
          ctx.fillStyle = '#FFF3E0';
          ctx.fillRect(20, yPos - 10, width - 40, 60);
          ctx.strokeStyle = '#FF9800';
          ctx.lineWidth = 2;
          ctx.strokeRect(20, yPos - 10, width - 40, 60);
          
          ctx.fillStyle = '#424242';
          ctx.font = '20px Arial, sans-serif';
          ctx.textAlign = 'left';
          ctx.fillText(`${player.name}`, 40, yPos + 15);
          ctx.font = '16px Arial, sans-serif';
          ctx.fillText(`${skillLevels[player.skillLevel].name} • ${player.losses} losses • ${player.stats.wins}W-${player.losses}L`, 40, yPos + 35);
          yPos += 80;
        });
        yPos += 20;
      }

      // Individual Player Statistics
      if (sortedPlayers.length > 0) {
        ctx.fillStyle = '#2196F3';
        ctx.font = 'bold 24px Arial, sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText('👥 INDIVIDUAL STATISTICS', 40, yPos);
        yPos += 40;
        
        sortedPlayers.forEach((player, index) => {
          const winRate = Math.round(player.stats.winRate * 100);
          const losses = player.stats.gamesPlayed - player.stats.wins;
          
          // Alternating row background
          if (index % 2 === 0) {
            ctx.fillStyle = '#E3F2FD';
            ctx.fillRect(20, yPos - 15, width - 40, 35);
          }
          
          // Rank
          ctx.fillStyle = '#2196F3';
          ctx.font = 'bold 18px Arial, sans-serif';
          ctx.textAlign = 'left';
          ctx.fillText(`#${index + 1}`, 40, yPos);
          
          // Player name
          ctx.fillStyle = '#424242';
          ctx.font = '18px Arial, sans-serif';
          ctx.fillText(`${player.name}`, 80, yPos);
          
          // Skill level
          ctx.fillStyle = '#666666';
          ctx.font = '14px Arial, sans-serif';
          ctx.fillText(`${skillLevels[player.skillLevel].name}`, 80, yPos + 15);
          
          // Stats
          ctx.textAlign = 'right';
          ctx.fillStyle = '#4CAF50';
          ctx.font = 'bold 16px Arial, sans-serif';
          ctx.fillText(`${player.stats.wins}W`, width - 200, yPos);
          
          ctx.fillStyle = '#F44336';
          ctx.fillText(`${losses}L`, width - 150, yPos);
          
          ctx.fillStyle = '#2196F3';
          ctx.fillText(`${player.stats.gamesPlayed}G`, width - 100, yPos);
          
          ctx.fillStyle = '#FF9800';
          ctx.fillText(`${winRate}%`, width - 40, yPos);
          
          yPos += 35;
        });
      }
      
      // Footer
      yPos = height - 60;
      ctx.fillStyle = '#666666';
      ctx.font = '16px Arial, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('Generated by Smash Syndicate', width / 2, yPos);
      ctx.fillText('🏸 Badminton Engagement Network', width / 2, yPos + 25);
      
      return canvas;
    }

    async function generateFinanceImage() {
      // Safety checks
      if (!financeData) {
        throw new Error('Finance data not available');
      }
      
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // Set canvas size
      const width = 800;
      const height = 1000;
      canvas.width = width;
      canvas.height = height;
      
      // Background
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, width, height);
      
      // Header background
      const headerHeight = 120;
      const gradient = ctx.createLinearGradient(0, 0, width, headerHeight);
      gradient.addColorStop(0, '#1976D2');
      gradient.addColorStop(1, '#1565C0');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, width, headerHeight);
      
      // Title
      ctx.fillStyle = '#FFFFFF';
      ctx.font = 'bold 28px Arial, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('💰 Smash Syndicate Finance Report', width / 2, 40);
      
      // Subtitle
      ctx.font = '16px Arial, sans-serif';
      ctx.fillText('Session Cost Breakdown & Payment Tracking', width / 2, 70);
      
      // Date
      ctx.font = '14px Arial, sans-serif';
      ctx.fillText(new Date().toLocaleDateString(), width / 2, 95);
      
      let yPos = 160;
      
      // Cost Breakdown Section
      ctx.fillStyle = '#1976D2';
      ctx.font = 'bold 20px Arial, sans-serif';
      ctx.textAlign = 'left';
      ctx.fillText('📊 Cost Breakdown', 40, yPos);
      yPos += 40;
      
      // Court Fee
      const courtFee = parseFloat(financeData.courtFeePerHour || 0) * parseFloat(financeData.hoursPlayed || 0) * parseFloat(financeData.numberOfCourts || 0);
      ctx.fillStyle = '#333333';
      ctx.font = '16px Arial, sans-serif';
      ctx.fillText('🏸 Court Fee:', 40, yPos);
      ctx.textAlign = 'right';
      ctx.fillText(`₱${courtFee.toFixed(2)}`, width - 40, yPos);
      ctx.textAlign = 'left';
      yPos += 25;
      
      // Court fee breakdown
      ctx.font = '12px Arial, sans-serif';
      ctx.fillStyle = '#666666';
      ctx.fillText(`₱${financeData.courtFeePerHour || 0} × ${financeData.hoursPlayed || 0} hrs × ${financeData.numberOfCourts || 0} courts`, 60, yPos);
      yPos += 30;
      
      // Shuttlecock Cost
      const shuttlecockCost = parseFloat(financeData.shuttlecockPrice || 0) * parseFloat(financeData.shuttlecocksUsed || 0);
      ctx.font = '16px Arial, sans-serif';
      ctx.fillStyle = '#333333';
      ctx.fillText('🏸 Shuttlecocks:', 40, yPos);
      ctx.textAlign = 'right';
      ctx.fillText(`₱${shuttlecockCost.toFixed(2)}`, width - 40, yPos);
      ctx.textAlign = 'left';
      yPos += 25;
      
      // Shuttlecock breakdown
      ctx.font = '12px Arial, sans-serif';
      ctx.fillStyle = '#666666';
      ctx.fillText(`₱${financeData.shuttlecockPrice || 0} × ${financeData.shuttlecocksUsed || 0} pieces`, 60, yPos);
      yPos += 40;
      
      // Total Cost
      const totalCost = courtFee + shuttlecockCost;
      ctx.font = 'bold 18px Arial, sans-serif';
      ctx.fillStyle = '#1976D2';
      ctx.fillText('Total Cost:', 40, yPos);
      ctx.textAlign = 'right';
      ctx.fillText(`₱${totalCost.toFixed(2)}`, width - 40, yPos);
      ctx.textAlign = 'left';
      yPos += 50;
      
      // Cost per Player
      const activePlayers = players.filter(p => !p.isExcluded).length;
      const costPerPlayer = activePlayers > 0 ? totalCost / activePlayers : 0;
      ctx.font = 'bold 16px Arial, sans-serif';
      ctx.fillStyle = '#FF9800';
      ctx.fillText('Cost per Player:', 40, yPos);
      ctx.textAlign = 'right';
      ctx.fillText(`₱${costPerPlayer.toFixed(2)}`, width - 40, yPos);
      ctx.textAlign = 'left';
      yPos += 50;
      
      // Payment Tracking Section
      ctx.fillStyle = '#1976D2';
      ctx.font = 'bold 20px Arial, sans-serif';
      ctx.fillText('💳 Payment Tracking', 40, yPos);
      yPos += 40;
      
      // Players who have paid
      const paidPlayerNames = Array.from(financeData.playersPaid || []);
      const paidPlayers = players.filter(p => !p.isExcluded && paidPlayerNames.includes(p.name));
      const unpaidPlayers = players.filter(p => !p.isExcluded && !paidPlayerNames.includes(p.name));
      
      // Payment method icons for export
      const getPaymentIcon = (method) => {
        switch(method) {
          case 'Cash': return '💵';
          case 'Bank Transfer': return '🏦';
          case 'GCash': return '📱'; // Using emoji for canvas compatibility
          case 'PayMaya': return '💳'; // Using emoji for canvas compatibility
          default: return '💳';
        }
      };
      
      ctx.font = 'bold 16px Arial, sans-serif';
      ctx.fillStyle = '#4CAF50';
      ctx.fillText(`✅ Paid (${paidPlayers.length}):`, 40, yPos);
      yPos += 25;
      
              if (paidPlayers.length > 0) {
          ctx.font = '14px Arial, sans-serif';
          ctx.fillStyle = '#333333';
          const paidPlayerData = paidPlayers.map(p => ({
            name: p.name,
            method: financeData.paymentMethods.get(p.name) || 'Unknown'
          }));
          
          // Create a cleaner column layout
          const maxNamesPerRow = 3; // Reduced to 3 to accommodate payment method
          const nameWidth = 200;
          const nameHeight = 25;
          const startX = 60;
          
          paidPlayerData.forEach((player, index) => {
            const row = Math.floor(index / maxNamesPerRow);
            const col = index % maxNamesPerRow;
            const x = startX + (col * nameWidth);
            const y = yPos + (row * nameHeight);
            
            ctx.fillText(`• ${player.name}`, x, y);
            ctx.font = '12px Arial, sans-serif';
            ctx.fillStyle = '#666666';
            ctx.fillText(`  ${getPaymentIcon(player.method)} ${player.method}`, x, y + 15);
            ctx.font = '14px Arial, sans-serif';
            ctx.fillStyle = '#333333';
          });
          
          yPos += Math.ceil(paidPlayerData.length / maxNamesPerRow) * nameHeight + 20;
        } else {
        ctx.font = '14px Arial, sans-serif';
        ctx.fillStyle = '#666666';
        ctx.fillText('No payments recorded yet', 60, yPos);
        yPos += 40;
      }
      
      // Players who haven't paid
      ctx.font = 'bold 16px Arial, sans-serif';
      ctx.fillStyle = '#F44336';
      ctx.fillText(`❌ Unpaid (${unpaidPlayers.length}):`, 40, yPos);
      yPos += 25;
      
      if (unpaidPlayers.length > 0) {
        ctx.font = '14px Arial, sans-serif';
        ctx.fillStyle = '#333333';
        const unpaidPlayerNames = unpaidPlayers.map(p => p.name);
        
        // Create a cleaner column layout
        const maxNamesPerRow = 4;
        const nameWidth = 150;
        const nameHeight = 20;
        const startX = 60;
        
        unpaidPlayerNames.forEach((name, index) => {
          const row = Math.floor(index / maxNamesPerRow);
          const col = index % maxNamesPerRow;
          const x = startX + (col * nameWidth);
          const y = yPos + (row * nameHeight);
          
          ctx.fillText(`• ${name}`, x, y);
        });
        
        yPos += Math.ceil(unpaidPlayerNames.length / maxNamesPerRow) * nameHeight + 20;
      } else {
        ctx.font = '14px Arial, sans-serif';
        ctx.fillStyle = '#666666';
        ctx.fillText('All players have paid!', 60, yPos);
        yPos += 40;
      }
      
      // Summary
      yPos += 20;
      ctx.fillStyle = '#1976D2';
      ctx.font = 'bold 16px Arial, sans-serif';
      ctx.fillText('📋 Summary:', 40, yPos);
      yPos += 25;
      
      ctx.font = '14px Arial, sans-serif';
      ctx.fillStyle = '#333333';
      ctx.fillText(`• Total Session Cost: ₱${totalCost.toFixed(2)}`, 60, yPos);
      yPos += 20;
      ctx.fillText(`• Cost per Player: ₱${costPerPlayer.toFixed(2)}`, 60, yPos);
      yPos += 20;
      ctx.fillText(`• Players Paid: ${paidPlayers.length}/${activePlayers}`, 60, yPos);
      yPos += 20;
      ctx.fillText(`• Outstanding Amount: ₱${(costPerPlayer * unpaidPlayers.length).toFixed(2)}`, 60, yPos);
      
      // Footer
      yPos = height - 60;
      ctx.fillStyle = '#666666';
      ctx.font = '16px Arial, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('Generated by Smash Syndicate', width / 2, yPos);
      ctx.fillText('🏸 Badminton Engagement Network', width / 2, yPos + 25);
      
      return canvas;
    }

    // Tournament Management
    function createTournament() {
      alert('🏆 Tournament Creation\n\nFeatures coming soon:\n• Bracket generation\n• Match scheduling\n• Championship tracking\n• Player seeding\n• Result recording');
    }

    // Storage
    function saveToStorage() {
      const data = {
        players,
        courts,
        queue,
        synergyTeams,
        isSynergyModeActive,
        recentMatches,
        activeMatches,
        playerIdCounter,
        financeData: {
          ...financeData,
          playersPaid: Array.from(financeData.playersPaid),
          paymentMethods: Array.from(financeData.paymentMethods.entries())
        },
        version: '3.0'
      };
      

      
      localStorage.setItem('smashsyndicate_enhanced_data', JSON.stringify(data));
      
      // Update storage info if settings tab is active
      if (activeTab === 'settings') {
        updateStorageInfo();
      }
    }

    function loadFromStorage() {
      try {
        const data = localStorage.getItem('smashsyndicate_enhanced_data');
        if (data) {
          const parsed = JSON.parse(data);
          players = parsed.players || [];
          courts = parsed.courts || ['Court 1', 'Court 2'];
          queue = parsed.queue || [];
          synergyTeams = parsed.synergyTeams || [];
          isSynergyModeActive = parsed.isSynergyModeActive || false;
          recentMatches = parsed.recentMatches || [];
          activeMatches = parsed.activeMatches || [];
          playerIdCounter = parsed.playerIdCounter || Math.max(...players.map(p => p.id), 0) + 1;
          
          // Load preferred match type
          const savedMatchType = localStorage.getItem('preferredMatchType');
          if (savedMatchType) {
            // Handle deprecated 'gender' match type by converting to 'balanced'
            if (savedMatchType === 'gender') {
              currentMatchType = 'balanced';
              localStorage.setItem('preferredMatchType', 'balanced');
              console.log('Converted deprecated "gender" match type to "balanced"');
            } else {
              currentMatchType = savedMatchType;
            }
            
            // Update UI to reflect saved preference
            document.querySelectorAll('.match-type-btn').forEach(btn => {
              btn.classList.remove('active');
            });
            const matchTypeBtn = document.getElementById(`match-type-${currentMatchType}`);
            if (matchTypeBtn) {
              matchTypeBtn.classList.add('active');
            }
          }
          
          // Load finance data
          if (parsed.financeData) {
            financeData = {
              ...parsed.financeData,
              playersPaid: new Set(parsed.financeData.playersPaid || []),
              paymentMethods: new Map(parsed.financeData.paymentMethods || [])
            };
            
            // Restore finance input values
            document.getElementById('court-fee-per-hour').value = financeData.courtFeePerHour || '';
            document.getElementById('hours-played').value = financeData.hoursPlayed || '';
            document.getElementById('number-of-courts').value = financeData.numberOfCourts || '';
            document.getElementById('shuttlecock-price').value = financeData.shuttlecockPrice || '';
            document.getElementById('shuttlecocks-used').value = financeData.shuttlecocksUsed || '';
            
            updateFinanceCalculations();
          }
          
          document.getElementById('synergy-mode-toggle').checked = isSynergyModeActive;
          
                  updatePlayersDisplay();
        updateCourtsDisplay();
        updateQueueDisplay();
        updateSynergyTeamsDisplay();
        updateStandbyPlayersDisplay();
        updateRecentMatchesDisplay();
        updateActiveMatchesDisplay();
        updateStatisticsDisplay();
        }
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    // PWA Functions
    function showInstallInfo() {
      alert('📱 Install SmashSyndicate\n\nInstall methods:\n• Chrome: Look for install icon in address bar\n• Chrome Menu → More tools → Create shortcut\n• Edge Menu → Apps → Install this site\n• Mobile: Share menu → Add to Home Screen\n\n✅ Works offline\n✅ Fast loading\n✅ App-like experience');
    }

    // Service Worker
    if ('serviceWorker' in navigator) {
      const swCode = `
        const CACHE_NAME = 'smash-syndicate-enhanced-v1';
        const urlsToCache = ['./', './index.html'];
        
        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
          );
        });
        
        self.addEventListener('fetch', event => {
          event.respondWith(
            caches.match(event.request).then(response => 
              response || fetch(event.request)
            )
          );
        });
      `;
      
      const blob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(blob);
      
      navigator.serviceWorker.register(swUrl)
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed'));
    }

    // Close dialogs when clicking outside
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('dialog-overlay')) {
        hideAddPlayerDialog();
        hideSynergyTeamDialog();
        hideReplacePlayerDialog();
        hideSwapPlayerDialog();
        hideClearStatsDialog();
        hideClearAllDataDialog();
      }
    });

    // Handle checkbox for clear all data confirmation
    document.addEventListener('DOMContentLoaded', () => {
      const checkbox = document.getElementById('confirm-clear-all');
      const button = document.getElementById('confirm-clear-all-btn');
      
      if (checkbox && button) {
        checkbox.addEventListener('change', () => {
          button.disabled = !checkbox.checked;
        });
      }
    });

    // Finance Management Functions
    function updateFinanceCalculations() {
      const courtFeePerHour = parseFloat(document.getElementById('court-fee-per-hour').value) || 0;
      const hoursPlayed = parseInt(document.getElementById('hours-played').value) || 0;
      const numberOfCourts = parseInt(document.getElementById('number-of-courts').value) || 0;
      const shuttlecockPrice = parseFloat(document.getElementById('shuttlecock-price').value) || 0;
      const shuttlecocksUsed = parseInt(document.getElementById('shuttlecocks-used').value) || 0;

      // Update finance data
      financeData.courtFeePerHour = courtFeePerHour;
      financeData.hoursPlayed = hoursPlayed;
      financeData.numberOfCourts = numberOfCourts;
      financeData.shuttlecockPrice = shuttlecockPrice;
      financeData.shuttlecocksUsed = shuttlecocksUsed;

      // Calculate totals
      const totalCourtFee = courtFeePerHour * hoursPlayed * numberOfCourts;
      const totalShuttlecockCost = shuttlecockPrice * shuttlecocksUsed;
      const totalCost = totalCourtFee + totalShuttlecockCost;
      const costPerPlayer = players.length > 0 ? Math.ceil((totalCost / players.length) * 100) / 100 : 0;

      // Update breakdown displays
      document.getElementById('court-fee-breakdown').textContent = `₱${courtFeePerHour} × ${hoursPlayed} hrs × ${numberOfCourts} courts`;
      document.getElementById('total-court-fee').textContent = `₱${totalCourtFee.toFixed(2)}`;
      document.getElementById('shuttlecock-breakdown').textContent = `₱${shuttlecockPrice.toFixed(2)} × ${shuttlecocksUsed} pieces`;
      document.getElementById('total-shuttlecock-cost').textContent = `₱${totalShuttlecockCost.toFixed(2)}`;
      document.getElementById('total-cost').textContent = `₱${totalCost.toFixed(2)}`;
      document.getElementById('cost-per-player').textContent = `₱${costPerPlayer.toFixed(2)}`;

      updatePlayerPaymentList();
      saveToStorage();
    }

    function updatePlayerPaymentList() {
      const container = document.getElementById('player-payment-list');
      const costPerPlayer = players.length > 0 ? Math.ceil((getTotalCost() / players.length) * 100) / 100 : 0;

      if (players.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #666;">
            <div style="font-size: 24px; margin-bottom: 8px;">👥</div>
            <div>No players registered yet</div>
            <div style="font-size: 12px;">Add players to track payments</div>
          </div>
        `;
        document.getElementById('payment-summary').textContent = '0/0 paid';
        return;
      }

      const paidPlayers = financeData.playersPaid.size;
      const totalPlayers = players.length;

      container.innerHTML = players.sort((a, b) => a.name.localeCompare(b.name)).map(player => {
        const isPaid = financeData.playersPaid.has(player.name);
        const paymentMethod = financeData.paymentMethods.get(player.name);
        const initial = player.name.charAt(0).toUpperCase();
        const bgColor = player.gender === 'male' ? '#0175C2' : player.gender === 'female' ? '#E91E63' : '#9C27B0';

        // Payment method icons
        const getPaymentIcon = (method) => {
          switch(method) {
            case 'Cash': return '💵';
            case 'Bank Transfer': return '🏦';
            case 'GCash': return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="4" fill="#0066CC"/><path d="M7 8h10v8H7V8zm2 2v4h6v-4H9z" fill="white"/><circle cx="12" cy="12" r="1.5" fill="#0066CC"/></svg>';
            case 'PayMaya': return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="4" fill="#00A3E0"/><path d="M6 8h12v8H6V8zm2 2v4h8v-4H8z" fill="white"/><rect x="10" y="10" width="4" height="2" fill="#00A3E0"/></svg>';
            default: return '💳';
          }
        };

        return `
          <div class="card" style="margin-bottom: 8px; cursor: pointer; ${isPaid ? 'background: rgba(76, 175, 80, 0.1); border: 2px solid #4CAF50;' : 'background: white; border: 2px solid #eee;'}" onclick="togglePlayerPayment('${player.name}')">
            <div class="list-item">
              <div class="avatar" style="background: ${bgColor}; width: 40px; height: 40px; font-size: 16px;">
                ${initial}
              </div>
              <div class="list-content">
                <div class="list-title" style="display: flex; align-items: center; gap: 8px;">
                  ${player.name}
                  ${isPaid ? '<span style="color: #4CAF50; font-size: 16px;">✓</span>' : '<span style="color: #FF9800; font-size: 16px;">○</span>'}
                </div>
                <div class="list-subtitle">
                  ₱${costPerPlayer.toFixed(2)} 
                  ${isPaid ? `(Paid via ${getPaymentIcon(paymentMethod)} ${paymentMethod})` : '(Pending)'}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('payment-summary').textContent = `${paidPlayers}/${totalPlayers} paid`;
      
      // Update summary color based on payment status
      const summaryElement = document.getElementById('payment-summary');
      const summaryContainer = summaryElement.parentElement;
      if (paidPlayers === totalPlayers && totalPlayers > 0) {
        summaryContainer.style.background = 'rgba(76, 175, 80, 0.1)';
        summaryElement.style.color = '#4CAF50';
      } else {
        summaryContainer.style.background = 'rgba(255, 152, 0, 0.1)';
        summaryElement.style.color = '#FF9800';
      }
    }

    function getTotalCost() {
      const totalCourtFee = financeData.courtFeePerHour * financeData.hoursPlayed * financeData.numberOfCourts;
      const totalShuttlecockCost = financeData.shuttlecockPrice * financeData.shuttlecocksUsed;
      return totalCourtFee + totalShuttlecockCost;
    }

    function togglePlayerPayment(playerName) {
      if (financeData.playersPaid.has(playerName)) {
        // Remove payment
        financeData.playersPaid.delete(playerName);
        financeData.paymentMethods.delete(playerName);
      } else {
        // Add payment with method selection
        showPaymentMethodDialog(playerName);
        return; // Don't update yet, wait for method selection
      }
      updatePlayerPaymentList();
      saveToStorage();
    }

    function showPaymentMethodDialog(playerName) {
      const methods = ['Cash', 'Bank Transfer', 'GCash', 'PayMaya'];
      
      // Create modal dialog
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        text-align: center;
      `;
      
      dialog.innerHTML = `
        <div style="font-size: 20px; font-weight: bold; color: #1976D2; margin-bottom: 16px;">
          💳 Select Payment Method
        </div>
        <div style="color: #666; margin-bottom: 24px;">
          for ${playerName}
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
          ${methods.map(method => `
            <button onclick="selectPaymentMethod('${playerName}', '${method}')" style="
              padding: 16px;
              border: 2px solid #e0e0e0;
              border-radius: 12px;
              background: white;
              color: #333;
              font-size: 16px;
              font-weight: 500;
              cursor: pointer;
              transition: all 0.2s ease;
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 8px;
            " onmouseover="this.style.borderColor='#1976D2'; this.style.background='#f5f5f5'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
              <div style="font-size: 24px; ${method === 'GCash' ? 'color: #0066CC;' : method === 'PayMaya' ? 'color: #00A3E0;' : ''}">
                ${method === 'Cash' ? '💵' : method === 'Bank Transfer' ? '🏦' : method === 'GCash' ? '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="4" fill="#0066CC"/><path d="M7 8h10v8H7V8zm2 2v4h6v-4H9z" fill="white"/><circle cx="12" cy="12" r="1.5" fill="#0066CC"/></svg>' : '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="4" fill="#00A3E0"/><path d="M6 8h12v8H6V8zm2 2v4h8v-4H8z" fill="white"/><rect x="10" y="10" width="4" height="2" fill="#00A3E0"/></svg>'}
              </div>
              <div style="${method === 'GCash' ? 'color: #0066CC; font-weight: bold;' : method === 'PayMaya' ? 'color: #00A3E0; font-weight: bold;' : ''}">${method}</div>
            </button>
          `).join('')}
        </div>
        <button onclick="closePaymentDialog()" style="
          padding: 12px 24px;
          border: none;
          border-radius: 8px;
          background: #f5f5f5;
          color: #666;
          font-size: 16px;
          cursor: pointer;
          transition: background 0.2s ease;
        " onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='#f5f5f5'">
          Cancel
        </button>
      `;
      
      modal.appendChild(dialog);
      document.body.appendChild(modal);
    }

    function selectPaymentMethod(playerName, method) {
      financeData.playersPaid.add(playerName);
      financeData.paymentMethods.set(playerName, method);
      updatePlayerPaymentList();
      saveToStorage();
      closePaymentDialog();
    }

    function closePaymentDialog() {
      const modal = document.querySelector('div[style*="z-index: 10000"]');
      if (modal) {
        modal.remove();
      }
    }

    function markAllPaid() {
      const methods = ['Cash', 'Bank Transfer', 'GCash', 'PayMaya'];
      
      // Create modal dialog
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        text-align: center;
      `;
      
      dialog.innerHTML = `
        <div style="font-size: 20px; font-weight: bold; color: #1976D2; margin-bottom: 16px;">
          💳 Select Default Payment Method
        </div>
        <div style="color: #666; margin-bottom: 24px;">
          for All Players
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
          ${methods.map(method => `
            <button onclick="selectAllPaymentMethod('${method}')" style="
              padding: 16px;
              border: 2px solid #e0e0e0;
              border-radius: 12px;
              background: white;
              color: #333;
              font-size: 16px;
              font-weight: 500;
              cursor: pointer;
              transition: all 0.2s ease;
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 8px;
            " onmouseover="this.style.borderColor='#1976D2'; this.style.background='#f5f5f5'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
              <div style="font-size: 24px; ${method === 'GCash' ? 'color: #0066CC;' : method === 'PayMaya' ? 'color: #00A3E0;' : ''}">
                ${method === 'Cash' ? '💵' : method === 'Bank Transfer' ? '🏦' : method === 'GCash' ? '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="4" fill="#0066CC"/><path d="M7 8h10v8H7V8zm2 2v4h6v-4H9z" fill="white"/><circle cx="12" cy="12" r="1.5" fill="#0066CC"/></svg>' : '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="4" fill="#00A3E0"/><path d="M6 8h12v8H6V8zm2 2v4h8v-4H8z" fill="white"/><rect x="10" y="10" width="4" height="2" fill="#00A3E0"/></svg>'}
              </div>
              <div style="${method === 'GCash' ? 'color: #0066CC; font-weight: bold;' : method === 'PayMaya' ? 'color: #00A3E0; font-weight: bold;' : ''}">${method}</div>
            </button>
          `).join('')}
        </div>
        <button onclick="closePaymentDialog()" style="
          padding: 12px 24px;
          border: none;
          border-radius: 8px;
          background: #f5f5f5;
          color: #666;
          font-size: 16px;
          cursor: pointer;
          transition: background 0.2s ease;
        " onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='#f5f5f5'">
          Cancel
        </button>
      `;
      
      modal.appendChild(dialog);
      document.body.appendChild(modal);
    }

    function selectAllPaymentMethod(method) {
      players.forEach(player => {
        financeData.playersPaid.add(player.name);
        financeData.paymentMethods.set(player.name, method);
      });
      updatePlayerPaymentList();
      saveToStorage();
      closePaymentDialog();
    }

    function clearAllPayments() {
      financeData.playersPaid.clear();
      financeData.paymentMethods.clear();
      updatePlayerPaymentList();
      saveToStorage();
    }

    // Edit match winner
    function editMatchWinner(matchId) {
      const matchIndex = recentMatches.findIndex(m => m.id === matchId);
      if (matchIndex === -1) return;

      const match = recentMatches[matchIndex];
      const currentWinner = match.winningTeam;
      const newWinner = currentWinner === 1 ? 2 : 1;

      const confirmed = confirm(
        `🏸 EDIT MATCH RESULT\\n\\n` +
        `Do you want to change the winning team?\\n\\n` +
        `❌ REMOVE WIN FROM: Team ${currentWinner}\\n` +
        `   ${currentWinner === 1 ? match.match.team1.map(p => p.name).join(' & ') : match.match.team2.map(p => p.name).join(' & ')}\\n\\n` +
        `✅ GIVE WIN TO: Team ${newWinner}\\n` +
        `   ${newWinner === 1 ? match.match.team1.map(p => p.name).join(' & ') : match.match.team2.map(p => p.name).join(' & ')}\\n\\n` +
        `⚠️ This will update player statistics accordingly.\\n\\n` +
        `Click OK to confirm or Cancel to keep current result.`
      );

      if (confirmed) {
        // Update the match result
        const oldWinners = match.winners;
        const oldLosers = match.losers;

        match.winningTeam = newWinner;
        match.winners = newWinner === 1 ? match.match.team1 : match.match.team2;
        match.losers = newWinner === 1 ? match.match.team2 : match.match.team1;

        // Update player statistics
        oldWinners.forEach(player => {
          const playerInList = players.find(p => p.id === player.id);
          if (playerInList) {
            playerInList.stats.wins = Math.max(0, playerInList.stats.wins - 1);
            playerInList.stats.winRate = playerInList.stats.gamesPlayed > 0 ? 
              playerInList.stats.wins / playerInList.stats.gamesPlayed : 0;
          }
        });

        match.winners.forEach(player => {
          const playerInList = players.find(p => p.id === player.id);
          if (playerInList) {
            playerInList.stats.wins += 1;
            playerInList.stats.winRate = playerInList.stats.wins / playerInList.stats.gamesPlayed;
          }
        });

        updateRecentMatchesDisplay();
        updatePlayersDisplay();
        updateStatisticsDisplay();
        saveToStorage();

        console.log(`✏️ Match result edited: Team ${newWinner} now wins`);
      }
    }

    // Add event listeners for finance inputs
    function setupFinanceListeners() {
      const inputs = ['court-fee-per-hour', 'hours-played', 'number-of-courts', 'shuttlecock-price', 'shuttlecocks-used'];
      inputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', updateFinanceCalculations);
        }
      });
    }

    // Load custom logo function
    function loadCustomLogo() {
      const logoElement = document.getElementById('app-logo');
      if (!logoElement) {
        console.log('❌ Logo element not found');
        return;
      }
      
      // Try to load custom logo from images folder
      const customLogoPath = './images/logo.png';
      // Alternative paths to try if the first one fails
      const alternativePaths = [
        './images/logo.png',
        './images/logo.png.jpg',  // Try the actual filename
        'images/logo.png',
        'images/logo.png.jpg',    // Try the actual filename
        '../images/logo.png',
        '../images/logo.png.jpg', // Try the actual filename
        '../../images/logo.png',
        '../../../images/logo.png',
        '/images/logo.png',
        'SmashSyndicate/images/logo.png'
      ];
      console.log('🔍 Looking for logo at:', customLogoPath);
      console.log('📍 Current page URL:', window.location.href);
      console.log('📁 Current directory:', window.location.pathname);
      
      const img = new Image();
      
              img.onload = function() {
          // Custom logo found - replace emoji with image
          console.log('✅ Logo image loaded successfully');
          logoElement.innerHTML = '';
          // Clean logo display - no extra frame
          logoElement.style.background = 'transparent';
          logoElement.style.border = 'none';
          logoElement.style.padding = '0px';
          logoElement.style.boxShadow = 'none';
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'contain';
          img.style.borderRadius = '12px';
          logoElement.appendChild(img);
          console.log('✅ Custom logo applied successfully');
        };
      
      img.onerror = function() {
        // Try alternative paths
        console.log('❌ Logo image failed to load. Path tried:', customLogoPath);
        
        // Try alternative paths
        for (let i = 0; i < alternativePaths.length; i++) {
          const altPath = alternativePaths[i];
          if (altPath !== customLogoPath) {
            console.log('🔄 Trying alternative path:', altPath);
            const altImg = new Image();
            altImg.onload = function() {
              console.log('✅ Logo found at alternative path:', altPath);
              logoElement.innerHTML = '';
              // Clean logo display - no extra frame
              logoElement.style.background = 'transparent';
              logoElement.style.border = 'none';
              logoElement.style.padding = '0px';
              logoElement.style.boxShadow = 'none';
              altImg.style.width = '100%';
              altImg.style.height = '100%';
              altImg.style.objectFit = 'contain';
              altImg.style.borderRadius = '12px';
              logoElement.appendChild(altImg);
            };
            altImg.onerror = function() {
              console.log('❌ Alternative path also failed:', altPath);
            };
            altImg.src = altPath;
            return;
          }
        }
        
        // If all paths fail, keep default emoji
        logoElement.innerHTML = '🏸';
        console.log('💡 Make sure the images folder is in the same directory as the HTML file');
      };
      
      img.src = customLogoPath;
    }

    // Load custom navigation icons function
    function loadCustomNavIcons() {
      const iconMappings = [
        { id: 'nav-icon-players', filename: 'players-icon.png' },
        { id: 'nav-icon-courts', filename: 'courts-icon.png' },
        { id: 'nav-icon-queue', filename: 'queue-icon.png' },
        { id: 'nav-icon-stats', filename: 'stats-icon.png' },
        { id: 'nav-icon-finance', filename: 'finance-icon.png' }
      ];
      
      iconMappings.forEach(mapping => {
        const iconElement = document.getElementById(mapping.id);
        if (!iconElement) return;
        
        const img = new Image();
        img.onload = function() {
          iconElement.innerHTML = '';
          iconElement.appendChild(img);
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'contain';
          img.style.maxWidth = '40px';
          img.style.maxHeight = '40px';
        };
        img.onerror = function() {
          // Keep default emoji if custom icon not found
          console.log(`Custom icon not found: ${mapping.filename}`);
        };
        img.src = `./images/${mapping.filename}`;
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setupPWA();
      loadFromStorage();
      setupFinanceListeners();
      setupPlayerFormListeners();
      setupEditPlayerFormListeners();
      loadCustomLogo();
      
      // Initialize to home page
      switchTab('home');
      
      // Add event listeners for all navigation elements
      const normalQueueBtn = document.getElementById('normal-queue-btn');
      if (normalQueueBtn) {
        normalQueueBtn.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('Normal Queue Mode button clicked');
          switchTab('players');
        });
      }
      
      const tournamentBtn = document.getElementById('tournament-btn');
      if (tournamentBtn) {
        tournamentBtn.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('Tournament Mode button clicked');
          switchTab('tournament');
        });
      }
      
      // Add event listeners for navigation items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const tabName = item.getAttribute('data-tab');
          console.log('Navigation item clicked:', tabName);
          switchTab(tabName);
        });
      });
      
      // Add event listeners for bottom action buttons
      document.querySelectorAll('[data-tab]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const tabName = btn.getAttribute('data-tab');
          console.log('Action button clicked:', tabName);
          switchTab(tabName);
        });
      });
      
      console.log('All navigation event listeners added');
      
      console.log('🏸 Smash Syndicate Enhanced PWA loaded successfully!');
    });

    // Setup event listeners for player form validation
    function setupPlayerFormListeners() {
      const nameInput = document.getElementById('player-name');
      const namesTextarea = document.getElementById('player-names-bulk');
      
      if (nameInput) {
        nameInput.addEventListener('input', validatePlayerForm);
      }
      
      if (namesTextarea) {
        namesTextarea.addEventListener('input', validatePlayerForm);
      }
    }
    
    // Email feedback function
    function sendEmail() {
      const subject = encodeURIComponent('Smash Syndicate - Feedback/Bug Report');
      const body = encodeURIComponent(
        'Hi Ben,\n\n' +
        'I would like to provide feedback about Smash Syndicate:\n\n' +
        '[Please describe your feedback, suggestions, or bug report here]\n\n' +
        'Thank you!\n\n' +
        '---\n' +
        'Sent from Smash Syndicate PWA'
      );
      
      const mailtoLink = `mailto:benedictramosgarcia@gmail.com?subject=${subject}&body=${body}`;
      window.open(mailtoLink, '_blank');
    }
    

  </script>
</body>
</html>
